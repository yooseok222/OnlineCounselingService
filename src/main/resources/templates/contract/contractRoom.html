<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ìƒë‹´ë°©</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- CSRF í† í°ì„ ìœ„í•œ ë©”íƒ€ íƒœê·¸ ì¶”ê°€ -->
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<style>
  body {
    font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f8f9fa;
    color: #333;
  }
  
  .header {
    background-color: #0064E1;
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  
  .header h3 {
    margin: 0;
    font-size: 22px;
    font-weight: 600;
  }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }
  
  .toolbar {
    background-color: white;
    border-radius: 8px;
    padding: 10px 15px;
    margin-bottom: 15px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  
  .toolbar-group {
    display: flex;
    gap: 5px;
    align-items: center;
    border-right: 1px solid #eee;
    padding-right: 10px;
    margin-right: 5px;
  }
  
  .toolbar-group:last-child {
    border-right: none;
  }
  
  .tool-btn {
    background-color: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 8px 12px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 5px;
  }
  
  .tool-btn:hover {
    background-color: #e9ecef;
    border-color: #ced4da;
  }
  
  .tool-btn.active {
    background-color: #0064E1;
    color: white;
    border-color: #0064E1;
  }
  
  .tool-btn i {
    font-size: 16px;
  }
  
  .file-upload {
    position: relative;
    overflow: hidden;
    display: inline-block;
  }
  
  .file-upload input[type=file] {
    position: absolute;
    top: 0;
    right: 0;
    min-width: 100%;
    min-height: 100%;
    font-size: 100px;
    text-align: right;
    filter: alpha(opacity=0);
    opacity: 0;
    outline: none;
    cursor: pointer;
    display: block;
  }
  
  .status-area {
    background-color: #e3f0fd;
    border-radius: 8px;
    padding: 10px 15px;
    margin-bottom: 15px;
    font-weight: 500;
    color: #0064E1;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  #scrollWrapper {
    background-color: white;
    border-radius: 8px;
    padding: 15px;
    position: relative;
    height: 700px;
    overflow-y: scroll;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  }
  
  #pdfCanvas {
    border: none;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  
  #drawingCanvas {
    border: none;
    position: absolute;
    top: 15px;
    left: 15px;
  }
  
  #textPopup {
    display: none;
    position: fixed;
    top: 30%;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    z-index: 1000;
    width: 300px;
  }
  
  #textPopup input {
    width: 100%;
    padding: 8px;
    margin: 10px 0;
    border: 1px solid #ddd;
    border-radius: 4px;
  }
  
  #textPopup button {
    padding: 8px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-right: 5px;
  }
  
  #textPopup button:first-of-type {
    background-color: #0064E1;
    color: white;
  }
  
  #textPopup button:last-of-type {
    background-color: #f1f3f5;
    color: #495057;
  }
  
  #completeModal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    z-index: 10000;
    width: 400px;
    text-align: center;
    border: 3px solid #0064E1;
  }
  
  #completeModal h3 {
    margin-top: 0;
    color: #0064E1;
  }
  
  #completeModal button {
    background-color: #0064E1;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    cursor: pointer;
    margin-top: 15px;
    transition: background-color 0.2s;
  }
  
  #completeModal button:hover {
    background-color: #0053b3;
  }
  
  /* í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
  #toastContainer {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
  }
  
  .toast {
    background-color: #0064E1;
    color: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    display: flex;
    justify-content: space-between;
    align-items: center;
    min-width: 300px;
    max-width: 400px;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.3s ease-in-out;
  }
  
  .toast.show {
    opacity: 1;
    transform: translateX(0);
  }
  
  .toast-icon {
    font-size: 24px;
    margin-right: 10px;
  }
  
  .toast-content {
    flex-grow: 1;
  }
  
  .toast-title {
    font-weight: bold;
    margin-bottom: 5px;
  }
  
  .toast-message {
    font-size: 14px;
  }
  
  .toast-close {
    cursor: pointer;
    font-size: 18px;
    margin-left: 10px;
  }
  
  .end-consult-btn {
    background-color: #0064E1;
    color: white;
  }
  
  .end-consult-btn:hover {
    background-color: #0053b3;
    border-color: #0053b3;
  }
  
  @media (max-width: 768px) {
    .toolbar {
      flex-direction: column;
    }
    
    .toolbar-group {
      border-right: none;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
      margin-bottom: 10px;
    }
    
    #scrollWrapper {
      height: 500px;
    }
  }
</style>
  </head>
<body>
<div class="header">
  <h3><i class="fas fa-file-pdf"></i> PDF ìƒë‹´ë°©</h3>
  <div class="user-info">
    <span id="userRoleDisplay"></span>
  </div>
</div>

<div class="container">
  <div class="toolbar">
    <div class="toolbar-group">
      <div class="file-upload tool-btn">
        <i class="fas fa-upload"></i> PDF ì—…ë¡œë“œ
        <input type="file" id="pdfUpload" accept=".pdf" />
      </div>
    </div>
    
    <div class="toolbar-group">
      <button class="tool-btn" onclick="prevPage()"><i class="fas fa-arrow-left"></i> ì´ì „</button>
      <button class="tool-btn" onclick="nextPage()"><i class="fas fa-arrow-right"></i> ë‹¤ìŒ</button>
    </div>
    
    <div class="toolbar-group">
      <button class="tool-btn" id="highlighterBtn" onclick="setHighlighter()"><i class="fas fa-highlighter"></i> í˜•ê´‘íœ</button>
      <button class="tool-btn" id="penBtn" onclick="setPen()"><i class="fas fa-pen"></i> íœ</button>
      <button class="tool-btn" id="cursorBtn" onclick="setCursor()"><i class="fas fa-mouse-pointer"></i> ì»¤ì„œ</button>
      <button class="tool-btn" id="textBtn" onclick="openTextPopup()"><i class="fas fa-font"></i> í…ìŠ¤íŠ¸</button>
      <button class="tool-btn" id="stampBtn" onclick="setStampMode()" style="display: none;"><i class="fas fa-stamp"></i> ë„ì¥</button>
    </div>
    
    <div class="toolbar-group">
      <button class="tool-btn end-consult-btn" onclick="endConsult()"><i class="fas fa-sign-out-alt"></i> ìƒë‹´ ì¢…ë£Œ</button>
    </div>
  </div>

  <div class="status-area">
    <i class="fas fa-info-circle"></i>
    í˜„ì¬ ëª¨ë“œ: <span id="currentMode">ì»¤ì„œ</span>
  </div>

  <!-- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ -->
  <div id="toastContainer"></div>

  <!-- ìƒë‹´ ì™„ë£Œ í›„ í™ˆìœ¼ë¡œ ì´ë™ ëª¨ë‹¬ -->
  <div id="completeModal">
    <i class="fas fa-check-circle" style="font-size: 48px; color: #0064E1; margin-bottom: 15px;"></i>
    <h3>ìƒë‹´ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</h3>
    <div>ìƒë‹´ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì´ˆê¸° í™”ë©´ìœ¼ë¡œ ì´ë™í•˜ì„¸ìš”.</div>
    <button onclick="goToHomePage()" style="margin-top: 20px; font-size: 16px; padding: 10px 20px;"><i class="fas fa-home"></i> ì´ˆê¸° í™”ë©´ìœ¼ë¡œ ì´ë™</button>
  </div>

  <div id="scrollWrapper">
    <canvas id="pdfCanvas"></canvas>
    <canvas id="drawingCanvas"></canvas>
  </div>

  <div id="textPopup">
    <h4><i class="fas fa-font"></i> í…ìŠ¤íŠ¸ ì‚½ì…</h4>
    <label>ì‚½ì…í•  í…ìŠ¤íŠ¸:</label>
    <input type="text" id="textInput" placeholder="í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
    <div style="text-align: right; margin-top: 15px;">
      <button onclick="confirmText()">í™•ì¸</button>
      <button onclick="closeTextPopup()">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<script>
let drawingDataPerPage = {};
let stampDataPerPage = {};
let textDataPerPage = {};
let signatureDataPerPage = {};

let pdfDoc = null;
let currentPage = 1;
let renderTask = null;
let stompClient = null;
let mode = null; // 'pen' | 'highlight' | null
let drawing = false;
let pendingText = null;
let uploadedPdfUrl = null;
let userRole = null; // 'agent' | 'client'
let sessionId = null; // ìƒë‹´ ì„¸ì…˜ ID ì¶”ê°€

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ì—­í•  í™•ì¸ ë° UI ì´ˆê¸°í™”
window.onload = function() {
  console.log("ìœˆë„ìš° ë¡œë“œë¨ - ì´ˆê¸°í™” ì‹œì‘");
  
  // ìƒˆë¡œê³ ì¹¨ ë°©ì§€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ - ìµœìƒìœ„ ìš°ì„ ìˆœìœ„ë¡œ ì„¤ì •
  const preventRefreshHandler = function(e) {
    // ë¸Œë¼ìš°ì €ë§ˆë‹¤ í‘œì‹œë˜ëŠ” ë©”ì‹œì§€ê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ
    var confirmationMessage = 'ìƒë‹´ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ë– ë‚˜ë©´ ìƒë‹´ì´ ì¢…ë£Œë©ë‹ˆë‹¤. ì •ë§ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?';
    
    e.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë°©ì§€ (ì¼ë¶€ ë¸Œë¼ìš°ì €ì—ì„œ íš¨ê³¼)
    e.returnValue = confirmationMessage;  // í‘œì¤€
    return confirmationMessage;           // ì¼ë¶€ ë¸Œë¼ìš°ì €ìš©
  };
  
  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (ìº¡ì²˜ ë‹¨ê³„ì—ì„œ ì‹¤í–‰)
  window.addEventListener('beforeunload', preventRefreshHandler, true);
  
  // ê¸€ë¡œë²Œ ì´ˆê¸°í™” í”Œë˜ê·¸ ì„¤ì • (ìµœì´ˆ 1íšŒë§Œ ì‹¤í–‰ë˜ëŠ” ë¡œì§ ì œì–´ìš©)
  window.isInitialLoad = true;
  window.dataLoaded = false;
  
  // URLì—ì„œ ì—­í•  íŒŒë¼ë¯¸í„° í™•ì¸
  const urlParams = new URLSearchParams(window.location.search);
  const roleParam = urlParams.get('role');
  const sessionParam = urlParams.get('session'); // ì„¸ì…˜ ID íŒŒë¼ë¯¸í„° í™•ì¸
  
  // URL íŒŒë¼ë¯¸í„°ì— ì—­í• ì´ ìˆìœ¼ë©´ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
  if (roleParam) {
    sessionStorage.setItem("role", roleParam);
  }
  
  // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì—­í•  ì •ë³´ ê°€ì ¸ì˜¤ê¸°
  userRole = sessionStorage.getItem("role");
  console.log("ì‚¬ìš©ì ì—­í• :", userRole);
  
  // ì‚¬ìš©ì ì—­í•  í‘œì‹œ
  const userRoleDisplay = document.getElementById('userRoleDisplay');
  if (userRoleDisplay) {
    const roleName = userRole === 'agent' ? 'ìƒë‹´ì›' : 'ê³ ê°';
  const roleIcon = userRole === 'agent' ? '<i class="fas fa-headset"></i>' : '<i class="fas fa-user"></i>';
    userRoleDisplay.innerHTML = `${roleIcon} ${roleName}`;
  }

  // ì„¸ì…˜ ID ì„¤ì • (URLì—ì„œ ê°€ì ¸ì˜¤ê±°ë‚˜ ìƒˆë¡œ ìƒì„±)
  if (sessionParam) {
    sessionId = sessionParam;
    sessionStorage.setItem("sessionId", sessionId);
    console.log("URLì—ì„œ ì„¸ì…˜ ID ë¡œë“œ:", sessionId);
  } else if (sessionStorage.getItem("sessionId")) {
    // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ëœ ì„¸ì…˜ IDê°€ ìˆìœ¼ë©´ ì‚¬ìš©
    sessionId = sessionStorage.getItem("sessionId");
    console.log("ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì„¸ì…˜ ID ë¡œë“œ:", sessionId);
    
    // URL ì—…ë°ì´íŠ¸
    const url = new URL(window.location.href);
    url.searchParams.set('session', sessionId);
    window.history.replaceState({}, '', url);
  } else if (userRole === "agent") {
    // ìƒë‹´ì›ì¸ ê²½ìš°ì—ë§Œ ìƒˆ ì„¸ì…˜ ID ìƒì„±
    sessionId = generateSessionId();
    console.log("ìƒˆ ì„¸ì…˜ ID ìƒì„±:", sessionId);
    // URLì— ì„¸ì…˜ ID ì¶”ê°€ (í˜ì´ì§€ ì´ë™ ì—†ì´ URL ì—…ë°ì´íŠ¸)
    const url = new URL(window.location.href);
    url.searchParams.set('session', sessionId);
    window.history.replaceState({}, '', url);
    // ì„¸ì…˜ IDë¥¼ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
    sessionStorage.setItem("sessionId", sessionId);
  }
  
  // ì„¸ì…˜ ID í™•ì¸
  if (sessionId) {
    console.log("ì„¸ì…˜ ID ì„¤ì •ë¨:", sessionId);
    
    // ìƒˆë¡œê³ ì¹¨ ì‹œ ì´ì „ í˜ì´ì§€ ë²ˆí˜¸ë¥¼ ë³µì›í•˜ê¸° ìœ„í•´ ì €ì¥
    if (sessionStorage.getItem("lastPage")) {
      currentPage = parseInt(sessionStorage.getItem("lastPage")) || 1;
      console.log("ì €ì¥ëœ í˜ì´ì§€ ë²ˆí˜¸ ë³µì›:", currentPage);
    }
  } else {
    // ê³ ê°ì´ë©´ì„œ ì„¸ì…˜ IDê°€ ì—†ëŠ” ê²½ìš° ì˜¤ë¥˜ ì²˜ë¦¬
    if (userRole === "client") {
      alert("ìœ íš¨í•œ ìƒë‹´ ì„¸ì…˜ì´ ì•„ë‹™ë‹ˆë‹¤. ì´ˆê¸° í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
      location.href = "/";
      return;
    }
  }
  
  // ì—­í• ì— ë”°ë¼ UI ì´ˆê¸°í™”
  initializeUIByRole();
  
  // ìƒë‹´ì›ì´ ìƒë‹´ì‹¤ì— ì…ì¥í•˜ë©´ ì…ì¥ ìƒíƒœë¥¼ ìë™ìœ¼ë¡œ ì„¤ì •
  if (userRole === "agent") {
    // ìƒë‹´ì› ì…ì¥ ìƒíƒœ ë³€ê²½
    updateAgentStatus(true);
    
    // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
    setTimeout(() => {
      showToast("ìƒë‹´ ì‹œì‘", "ê³ ê°ì´ ìƒë‹´ì‹¤ë¡œ ì…ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", "info");
    }, 1000); // 1ì´ˆ í›„ í‘œì‹œ
  }
  
  // ê³ ê°ì¸ ê²½ìš°ì—ëŠ” ìƒë‹´ì› ìƒíƒœ í™•ì¸ í›„ í™œì„±í™”ë˜ì–´ ìˆì§€ ì•Šìœ¼ë©´ ëŒ€ê¸°ì‹¤ë¡œ ì´ë™
  if (userRole === "client") {
    fetch('/api/contract/status')
      .then(response => response.json())
      .then(data => {
        if (!data.present) {
          // ìƒë‹´ì›ì´ ì…ì¥í•´ ìˆì§€ ì•Šìœ¼ë©´ ëŒ€ê¸°ì‹¤ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
          console.warn("ìƒë‹´ì›ì´ ì•„ì§ ì…ì¥í•˜ì§€ ì•ŠìŒ. ëŒ€ê¸°ì‹¤ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
          location.href = "/waiting-room";
        } else {
          console.log("ìƒë‹´ì›ì´ ì…ì¥í•´ ìˆìŠµë‹ˆë‹¤.");
        }
      })
      .catch(error => {
        console.error("ìƒë‹´ì› ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:", error);
      });
  }
  
  // ì„¸ì…˜ IDê°€ ìˆìœ¼ë©´ ì„œë²„ì—ì„œ ë°ì´í„° ë¡œë“œ
  if (sessionId) {
    console.log("ì„¸ì…˜ ë°ì´í„° ë¡œë“œ ì‹œë„:", sessionId);
    
    // íƒ€ì„ì•„ì›ƒ ì¶”ê°€ (ëª¨ë“  ê²ƒì´ ì¤€ë¹„ëœ í›„ ë°ì´í„° ë¡œë“œ)
    setTimeout(() => {
      // ì¤‘ìš”: ìƒˆë¡œê³ ì¹¨ ë³µì› ì²˜ë¦¬
      console.log("ì„¸ì…˜ ë°ì´í„° ë¡œë“œ ì‹œì‘ - ê°•ì œ ë³µì› ëª¨ë“œ");
      loadSessionData(true); // ê°•ì œ ë³µì› ëª¨ë“œ
    }, 500);
  }
  
  // ì²˜ìŒì— ì»¤ì„œ ë²„íŠ¼ì„ í™œì„±í™” ìƒíƒœë¡œ ì„¤ì •
  document.getElementById('cursorBtn').classList.add('active');
  
  // WebSocket ì—°ê²° ìƒíƒœ í™•ì¸ ë° ì¬ì—°ê²° ë©”ì»¤ë‹ˆì¦˜
  checkAndReconnectWebSocket();
};

// ì„¸ì…˜ ID ìƒì„± í•¨ìˆ˜
function generateSessionId() {
  return 'session_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
}

// ì—­í• ì— ë”°ë¥¸ UI ì´ˆê¸°í™”
function initializeUIByRole() {
  if (userRole === "agent") {
    // ìƒë‹´ì›ì¸ ê²½ìš° ë„ì¥ ë²„íŠ¼ ìˆ¨ê¹€
    document.getElementById("stampBtn").style.display = "none";
    
    // ìƒë‹´ì›ìš© UI í‘œì‹œ
    document.querySelector('.file-upload').style.display = "inline-flex";
    document.querySelector('.end-consult-btn').style.display = "inline-flex";
  } else {
    // ê³ ê°ì¸ ê²½ìš° UI ì œí•œ
    document.querySelector('.file-upload').style.display = "none";
    document.querySelector('.end-consult-btn').style.display = "none";
    
    // entryType í™•ì¸
    const entryType = sessionStorage.getItem("entryType");
    
    // ê³ ê°ì´ ë„ì¥ìœ¼ë¡œ ì…ì¥í•œ ê²½ìš° ë„ì¥ ë²„íŠ¼ í‘œì‹œ, ì•„ë‹ˆë©´ ìˆ¨ê¹€
    if (entryType === "stamp") {
      document.getElementById("stampBtn").style.display = "inline-flex";
    } else if (entryType === "signature") {
      document.getElementById("stampBtn").style.display = "none";
      
      // ì„œëª… ë²„íŠ¼ ì¶”ê°€
      const signatureBtn = document.createElement("button");
      signatureBtn.id = "signatureBtn";
      signatureBtn.className = "tool-btn";
      signatureBtn.innerHTML = '<i class="fas fa-signature"></i> ì„œëª…';
      signatureBtn.onclick = setSignatureMode;
      
      // í…ìŠ¤íŠ¸ ë²„íŠ¼ ë‹¤ìŒì— ì„œëª… ë²„íŠ¼ ì¶”ê°€
      const textBtn = document.getElementById("textBtn");
      const toolbarGroup = textBtn.parentNode;
      toolbarGroup.insertBefore(signatureBtn, textBtn.nextSibling);
    } else {
      document.getElementById("stampBtn").style.display = "none";
    }
  }
}

// ìƒë‹´ì› ì…ì¥ ìƒíƒœ ì„¤ì •
function updateAgentStatus(present) {
  fetch('/api/contract/status', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ 
      present: present,
      sessionId: sessionId
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      console.log("ìƒë‹´ì› ì…ì¥ ìƒíƒœ ì—…ë°ì´íŠ¸:", present);
    }
  })
  .catch(error => {
    console.error("ìƒë‹´ì› ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", error);
  });
}

// ì •ê¸°ì ìœ¼ë¡œ ì„¸ì…˜ ë°ì´í„° ì €ì¥
function startAutoSave() {
  console.log("ìë™ ì €ì¥ ì‹œì‘...");
  
  // ì´ˆê¸° ì €ì¥ ìˆ˜í–‰ (1íšŒ)
  saveSessionData();
  
  // 10ì´ˆë§ˆë‹¤ ì„¸ì…˜ ë°ì´í„° ì €ì¥ (ë” ë¹ˆë²ˆí•˜ê²Œ ì €ì¥)
  setInterval(saveSessionData, 10000);
}

// ì„œë²„ì— ì„¸ì…˜ ë°ì´í„° ì €ì¥ í•¨ìˆ˜
function saveSessionData() {
  if (!sessionId) return;
  console.log("ì„¸ì…˜ ë°ì´í„° ì €ì¥ ì‹œë„...");
  
  // ì €ì¥ ì „ í˜„ì¬ í˜ì´ì§€ ì •ë³´ê°€ ìœ íš¨í•œì§€ í™•ì¸
  if (!currentPage || currentPage < 1) {
    console.error("í˜„ì¬ í˜ì´ì§€ ì •ë³´ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŒ:", currentPage);
    currentPage = 1; // í˜ì´ì§€ ì •ë³´ê°€ ì˜ëª»ëœ ê²½ìš° ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
  }
  
  const sessionData = {
    pdfUrl: uploadedPdfUrl,
    drawingData: drawingDataPerPage,
    stampData: stampDataPerPage,
    signatureData: signatureDataPerPage,
    textData: textDataPerPage,
    currentPage: currentPage  // í˜„ì¬ í˜ì´ì§€ ì •ë³´ ì¶”ê°€
  };
  
  fetch(`/api/contract-data/${sessionId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(sessionData)
  })
  .then(response => response.json())
  .then(data => {
    console.log("ì„¸ì…˜ ë°ì´í„° ì €ì¥ ê²°ê³¼:", data);
  })
  .catch(error => {
    console.error("ì„¸ì…˜ ë°ì´í„° ì €ì¥ ì˜¤ë¥˜:", error);
  });
}

// ì„œë²„ì—ì„œ ì„¸ì…˜ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ (ê°•í™”ëœ ë²„ì „)
function loadSessionData(forceRestore = false) {
  if (!sessionId) {
    console.error("ì„¸ì…˜ IDê°€ ì—†ì–´ ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  
  // ì´ë¯¸ ë°ì´í„°ë¥¼ ë¡œë“œí•œ ê²½ìš° ì¤‘ë³µ ë¡œë“œ ë°©ì§€ (ê°•ì œ ë³µì› ì˜µì…˜ì´ ì•„ë‹Œ ê²½ìš°)
  if (window.dataLoaded && !forceRestore) {
    console.log("ì´ë¯¸ ë°ì´í„°ê°€ ë¡œë“œë˜ì–´ ìˆì–´ ì¤‘ë³µ ë¡œë“œë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.");
    return;
  }
  
  console.log(`ì„¸ì…˜ ë°ì´í„° ë¡œë“œ ì‹œì‘ (ê°•ì œ ë³µì›: ${forceRestore})...`);
  showToast("ë³µì› ì¤‘", "ì„¸ì…˜ ë°ì´í„°ë¥¼ ë³µì› ì¤‘ì…ë‹ˆë‹¤...", "info");
  
  fetch(`/api/contract-data/${sessionId}`)
    .then(response => response.json())
    .then(data => {
      if (data.success === false) {
        console.log("ì„¸ì…˜ ë°ì´í„° ì—†ìŒ:", data.message);
        
        // ê³ ê°ì¸ ê²½ìš° ìƒë‹´ì›ì—ê²Œ PDF ìš”ì²­
        if (userRole === "client") {
          console.log("ê³ ê°ì´ ì²˜ìŒ ì…ì¥: ìƒë‹´ì›ì—ê²Œ PDF ìš”ì²­");
          requestPdfFromAgent();
        }
        return;
      }
      
      console.log("ì„¸ì…˜ ë°ì´í„° ë¡œë“œë¨:", data);
      window.dataLoaded = true;
      
      try {
        // ì €ì¥ëœ í˜ì´ì§€ ì •ë³´ ë³€ìˆ˜
        let savedPageNumber = 1;
        
        // ë¨¼ì € ë°ì´í„°ë¥¼ ëª¨ë‘ ì„¤ì • (í˜ì´ì§€ ë Œë”ë§ ì´ì „)
        
        // ê·¸ë¦¼ ë°ì´í„° ë³µì›
        if (data.drawingData && Object.keys(data.drawingData).length > 0) {
          console.log("ê·¸ë¦¼ ë°ì´í„° ì„¤ì •:", Object.keys(data.drawingData).length + "ê°œ í˜ì´ì§€");
          drawingDataPerPage = JSON.parse(JSON.stringify(data.drawingData));
        }
        
        // ë„ì¥ ë°ì´í„° ë³µì›
        if (data.stampData && Object.keys(data.stampData).length > 0) {
          console.log("ë„ì¥ ë°ì´í„° ì„¤ì •:", Object.keys(data.stampData).length + "ê°œ í˜ì´ì§€");
          stampDataPerPage = JSON.parse(JSON.stringify(data.stampData));
        }
        
        // ì„œëª… ë°ì´í„° ë³µì›
        if (data.signatureData && Object.keys(data.signatureData).length > 0) {
          console.log("ì„œëª… ë°ì´í„° ì„¤ì •:", Object.keys(data.signatureData).length + "ê°œ í˜ì´ì§€");
          signatureDataPerPage = JSON.parse(JSON.stringify(data.signatureData));
        }
        
        // í…ìŠ¤íŠ¸ ë°ì´í„° ë³µì›
        if (data.textData && Object.keys(data.textData).length > 0) {
          console.log("í…ìŠ¤íŠ¸ ë°ì´í„° ì„¤ì •:", Object.keys(data.textData).length + "ê°œ í˜ì´ì§€");
          textDataPerPage = JSON.parse(JSON.stringify(data.textData));
        }
        
        // ì €ì¥ëœ í˜ì´ì§€ ë²ˆí˜¸ í™•ì¸
        if (data.currentPage && data.currentPage > 0) {
          savedPageNumber = data.currentPage;
          // í˜„ì¬ í˜ì´ì§€ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (ì „ì—­ ë³€ìˆ˜)
          currentPage = savedPageNumber;
          // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ë„ ì €ì¥ (ìƒˆë¡œê³ ì¹¨ ëŒ€ë¹„)
          sessionStorage.setItem("lastPage", savedPageNumber);
          console.log("ì €ì¥ëœ í˜ì´ì§€ ë²ˆí˜¸ë¡œ ë³µì›:", savedPageNumber);
        }
        
        // PDF URL ë³µì›
        if (data.pdfUrl) {
          console.log("PDF URL ë³µì›:", data.pdfUrl);
          uploadedPdfUrl = data.pdfUrl;
          
          // PDF ë¡œë“œ (ëª¨ë“  ë°ì´í„°ê°€ ì„¤ì •ëœ í›„)
          loadPdfFromUrl(data.pdfUrl, function() {
            // PDF ë¡œë“œ ì™„ë£Œ í›„ ì €ì¥ëœ í˜ì´ì§€ë¡œ ì´ë™
            if (savedPageNumber > 1 && savedPageNumber <= pdfDoc.numPages) {
              console.log("ì €ì¥ëœ í˜ì´ì§€ë¡œ ì´ë™:", savedPageNumber);
              setTimeout(() => {
                // ëª…ì‹œì ìœ¼ë¡œ ì§€ì •ëœ í˜ì´ì§€ ë Œë”ë§
                renderPage(savedPageNumber, function() {
                  // WebSocketì„ í†µí•´ í˜ì´ì§€ ë™ê¸°í™” (ìƒë‹´ì›ë§Œ)
                  if (userRole === "agent") {
                    sendPageSync(savedPageNumber);
                  }
                  updateModeStatus(`í˜ì´ì§€ ${savedPageNumber} í‘œì‹œ ì¤‘`);
                  
                  // ì„¸ì…˜ ë°ì´í„° ë³µì› ì •ë³´ ì €ì¥
                  showToast("ì„¸ì…˜ ë³µì› ì™„ë£Œ", "PDF ë¬¸ì„œì™€ í˜ì´ì§€ê°€ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
                });
              }, 500);
            } else {
              renderPage(1, function() {
                // í˜ì´ì§€ ì •ë³´ê°€ ì—†ê±°ë‚˜, ë²”ìœ„ ì™¸ì¸ ê²½ìš° ê¸°ë³¸ í† ìŠ¤íŠ¸ ë©”ì‹œì§€ë§Œ í‘œì‹œ
                showToast("PDF ë¡œë“œ ì™„ë£Œ", "PDF ë¬¸ì„œê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
              });
            }
            
            // í•œ ë²ˆ ë” í˜ì´ì§€ ê·¸ë¦¬ê¸° ì‹œë„ (ì§€ì—° ì‹œë„)
            setTimeout(() => {
              if (drawingDataPerPage[currentPage] || 
                  stampDataPerPage[currentPage] || 
                  signatureDataPerPage[currentPage] || 
                  textDataPerPage[currentPage]) {
                console.log("ì§€ì—° ê·¸ë¦¬ê¸° ì‹œë„: í˜ì´ì§€", currentPage);
                renderPage(currentPage);
              }
            }, 2000);
          });
        } else if (userRole === "client") {
          // PDF URLì´ ì—†ëŠ” ê²½ìš° (ê³ ê°ì¸ ê²½ìš°) ìƒë‹´ì›ì—ê²Œ PDF ìš”ì²­
          console.log("ì„¸ì…˜ì— PDF URLì´ ì—†ìŒ: ìƒë‹´ì›ì—ê²Œ PDF ìš”ì²­");
          requestPdfFromAgent();
        }
      } catch (err) {
        console.error("ì„¸ì…˜ ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", err);
        showToast("ë°ì´í„° ì²˜ë¦¬ ì˜¤ë¥˜", "ì„¸ì…˜ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
        
        // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ PDF ìš”ì²­ ì‹œë„
        if (userRole === "client") {
          setTimeout(requestPdfFromAgent, 2000);
        }
      }
    })
    .catch(error => {
      console.error("ì„¸ì…˜ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", error);
      showToast("ë³µì› ì‹¤íŒ¨", "ì„¸ì…˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
      
      // ì‹¤íŒ¨ ì‹œ PDF ìš”ì²­ ì‹œë„
      if (userRole === "client") {
        setTimeout(requestPdfFromAgent, 2000);
      }
    });
}

const canvas = document.getElementById("pdfCanvas");
const ctx = canvas.getContext("2d");
const drawingCanvas = document.getElementById("drawingCanvas");
const drawCtx = drawingCanvas.getContext("2d");

// ì¢Œí‘œ ìƒíƒœ (ë¡œì»¬)
let localLastX = null;
let localLastY = null;

// ì¢Œí‘œ ìƒíƒœ (WebSocket)
let wsLastX = null;
let wsLastY = null;

document.getElementById("pdfUpload").addEventListener("change", function (e) {
  const file = e.target.files[0];
  const formData = new FormData();
  formData.append("file", file);

  // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
  const token = document.querySelector("meta[name='_csrf']").getAttribute("content");
  const header = document.querySelector("meta[name='_csrf_header']").getAttribute("content");

  fetch("/upload", {
    method: "POST",
    body: formData,
    headers: {
      [header]: token
    }
  })
          .then(res => res.text())
          .then(url => {
            // íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€í•˜ì—¬ ìºì‹œ ë°©ì§€
            const timestamp = new Date().getTime();
            const timestampedUrl = url.includes('?') ? 
              url + '&t=' + timestamp : 
              url + '?t=' + timestamp;
              
            console.log("PDF ì—…ë¡œë“œ ì„±ê³µ, íƒ€ì„ìŠ¤íƒ¬í”„ URL:", timestampedUrl);
            
            // ê¸°ì¡´ PDF ê°ì²´ ì •ë¦¬
            if (pdfDoc) {
              try {
                pdfDoc.destroy();
                pdfDoc = null;
              } catch (e) {
                console.warn("PDF ê°ì²´ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜:", e);
              }
            }
            
            // ìƒˆ URL ì €ì¥ ë° PDF ë¡œë“œ
            uploadedPdfUrl = timestampedUrl;
            loadPdfFromUrl(timestampedUrl);
            sendPdfPathSync(timestampedUrl);
          })
          .catch(error => {
            console.error("PDF ì—…ë¡œë“œ ì˜¤ë¥˜:", error);
            showToast("ì—…ë¡œë“œ ì‹¤íŒ¨", "PDF ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
          });
});

function loadPdfFromUrl(url, callback) {
  if (!url) {
    console.error("PDF URLì´ ì—†ìŠµë‹ˆë‹¤.");
    if (userRole === "client") {
      console.log("ê³ ê° ì…ì¥: PDF ìë™ ìš”ì²­");
      requestPdfFromAgent();
    }
    return;
  }
  
  // í•­ìƒ ìƒˆë¡œ ë¡œë“œ (ìºì‹œ ë°©ì§€)
  console.log("PDF ë¡œë“œ ì‹œì‘:", url);
  
  // ê¸°ì¡´ PDF ê°ì²´ ì •ë¦¬
  if (pdfDoc) {
    try {
      console.log("ê¸°ì¡´ PDF ê°ì²´ ì •ë¦¬ ì¤‘...");
      pdfDoc.destroy();
      pdfDoc = null;
    } catch (e) {
      console.warn("PDF ê°ì²´ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜:", e);
    }
  }
  
  // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
  showToast("PDF ë¡œë“œ ì¤‘", "PDF ë¬¸ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...", "info");
  
  // ëª…ì‹œì ìœ¼ë¡œ URL ì €ì¥
  uploadedPdfUrl = url;
  
  const loadingTask = pdfjsLib.getDocument(url);
  loadingTask.promise.then(pdf => {
    console.log("PDF ë¡œë“œ ì„±ê³µ:", pdf.numPages + "í˜ì´ì§€");
    
    pdfDoc = pdf;
    
    // ì„¸ì…˜ ë°ì´í„° ì €ì¥ (PDF ë¡œë“œ ì„±ê³µ ì‹œ)
    if (sessionId) {
      setTimeout(saveSessionData, 500);
    }
    
    // í˜ì´ì§€ ë²ˆí˜¸ ì²´í¬
    const hasHistory = sessionStorage.getItem("lastPage") !== null;
    
    // ì„¸ì…˜ì—ì„œ ì €ì¥ëœ í˜ì´ì§€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    fetchSavedPageNumber(function(savedPage) {
      if (hasHistory && savedPage > 0 && savedPage <= pdf.numPages) {
        // ê¸°ì¡´ ì„¸ì…˜ì´ ìˆëŠ” ê²½ìš° (ìƒˆë¡œê³ ì¹¨ì´ë‚˜ ì¼ì‹œì  ì—°ê²° ëŠê¹€ í›„ ë³µê·€)
        currentPage = savedPage;
      } else {
        // ìƒˆë¡œìš´ ì„¸ì…˜ ì‹œì‘ - í•­ìƒ 1í˜ì´ì§€ë¡œ ì‹œì‘
        currentPage = 1;
        // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— í˜ì´ì§€ ì •ë³´ ì €ì¥
        sessionStorage.setItem("lastPage", 1);
      }
      
      // í˜ì´ì§€ ë Œë”ë§
      renderPage(currentPage, callback);
      
      // í•­ìƒ ë¡œë“œ ì™„ë£Œ ë©”ì‹œì§€ í‘œì‹œ (ìµœì´ˆ ë¡œë“œ ì²´í¬ ì œê±°)
      showToast("PDF ë¡œë“œ ì™„ë£Œ", "PDF ë¬¸ì„œê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
    });
  }).catch(error => {
    console.error("PDF ë¡œë“œ ì˜¤ë¥˜:", error);
    showToast("PDF ë¡œë“œ ì‹¤íŒ¨", "PDF íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤.", "error");
    
    // PDF ë¡œë“œ ì‹¤íŒ¨ ì‹œ ê³ ê°ì€ ë‹¤ì‹œ ìš”ì²­
    if (userRole === "client") {
      setTimeout(requestPdfFromAgent, 3000);
    }
  });
}

async function renderPage(pageNumber, callback) {
  console.log(`í˜ì´ì§€ ${pageNumber} ë Œë”ë§ ì‹œì‘...`);
  
  // í˜„ì¬ í˜ì´ì§€ì˜ ì„œëª… ë°ì´í„° í™•ì¸
  const signatures = signatureDataPerPage[pageNumber] || [];
  console.log(`í˜„ì¬ í˜ì´ì§€ ${pageNumber}ì˜ ì„œëª… ë°ì´í„°: ${signatures.length}ê°œ`);
  
  if (renderTask) {
    try {
      console.log("ì´ì „ ë Œë”ë§ ì‘ì—… ì·¨ì†Œ ì¤‘...");
      await renderTask.cancel(); // ê¸°ë‹¤ë ¤ì£¼ê¸°
    } catch (e) {
      console.warn("Render task cancel error:", e);
    }
  }

  // ëª¨ë“  ë°ì´í„°ë¥¼ ë°±ì—… (ê¹Šì€ ë³µì‚¬ë¡œ)
  console.log("í˜ì´ì§€ ë°ì´í„° ë°±ì—… ì¤‘...");
  try {
    const backupDrawingData = JSON.stringify(drawingDataPerPage);
    const backupStampData = JSON.stringify(stampDataPerPage);
    const backupSignatureData = JSON.stringify(signatureDataPerPage);
    const backupTextData = JSON.stringify(textDataPerPage);
    
    try {
      const page = await pdfDoc.getPage(pageNumber);
      const viewport = page.getViewport({ scale: 1.5 });

      canvas.height = viewport.height;
      canvas.width = viewport.width;

      const renderContext = {
        canvasContext: ctx,
        viewport: viewport
      };

      console.log("PDF í˜ì´ì§€ ë Œë”ë§ ì‹œì‘...");
      renderTask = page.render(renderContext);

      await renderTask.promise;
      console.log("PDF í˜ì´ì§€ ë Œë”ë§ ì™„ë£Œ");
      
        renderTask = null;
      console.log("ìº”ë²„ìŠ¤ ë¦¬ì‚¬ì´ì§• ë° ì´ˆê¸°í™”...");
      
        resizeDrawingCanvas();
        resetWsDrawState();
        scrollWrapper.scrollTop = 0;
      
      // drawingCanvas ì´ˆê¸°í™” (ëª¨ë“  ê·¸ë¦¼ ìš”ì†Œ ì œê±°)
      drawCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
      
      // ë°±ì—…ëœ ë°ì´í„° í™•ì¸ ë° ë³µì› (í•„ìš”í•œ ê²½ìš°)
      try {
        if (JSON.stringify(signatureDataPerPage) !== backupSignatureData) {
          console.warn("ì„œëª… ë°ì´í„°ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ë°±ì—…ì—ì„œ ë³µì›í•©ë‹ˆë‹¤.");
          signatureDataPerPage = JSON.parse(backupSignatureData);
        }
        
        if (JSON.stringify(drawingDataPerPage) !== backupDrawingData) {
          console.warn("ê·¸ë¦¼ ë°ì´í„°ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ë°±ì—…ì—ì„œ ë³µì›í•©ë‹ˆë‹¤.");
          drawingDataPerPage = JSON.parse(backupDrawingData);
        }
        
        if (JSON.stringify(stampDataPerPage) !== backupStampData) {
          console.warn("ë„ì¥ ë°ì´í„°ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ë°±ì—…ì—ì„œ ë³µì›í•©ë‹ˆë‹¤.");
          stampDataPerPage = JSON.parse(backupStampData);
        }
        
        if (JSON.stringify(textDataPerPage) !== backupTextData) {
          console.warn("í…ìŠ¤íŠ¸ ë°ì´í„°ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ë°±ì—…ì—ì„œ ë³µì›í•©ë‹ˆë‹¤.");
          textDataPerPage = JSON.parse(backupTextData);
        }
      } catch (backupErr) {
        console.error("ë°±ì—… ë°ì´í„° ë³µì› ì˜¤ë¥˜:", backupErr);
      }
      
      console.log("ì €ì¥ëœ ë°ì´í„° ë³µì› ì‹œì‘...");
      // ìˆœì„œëŒ€ë¡œ ìš”ì†Œ ë³µì› - ì¤‘ìš”: ì„œëª… ë°ì´í„°ëŠ” ê°€ì¥ ë§ˆì§€ë§‰ì— ë³µì›
      console.log("1. ê·¸ë¦¼ ë°ì´í„° ë³µì›...");
      restoreDrawingFromSavedData(pageNumber, false); // ìº”ë²„ìŠ¤ ì´ˆê¸°í™” ë°©ì§€
      
      console.log("2. ë„ì¥ ë°ì´í„° ë³µì›...");
        restoreStampsFromSavedData(pageNumber);
      
      console.log("3. í…ìŠ¤íŠ¸ ë°ì´í„° ë³µì›...");
        restoreTextsFromSavedData(pageNumber);
      
      // ì„œëª… ë°ì´í„° ë³µì›ì€ ë§ˆì§€ë§‰ì— ìˆ˜í–‰ (ë ˆì´ì–´ ìˆœì„œ ë•Œë¬¸)
      console.log("4. ì„œëª… ë°ì´í„° ë³µì›...");
      await new Promise(resolve => {
        // ì•½ê°„ì˜ ì§€ì—°ì„ ì£¼ì–´ ì´ì „ ì‘ì—…ë“¤ì´ ì™„ë£Œë  ì‹œê°„ì„ í™•ë³´
        setTimeout(() => {
          restoreSignaturesFromSavedData(pageNumber);
          resolve();
        }, 50);
    });
      
      console.log(`í˜ì´ì§€ ${pageNumber} ë Œë”ë§ ë° ë³µì› ì™„ë£Œ`);

      // ì½œë°± í•¨ìˆ˜ê°€ ìˆìœ¼ë©´ ì‹¤í–‰
      if (typeof callback === 'function') {
        callback();
      }
    } catch (error) {
      console.error("í˜ì´ì§€ ë Œë”ë§ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
      renderTask = null;
    }
  } catch (backupError) {
    console.error("í˜ì´ì§€ ë°ì´í„° ë°±ì—… ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", backupError);
  }
}

function resizeDrawingCanvas() {
  drawingCanvas.width = canvas.width;
  drawingCanvas.height = canvas.height;
}

function resetWsDrawState() {
  wsLastX = null;
  wsLastY = null;
}

function sendPageSync(page) {
  if (stompClient && stompClient.connected) {
    stompClient.send("/app/sync/page", {}, JSON.stringify({ pageNumber: page }));
  }
}

function sendPdfPathSync(url) {
  if (!url) {
    console.error("PDF URLì´ ì—†ì–´ ë™ê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  
  if (stompClient && stompClient.connected) {
    console.log("PDF ê²½ë¡œ ë™ê¸°í™” ë©”ì‹œì§€ ì „ì†¡:", url);
    stompClient.send("/app/sync/pdf", {}, JSON.stringify({ 
      url: url,
      sessionId: sessionId
    }));
  } else {
    console.error("WebSocket ì—°ê²°ì´ ì—†ì–´ PDF ê²½ë¡œë¥¼ ë™ê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  }

  // PDF URLì´ ì„¤ì •ë˜ë©´ ì„¸ì…˜ ë°ì´í„° ì €ì¥ (ìƒë‹´ì›/ê³ ê° ëª¨ë‘)
  if (sessionId) {
    console.log("PDF URL ì„¤ì • í›„ ì„¸ì…˜ ë°ì´í„° ì €ì¥");
    setTimeout(saveSessionData, 1000);
  }
}

function sendDrawPoint(x, y, type) {
      // íœì´ë‚˜ í˜•ê´‘íœì¼ ë•Œë§Œ push
      if (!drawingDataPerPage[currentPage]) {
        drawingDataPerPage[currentPage] = [];
      }
      drawingDataPerPage[currentPage].push({ x, y, type, mode });

    // WebSocket ì „ì†¡ì€ ëª¨ë“  ëª¨ë“œì— ëŒ€í•´ ìˆ˜í–‰
    if (stompClient && stompClient.connected && mode) {
      stompClient.send("/app/sync/draw", {}, JSON.stringify({
        type: type,
        mode: mode,
        x: x,
        y: y,
      pageNumber: currentPage
      }));
    }
  
  // ë°ì´í„°ê°€ ë³€ê²½ë˜ë©´ ì„¸ì…˜ ë°ì´í„° ì €ì¥ (ìƒë‹´ì›ë§Œ)
  if (userRole === "consultant" && type === "start") {
    // ë§ì€ ì €ì¥ ìš”ì²­ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ê·¸ë¦¬ê¸° ì‹œì‘í•  ë•Œë§Œ ì§€ì—° ì €ì¥
    setTimeout(saveSessionData, 2000);
  }
}

  function sendScrollSync(scrollTop) {
    if (stompClient && stompClient.connected) {
      stompClient.send("/app/sync/scroll", {}, JSON.stringify({
        pageNumber: currentPage,
        scrollTop: scrollTop
      }));
    }
  }

  function restoreDrawingFromSavedData(pageNumber) {
    drawCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
    const dataList = drawingDataPerPage[pageNumber];
    if (!dataList || dataList.length === 0) return;

    for (let i = 0; i < dataList.length; i++) {
      const { x, y, type, mode } = dataList[i];

      if (mode === 'pen') {
        drawCtx.strokeStyle = "red";
        drawCtx.lineWidth = 2;
      } else if (mode === 'highlight') {
        drawCtx.strokeStyle = "rgba(255, 255, 0, 0.2)";
        drawCtx.lineWidth = 10;
      }

      if (type === 'start') {
        drawCtx.beginPath();
        drawCtx.moveTo(x, y);
      } else if (type === 'move') {
        drawCtx.lineTo(x, y);
        drawCtx.stroke();
      }
    }
  }

  function connectWebSocket() {
    const socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);
    stompClient.connect({}, function () {
      console.log("WebSocket ì—°ê²°ë¨");

      stompClient.subscribe('/topic/page', function (message) {
        const data = JSON.parse(message.body);
        if (pdfDoc) {
          // í˜„ì¬ í˜ì´ì§€ì™€ ë‹¤ë¥¸ ê²½ìš°ì—ë§Œ ë³€ê²½ (ë¶ˆí•„ìš”í•œ ë Œë”ë§ ë°©ì§€)
          if (currentPage !== data.pageNumber) {
            console.log(`í˜ì´ì§€ ë™ê¸°í™”: ${currentPage} â†’ ${data.pageNumber}`);
            currentPage = data.pageNumber;
            renderPage(currentPage, function() {
              // í˜ì´ì§€ ë³€ê²½ ì•Œë¦¼
              showToast("í˜ì´ì§€ ë™ê¸°í™”", `${data.pageNumber}í˜ì´ì§€ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.`, "info");
            });
            
            // í˜ì´ì§€ ë™ê¸°í™” ì´ë²¤íŠ¸ë¡œ í˜ì´ì§€ê°€ ë³€ê²½ëœ ê²½ìš° ì„¸ì…˜ ë°ì´í„° ì €ì¥ (ëª¨ë“  ì‚¬ìš©ì)
            setTimeout(saveSessionData, 500);
          } else {
            console.log("ì´ë¯¸ ê°™ì€ í˜ì´ì§€ë¥¼ ë³´ê³  ìˆìŠµë‹ˆë‹¤:", currentPage);
          }
        } else {
          // PDFê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ì§€ë§Œ í˜ì´ì§€ ì •ë³´ê°€ ì˜¤ë©´ ì €ì¥í•´ë‘ê¸°
          console.log("PDFê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ì§€ë§Œ í˜ì´ì§€ ì •ë³´ ì €ì¥:", data.pageNumber);
          sessionStorage.setItem("lastSyncedPage", data.pageNumber);
        }
      });

    stompClient.subscribe('/topic/pdfPath', function (message) {
      const data = JSON.parse(message.body);
      console.log("PDF ê²½ë¡œ ë™ê¸°í™” ë©”ì‹œì§€ ìˆ˜ì‹ :", data.url);
      uploadedPdfUrl = data.url;
      loadPdfFromUrl(data.url);
    });

      stompClient.subscribe('/topic/draw', function (message) {
        const data = JSON.parse(message.body);
        if (!drawingDataPerPage[data.pageNumber]) {
          drawingDataPerPage[data.pageNumber] = [];
        }

          drawingDataPerPage[data.pageNumber].push({
            x: data.x,
            y: data.y,
            type: data.type,
            mode: data.mode
          });

        if (data.pageNumber !== currentPage) return;

        const x = data.x;
        const y = data.y;

        if (data.mode === 'pen') {
          drawCtx.strokeStyle = "red";
          drawCtx.lineWidth = 2;
        } else if (data.mode === 'highlight') {
          drawCtx.strokeStyle = "rgba(255, 255, 0, 0.2)";
          drawCtx.lineWidth = 10;
        }

        if (data.type === 'start') {
          drawCtx.beginPath();
          drawCtx.moveTo(x, y);
        } else if (data.type === 'move') {
          drawCtx.lineTo(x, y);
          drawCtx.stroke();
        }
      });

      stompClient.subscribe('/topic/scroll', function (message) {
        const data = JSON.parse(message.body);
        if (data.pageNumber !== currentPage) return;

        // ë‹¤ë¥¸ í´ë¼ì´ì–¸íŠ¸ê°€ ë³´ë‚¸ ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ë¥¼ ë°˜ì˜
        drawingCanvas.parentElement.scrollTop = data.scrollTop;
      });

      stompClient.subscribe('/topic/stamp', function (message) {
        const data = JSON.parse(message.body);

        // âœ… ìŠ¤íƒ¬í”„ ì €ì¥
        if (!stampDataPerPage[data.pageNumber]) {
          stampDataPerPage[data.pageNumber] = [];
        }
        stampDataPerPage[data.pageNumber].push({ x: data.x, y: data.y, image: data.image });

        // âœ… í˜„ì¬ í˜ì´ì§€ì¼ ê²½ìš° ê·¸ë¦¬ê¸°
        if (data.pageNumber === currentPage) {
          drawStamp(data.x, data.y, data.image);
        }
      });

      stompClient.subscribe('/topic/text', function (message) {
        const data = JSON.parse(message.body);
        if (!textDataPerPage[data.pageNumber]) {
          textDataPerPage[data.pageNumber] = [];
        }
        textDataPerPage[data.pageNumber].push(data);
        if (data.pageNumber === currentPage) {
          drawTextOnCanvas(data.x, data.y, data.text);
        }
      });

      stompClient.subscribe('/topic/signature', function (message) {
      console.log("ì„œëª… ë°ì´í„° ìˆ˜ì‹ :", message.body.substring(0, 100) + "...");
        const data = JSON.parse(message.body);

      console.log(`ì„œëª… ë°ì´í„° ìˆ˜ì‹  ì™„ë£Œ: í˜ì´ì§€=${data.pageNumber}, x=${data.x}, y=${data.y}`);
      
      // í˜ì´ì§€ë³„ ì„œëª… ë°ì´í„° ì €ì¥
        if (!signatureDataPerPage[data.pageNumber]) {
          signatureDataPerPage[data.pageNumber] = [];
        }
      
      // ì¤‘ë³µ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸ (ê°™ì€ ìœ„ì¹˜ì— ê°™ì€ ì„œëª… ë°©ì§€)
      const isDuplicate = signatureDataPerPage[data.pageNumber].some(
        item => item.x === data.x && item.y === data.y
      );
      
      if (!isDuplicate) {
        // ìƒˆë¡œìš´ ì„œëª… ë°ì´í„° ì €ì¥
        signatureDataPerPage[data.pageNumber].push({
          x: data.x,
          y: data.y,
          image: data.image
        });

        console.log(`í˜ì´ì§€ ${data.pageNumber}ì— ì„œëª… ë°ì´í„° ì €ì¥ ì™„ë£Œ, ì´ ${signatureDataPerPage[data.pageNumber].length}ê°œ`);
        
        // í˜„ì¬ í˜ì´ì§€ì¼ ë•Œë§Œ í™”ë©´ì— ê·¸ë¦¬ê¸°
        if (data.pageNumber === currentPage) {
          console.log("í˜„ì¬ í˜ì´ì§€ì— ì„œëª… ê·¸ë¦¬ê¸°:", data.x, data.y);
          drawSignature(data.x, data.y, data.image);
        } else {
          console.log("ë‹¤ë¥¸ í˜ì´ì§€ ì„œëª… ë°ì´í„°ë§Œ ì €ì¥:", data.pageNumber);
        }
      } else {
        console.log("ì¤‘ë³µëœ ì„œëª… ë°ì´í„° ë¬´ì‹œ");
        }
      });

      stompClient.subscribe('/topic/pdfPath', function (message) {
        const data = JSON.parse(message.body);
        uploadedPdfUrl = data.url; // ğŸ”¥ ì¶”ê°€
        loadPdfFromUrl(data.url);
      });

    // ì‚¬ìš©ì ì…ì¥ ë©”ì‹œì§€ êµ¬ë…
    stompClient.subscribe('/topic/userJoin', function (message) {
      const data = JSON.parse(message.body);
      console.log("ì‚¬ìš©ì ì…ì¥ ë©”ì‹œì§€ ìˆ˜ì‹ :", data);
      
      // ìì‹ ì´ ë³´ë‚¸ ë©”ì‹œì§€ê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì•Œë¦¼ í‘œì‹œ (role ë¹„êµ)
      const myRole = sessionStorage.getItem("role");
      if (myRole !== data.userType) {
        let title, msg, type;
        
        if (data.userType === "client") {
          title = "ê³ ê°ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤";
          msg = data.entryType === "stamp" ? 
                "ê³ ê°ì´ ë„ì¥ì„ ì´ìš©í•˜ì—¬ ì…ì¥í–ˆìŠµë‹ˆë‹¤." : 
                "ê³ ê°ì´ ì„œëª…ì„ ì´ìš©í•˜ì—¬ ì…ì¥í–ˆìŠµë‹ˆë‹¤.";
          type = "info";
        } else {
          title = "ìƒë‹´ì›ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤";
          msg = "ìƒë‹´ì›ì´ ìƒë‹´ë°©ì— ì…ì¥í–ˆìŠµë‹ˆë‹¤.";
          type = "success";
        }
        
        showToast(title, msg, type);
      }
    });

    // ìƒë‹´ ì¢…ë£Œ ë©”ì‹œì§€ êµ¬ë…
    stompClient.subscribe('/topic/endConsult', function (message) {
      console.log("ìƒë‹´ ì¢…ë£Œ ë©”ì‹œì§€ ìˆ˜ì‹ :", message.body);
      
      try {
        // ë©”ì‹œì§€ ë‚´ìš© íŒŒì‹±
        const data = JSON.parse(message.body);
        
        // ë¡œê·¸ ì¶”ê°€
        console.log("íŒŒì‹±ëœ ìƒë‹´ ì¢…ë£Œ ë°ì´í„°:", data);
        
        // í˜„ì¬ ì„¸ì…˜ IDì™€ ë©”ì‹œì§€ì˜ ì„¸ì…˜ ID ë¹„êµ
        const currentSessionId = sessionStorage.getItem("sessionId");
        
        // ì„¸ì…˜ IDê°€ ì¼ì¹˜í•˜ê±°ë‚˜ ë©”ì‹œì§€ì— ì„¸ì…˜ IDê°€ ì—†ëŠ” ê²½ìš°ì—ë§Œ ì²˜ë¦¬ (í•˜ìœ„ í˜¸í™˜ì„± ìœ ì§€)
        if (!data.sessionId || data.sessionId === currentSessionId) {
          console.log("í˜„ì¬ ì„¸ì…˜ì— í•´ë‹¹í•˜ëŠ” ìƒë‹´ ì¢…ë£Œ ë©”ì‹œì§€ì…ë‹ˆë‹¤.");
          
          // ëª¨ë“  ì‚¬ìš©ìì—ê²Œ í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
          showToast("ìƒë‹´ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤", data.message || "ìƒë‹´ì´ ì¢…ë£Œë˜ì–´ ì´ˆê¸° í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.", "info");
          
          // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œ í˜ì´ì§€ ì •ë³´ ì‚­ì œ (ìƒë‹´ ì¢…ë£Œ ì‹œ í˜ì´ì§€ ì •ë³´ ì´ˆê¸°í™”)
          sessionStorage.removeItem("lastPage");
          sessionStorage.removeItem("lastSyncedPage");
          // ìƒë‹´ ì¢…ë£Œ í”Œë˜ê·¸ ì„¤ì •
          sessionStorage.setItem("consultClosed", "true");
          // í˜„ì¬ í˜ì´ì§€ë¥¼ 1ë¡œ ì„¤ì •
          currentPage = 1;
          
          // í•­ìƒ ëª¨ë‹¬ í‘œì‹œí•˜ê³  ìë™ ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ì§€ ì•ŠìŒ
          console.log("ìƒë‹´ ì™„ë£Œ ëª¨ë‹¬ í‘œì‹œ ì˜ˆì •");
          
          // ëª¨ë‹¬ í‘œì‹œ (ë¦¬ë‹¤ì´ë ‰íŠ¸ URLì€ ëª¨ë‹¬ì˜ ë²„íŠ¼ì— ì„¤ì •)
          setTimeout(() => {
            console.log("ìƒë‹´ ì™„ë£Œ ëª¨ë‹¬ í‘œì‹œ ì‹¤í–‰");
            
            // ë¦¬ë‹¤ì´ë ‰íŠ¸ URLì´ ìˆëŠ” ê²½ìš° ë²„íŠ¼ì— ì„¤ì •
            if (data.redirectUrl) {
              console.log("ë¦¬ë‹¤ì´ë ‰íŠ¸ URLì„ ë²„íŠ¼ì— ì„¤ì •:", data.redirectUrl);
              // ë¦¬ë‹¤ì´ë ‰íŠ¸ URLì„ goToHomePage í•¨ìˆ˜ê°€ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì„¸ì…˜ì— ì €ì¥
              sessionStorage.setItem("redirectUrl", data.redirectUrl);
            }
            
            showCompleteModal();
          }, 500);
        } else {
          console.log("ë‹¤ë¥¸ ì„¸ì…˜ì˜ ìƒë‹´ ì¢…ë£Œ ë©”ì‹œì§€ì´ë¯€ë¡œ ë¬´ì‹œí•©ë‹ˆë‹¤.");
        }
      } catch (error) {
        console.error("ìƒë‹´ ì¢…ë£Œ ë©”ì‹œì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ëª¨ë‹¬ì€ í‘œì‹œ
        setTimeout(() => showCompleteModal(), 500);
      }
    });
    
    // PDF ìš”ì²­ ë©”ì‹œì§€ êµ¬ë… (ìƒë‹´ì›ë§Œ ì²˜ë¦¬)
    stompClient.subscribe('/topic/requestPdf', function (message) {
      console.log("PDF ìš”ì²­ ë©”ì‹œì§€ ìˆ˜ì‹ ");
      
      // ìƒë‹´ì›ë§Œ ì²˜ë¦¬
      if (userRole === "consultant") {
        const data = JSON.parse(message.body);
        console.log("ê³ ê°ìœ¼ë¡œë¶€í„° PDF ìš”ì²­ ë°›ìŒ:", data);
        
        // ì•Œë¦¼ í‘œì‹œ
        showToast("PDF ìš”ì²­", "ê³ ê°ì´ PDF ë¬¸ì„œë¥¼ ìš”ì²­í–ˆìŠµë‹ˆë‹¤.", "info");
        
        // PDF ê³µìœ  í•¨ìˆ˜ í˜¸ì¶œ
        setTimeout(() => sharePdfToClient(data.requesterId), 500);
      }
    });
    
    // í˜„ì¬ í˜ì´ì§€ ì •ë³´ ìš”ì²­ êµ¬ë… (ìƒë‹´ì›ë§Œ ì²˜ë¦¬)
    stompClient.subscribe('/topic/requestCurrentPage', function (message) {
      console.log("í˜„ì¬ í˜ì´ì§€ ì •ë³´ ìš”ì²­ ìˆ˜ì‹ ");
      
      // ìƒë‹´ì›ë§Œ ì²˜ë¦¬
      if (userRole === "consultant") {
        const data = JSON.parse(message.body);
        console.log("ê³ ê°ìœ¼ë¡œë¶€í„° í˜„ì¬ í˜ì´ì§€ ì •ë³´ ìš”ì²­ ë°›ìŒ:", data);
        
        // í˜ì´ì§€ ì •ë³´ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ ì „ì†¡
        if (pdfDoc && currentPage) {
          console.log("í˜„ì¬ í˜ì´ì§€ ì •ë³´ ê³µìœ :", currentPage);
          // í˜„ì¬ í˜ì´ì§€ ì •ë³´ ì „ì†¡
          sendPageSync(currentPage);
        }
      }
    });
    });
  }

  connectWebSocket();

  function sendSignature(x, y, imageBase64) {
  console.log("ì„œëª… ì „ì†¡:", x, y, currentPage);
    if (stompClient && stompClient.connected) {
    const message = {
      x: x,
      y: y,
      image: imageBase64,
      pageNumber: currentPage
    };
    console.log("ì„œëª… ë©”ì‹œì§€:", JSON.stringify(message).substring(0, 100) + "...");
    stompClient.send("/app/sync/signature", {}, JSON.stringify(message));
    
    // ì„œëª… ì¶”ê°€ í›„ ì„¸ì…˜ ë°ì´í„° ì €ì¥ (ìƒë‹´ì›/ê³ ê° ëª¨ë‘ ì €ì¥)
    setTimeout(saveSessionData, 1000);
  } else {
    console.error("WebSocket ì—°ê²° ìƒíƒœ:", stompClient ? "ê°ì²´ ìˆìŒ" : "ê°ì²´ ì—†ìŒ", stompClient ? (stompClient.connected ? "ì—°ê²°ë¨" : "ì—°ê²°ì•ˆë¨") : "");
    }
  }

  function prevPage() {
    if (currentPage <= 1) return;
  
  console.log(`ì´ì „ í˜ì´ì§€ë¡œ ì´ë™: ${currentPage} â†’ ${currentPage-1}`);
  const prevPageNum = currentPage - 1;
  
  // ì´ë™í•˜ë ¤ëŠ” í˜ì´ì§€ì˜ ì„œëª… ë°ì´í„° ë¯¸ë¦¬ í™•ì¸
  const signatures = signatureDataPerPage[prevPageNum] || [];
  console.log(`í˜ì´ì§€ ${prevPageNum}ì˜ ì„œëª… ë°ì´í„°: ${signatures.length}ê°œ`);
  
  // í˜ì´ì§€ ì´ë™ ì „ì— í˜„ì¬ í˜ì´ì§€ì˜ ì„œëª… ë°ì´í„°ê°€ ìˆë‹¤ë©´ ëª…ì‹œì ìœ¼ë¡œ ë°±ì—…
  if (signatureDataPerPage[currentPage] && signatureDataPerPage[currentPage].length > 0) {
    console.log(`í˜„ì¬ í˜ì´ì§€ ${currentPage}ì˜ ì„œëª… ë°ì´í„° ë°±ì—…: ${signatureDataPerPage[currentPage].length}ê°œ`);
  }
  
    currentPage--;
    
    // í˜ì´ì§€ ë²ˆí˜¸ë¥¼ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ (ìƒˆë¡œê³ ì¹¨ ëŒ€ë¹„)
    sessionStorage.setItem("lastPage", currentPage);
    
  renderPage(currentPage, function() {
    sendPageSync(currentPage);
    updateModeStatus(`í˜ì´ì§€ ${currentPage} í‘œì‹œ ì¤‘`);
    
    // í˜ì´ì§€ ì´ë™ í›„ ì„¸ì…˜ ë°ì´í„° ì €ì¥ (ìƒë‹´ì›/ê³ ê° ëª¨ë‘)
    setTimeout(saveSessionData, 500);
  });
  }

  function nextPage() {
    if (currentPage >= pdfDoc.numPages) return;
  
  console.log(`ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™: ${currentPage} â†’ ${currentPage+1}`);
  const nextPageNum = currentPage + 1;
  
  // ì´ë™í•˜ë ¤ëŠ” í˜ì´ì§€ì˜ ì„œëª… ë°ì´í„° ë¯¸ë¦¬ í™•ì¸
  const signatures = signatureDataPerPage[nextPageNum] || [];
  console.log(`í˜ì´ì§€ ${nextPageNum}ì˜ ì„œëª… ë°ì´í„°: ${signatures.length}ê°œ`);
  
  // í˜ì´ì§€ ì´ë™ ì „ì— í˜„ì¬ í˜ì´ì§€ì˜ ì„œëª… ë°ì´í„°ê°€ ìˆë‹¤ë©´ ëª…ì‹œì ìœ¼ë¡œ ë°±ì—…
  if (signatureDataPerPage[currentPage] && signatureDataPerPage[currentPage].length > 0) {
    console.log(`í˜„ì¬ í˜ì´ì§€ ${currentPage}ì˜ ì„œëª… ë°ì´í„° ë°±ì—…: ${signatureDataPerPage[currentPage].length}ê°œ`);
  }
  
    currentPage++;
    
    // í˜ì´ì§€ ë²ˆí˜¸ë¥¼ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ (ìƒˆë¡œê³ ì¹¨ ëŒ€ë¹„)
    sessionStorage.setItem("lastPage", currentPage);
    
  renderPage(currentPage, function() {
    sendPageSync(currentPage);
    updateModeStatus(`í˜ì´ì§€ ${currentPage} í‘œì‹œ ì¤‘`);
    
    // í˜ì´ì§€ ì´ë™ í›„ ì„¸ì…˜ ë°ì´í„° ì €ì¥ (ìƒë‹´ì›/ê³ ê° ëª¨ë‘)
    setTimeout(saveSessionData, 500);
  });
}

function setHighlighter() { 
  mode = 'highlight'; 
  updateModeStatus('í˜•ê´‘íœ');
  highlightActiveButton('í˜•ê´‘íœ');
}

function setPen() { 
  mode = 'pen'; 
  updateModeStatus('íœ');
  highlightActiveButton('íœ');
}

function setCursor() { 
  mode = null; 
  updateModeStatus('ì»¤ì„œ');
  highlightActiveButton('ì»¤ì„œ');
}

function setStampMode() {
  mode = 'stamp';
  updateModeStatus('ë„ì¥');
  highlightActiveButton('ë„ì¥');
  alert("PDF ìœ„ì— í´ë¦­í•´ì„œ ë„ì¥ì„ ì‚½ì…í•˜ì„¸ìš”.");
}

function setSignatureMode() {
  mode = 'signature';
  updateModeStatus('ì„œëª…');
  highlightActiveButton('ì„œëª…');
  alert("PDFë¥¼ í´ë¦­í•˜ë©´ ì„œëª…ì´ ì‚½ì…ë©ë‹ˆë‹¤.");
}

function openTextPopup() {
  document.getElementById('textPopup').style.display = 'block';
  updateModeStatus('í…ìŠ¤íŠ¸ ì…ë ¥');
  highlightActiveButton('í…ìŠ¤íŠ¸ ì…ë ¥');
}

// í˜„ì¬ ëª¨ë“œ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateModeStatus(modeName) {
  document.getElementById('currentMode').textContent = modeName;
}

// í™œì„±í™”ëœ ë²„íŠ¼ í•˜ì´ë¼ì´íŠ¸ í•¨ìˆ˜
function highlightActiveButton(buttonName) {
  // ëª¨ë“  ë„êµ¬ ë²„íŠ¼ì˜ í™œì„±í™” ìƒíƒœ ì œê±°
  const buttons = document.querySelectorAll('.tool-btn');
  buttons.forEach(btn => {
    btn.classList.remove('active');
  });
  
  // í•´ë‹¹ ë²„íŠ¼ í™œì„±í™”
  let activeButton;
  
  if (buttonName === 'í˜•ê´‘íœ') {
    activeButton = document.getElementById('highlighterBtn');
  } else if (buttonName === 'íœ') {
    activeButton = document.getElementById('penBtn');
  } else if (buttonName === 'ì»¤ì„œ') {
    activeButton = document.getElementById('cursorBtn');
  } else if (buttonName === 'í…ìŠ¤íŠ¸ ì…ë ¥') {
    activeButton = document.getElementById('textBtn');
  } else if (buttonName === 'ë„ì¥') {
    activeButton = document.getElementById('stampBtn');
  }
  
  if (activeButton) {
    activeButton.classList.add('active');
  }
}

  drawingCanvas.addEventListener("mousedown", (e) => {
    const x = e.offsetX;
    const y = e.offsetY;

    if (mode === 'text' || mode === null) return;

    if (mode === 'signature') {
    console.log("ì„œëª… ëª¨ë“œì—ì„œ í´ë¦­ ê°ì§€");
      const image = sessionStorage.getItem("signatureImage");
    if (!image) {
      console.error("ì„œëª… ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤");
      return;
    }
    console.log("ì„œëª… ì´ë¯¸ì§€ í¬ê¸°:", image.length);
      drawSignature(x, y, image);
    
    // ì„œëª… ë°ì´í„° ì €ì¥
    if (!signatureDataPerPage[currentPage]) {
      signatureDataPerPage[currentPage] = [];
    }
      signatureDataPerPage[currentPage].push({ x, y, image });
    
    // WebSocketìœ¼ë¡œ ì‹¤ì‹œê°„ ì „ì†¡
      sendSignature(x, y, image);
    
      mode = null;
      return;
    }

    drawing = true;
    drawCtx.beginPath();
    drawCtx.moveTo(x, y);
    drawCtx.lineTo(x, y);
    drawCtx.stroke();
    sendDrawPoint(x, y, "start");
    });

  drawingCanvas.addEventListener("mouseup", () => {
    drawing = false;
    localLastX = null;
    localLastY = null;
  });

  scrollWrapper.addEventListener("scroll", () => {
    sendScrollSync(scrollWrapper.scrollTop);
  });

  const role = sessionStorage.getItem("role");
  const stampImageBase64 = sessionStorage.getItem("stampImage");

    document.addEventListener("DOMContentLoaded", () => {
      console.log("DOM ë¡œë“œ ì™„ë£Œ - í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘");
      const role = sessionStorage.getItem("role");
      const entryType = sessionStorage.getItem("entryType");
      const sessionId = sessionStorage.getItem("sessionId");
      console.log("ì—­í• :", role, "ì…ì¥ íƒ€ì…:", entryType, "ì„¸ì…˜ ID:", sessionId);

      // ì´ˆê¸° ëª¨ë“œ ìƒíƒœ ì„¤ì •
      updateModeStatus('ì»¤ì„œ');
      
      // ìº”ë²„ìŠ¤ ê´€ë ¨ ì„¤ì • ìµœì í™”
      if (drawingCanvas && drawingCanvas.getContext) {
        drawCtx.imageSmoothingEnabled = true;
        drawCtx.imageSmoothingQuality = 'high';
      }
      
      // í˜ì´ì§€ê°€ ë¡œë“œë˜ê¸° ì „ì— ì„œëª… ì´ë¯¸ì§€ ë¯¸ë¦¬ ë¡œë“œ
      const signatureImage = sessionStorage.getItem("signatureImage");
      if (signatureImage && entryType === "signature") {
        console.log("ì„œëª… ì´ë¯¸ì§€ ë¯¸ë¦¬ ë¡œë“œ ì¤‘...");
        const preloadImg = new Image();
        preloadImg.onload = () => {
          imageCache[signatureImage] = preloadImg;
          console.log("ì„œëª… ì´ë¯¸ì§€ ë¯¸ë¦¬ ë¡œë“œ ì™„ë£Œ");
        };
        preloadImg.src = signatureImage;
      }
      
      // ì‚¬ìš©ì ì…ì¥ ë©”ì‹œì§€ ì „ì†¡ (WebSocket ì—°ê²° í›„)
      setTimeout(() => {
        if (stompClient && stompClient.connected) {
          sendUserJoinMessage();
          
          // ì„¸ì…˜ ë°ì´í„° ìë™ ì €ì¥ ì‹œì‘ (ìƒë‹´ì›ë§Œ)
          if (role === "agent") {
            startAutoSave();
          }
        } else {
          // WebSocket ì—°ê²°ì´ ì•„ì§ ì•ˆë˜ì—ˆìœ¼ë©´ ë‹¤ì‹œ ì‹œë„
          const checkInterval = setInterval(() => {
            if (stompClient && stompClient.connected) {
              sendUserJoinMessage();
              
              // ì„¸ì…˜ ë°ì´í„° ìë™ ì €ì¥ ì‹œì‘ (ìƒë‹´ì›ë§Œ)
              if (role === "agent") {
                startAutoSave();
              }
              
              clearInterval(checkInterval);
            }
          }, 500);
        }
      }, 1000);
      
      // ì—­í• ì— ë”°ë¥¸ UI ì¡°ì •
      if (role === "client") {
        // í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ìˆ¨ê¸¸ ë²„íŠ¼ë“¤
        document.getElementById("pdfUpload").style.display = "none";
        const prevButton = document.querySelector("button[onclick='prevPage()']");
        const nextButton = document.querySelector("button[onclick='nextPage()']");
        const endConsultButton = document.querySelector("button[onclick='endConsult()']");
        
        // ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        if (prevButton) prevButton.style.display = "none";
        if (nextButton) nextButton.style.display = "none";
        if (endConsultButton) endConsultButton.style.display = "none";
        
        // ë²„íŠ¼ ì»¨í…Œì´ë„ˆ
        const buttonContainer = document.getElementById("buttonArea");

        // ë„ì¥ ë˜ëŠ” ì„œëª… ë²„íŠ¼ í‘œì‹œ
        if (entryType === "stamp") {
          document.getElementById("stampBtn").style.display = "inline-block";
        } else if (entryType === "signature") {
          const signBtn = document.createElement("button");
          signBtn.innerText = "ì„œëª…";
          signBtn.onclick = setSignatureMode;
          
          // í…ìŠ¤íŠ¸ ì…ë ¥ ë²„íŠ¼ ë‹¤ìŒì— ì„œëª… ë²„íŠ¼ ì‚½ì…í•˜ëŠ” ë°©ì‹ ë³€ê²½
          const stampBtn = document.getElementById("stampBtn");
          // ë„ì¥ ë²„íŠ¼ ìœ„ì¹˜ì— ì„œëª… ë²„íŠ¼ ì‚½ì…
          if (stampBtn && stampBtn.parentNode) {
            buttonContainer.insertBefore(signBtn, stampBtn);
          } else {
            // ë„ì¥ ë²„íŠ¼ì´ ì—†ìœ¼ë©´ ë§ˆì§€ë§‰ ë²„íŠ¼ ì•ì— ì‚½ì…
            const lastBtn = document.querySelector("button[onclick='endConsult()']");
            if (lastBtn) {
              buttonContainer.insertBefore(signBtn, lastBtn);
            } else {
              // ë§ˆì§€ë§‰ ë²„íŠ¼ë„ ì—†ìœ¼ë©´ ì»¨í…Œì´ë„ˆ ë§ˆì§€ë§‰ì— ì¶”ê°€
          buttonContainer.appendChild(signBtn);
            }
          }
        } else {
          alert("entryTypeì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì…ì¥í•´ì£¼ì„¸ìš”.");
        }
      } else {
        // ìƒë‹´ì›ì¸ ê²½ìš° ëª¨ë“  ë²„íŠ¼ í‘œì‹œ
        // ìƒë‹´ì›ë§Œ 'ìƒë‹´ì¢…ë£Œ' ë²„íŠ¼ì´ ë³´ì´ë„ë¡ í•¨
        const endConsultButton = document.querySelector("button[onclick='endConsult()']");
        if (endConsultButton) endConsultButton.style.display = "inline-block";
      }
    });

  function drawStamp(x, y, imageSrc) {
    const img = new Image();
    img.onload = () => {
      const size = 50; // ë„ì¥ í¬ê¸°
      drawCtx.drawImage(img, x - size / 2, y - size / 2, size, size);
    };
    img.src = imageSrc;
  }

  function sendStamp(x, y, imageBase64) {
    // âœ… ìŠ¤íƒ¬í”„ ì¢Œí‘œ ì €ì¥
    if (!stampDataPerPage[currentPage]) {
      stampDataPerPage[currentPage] = [];
    }
    stampDataPerPage[currentPage].push({ x, y, image: imageBase64 });

    // âœ… WebSocket ì „ì†¡
    if (stompClient && stompClient.connected) {
      stompClient.send("/app/sync/stamp", {}, JSON.stringify({
        x: x,
        y: y,
        image: imageBase64,
        pageNumber: currentPage
      }));
    }
  
  // ë„ì¥ ì¶”ê°€ í›„ ì„¸ì…˜ ë°ì´í„° ì €ì¥ (ìƒë‹´ì›/ê³ ê° ëª¨ë‘)
  setTimeout(saveSessionData, 1000);
}

// ì´ë¯¸ì§€ ìºì‹œ ê°ì²´ ì¶”ê°€
const imageCache = {};

  function drawSignature(x, y, imageSrc) {
  console.log(`ì„œëª… ê·¸ë¦¬ê¸°: x=${x}, y=${y}, ì´ë¯¸ì§€ ê¸¸ì´=${imageSrc ? imageSrc.length : 0}`);
  
  if (!imageSrc) {
    console.error("ì„œëª… ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤");
    return;
  }
  
  try {
    // ì´ë¯¸ì§€ê°€ ìºì‹œì— ìˆëŠ”ì§€ í™•ì¸
    if (imageCache[imageSrc]) {
      console.log("ìºì‹œëœ ì´ë¯¸ì§€ ì‚¬ìš©");
      try {
        // ìºì‹œëœ ì´ë¯¸ì§€ê°€ ìœ íš¨í•œì§€ í™•ì¸
        if (imageCache[imageSrc].complete) {
          drawCtx.drawImage(imageCache[imageSrc], x - 30, y - 15, 100, 50);
        } else {
          // ì´ë¯¸ì§€ê°€ ì•„ì§ ë¡œë“œ ì¤‘ì¸ ê²½ìš° ë¡œë“œ ì™„ë£Œ ì´ë²¤íŠ¸ ì¶”ê°€
          imageCache[imageSrc].onload = () => {
            try {
              drawCtx.drawImage(imageCache[imageSrc], x - 30, y - 15, 100, 50);
              console.log("ìºì‹œëœ ì´ë¯¸ì§€ ì§€ì—° ê·¸ë¦¬ê¸° ì™„ë£Œ");
            } catch (e) {
              console.error("ìºì‹œëœ ì´ë¯¸ì§€ ì§€ì—° ê·¸ë¦¬ê¸° ì˜¤ë¥˜:", e);
            }
          };
        }
      } catch (e) {
        console.error("ìºì‹œëœ ì´ë¯¸ì§€ ê·¸ë¦¬ê¸° ì˜¤ë¥˜:", e);
        // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì´ë¯¸ì§€ ë‹¤ì‹œ ë¡œë“œ ì‹œë„
        delete imageCache[imageSrc];
        setTimeout(() => drawSignature(x, y, imageSrc), 100);
      }
      return;
    }
    
    const img = new Image();
    
    // ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ í˜¸ì¶œë˜ëŠ” ì½œë°±
    img.onload = () => {
      // ì´ë¯¸ì§€ë¥¼ ìºì‹œì— ì €ì¥
      imageCache[imageSrc] = img;
      
      // ì„œëª… ê·¸ë¦¬ê¸°
      try {
        drawCtx.drawImage(img, x - 30, y - 15, 100, 50);
        console.log("ì„œëª… ì´ë¯¸ì§€ ê·¸ë¦¬ê¸° ì™„ë£Œ");
      } catch (e) {
        console.error("ì„œëª… ì´ë¯¸ì§€ ê·¸ë¦¬ê¸° ì˜¤ë¥˜:", e);
      }
    };
    
    img.onerror = (e) => {
      console.error("ì„œëª… ì´ë¯¸ì§€ ë¡œë“œ ì˜¤ë¥˜:", e);
      delete imageCache[imageSrc]; // ì˜¤ë¥˜ ë°œìƒ ì‹œ ìºì‹œì—ì„œ ì œê±°
    };
    
    // ì´ë¯¸ì§€ ì†ŒìŠ¤ ì„¤ì • (ì´ ì‹œì ì—ì„œ ì´ë¯¸ì§€ ë¡œë“œ ì‹œì‘)
    img.src = imageSrc;
    
    // 5ì´ˆ í›„ì—ë„ ë¡œë“œê°€ ì•ˆ ë˜ë©´ íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬
    setTimeout(() => {
      if (!img.complete) {
        console.warn(`ì„œëª… ì´ë¯¸ì§€ ë¡œë“œ íƒ€ì„ì•„ì›ƒ (x=${x}, y=${y})`);
        delete imageCache[imageSrc];
      }
    }, 5000);
  } catch (e) {
    console.error("ì„œëª… ê·¸ë¦¬ê¸° ì¤‘ ì˜ˆì™¸ ë°œìƒ:", e);
    }
}

  function endConsult() {
  if (!uploadedPdfUrl) {
    alert("PDF íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. PDFë¥¼ ë¨¼ì € ì—…ë¡œë“œí•˜ê±°ë‚˜ ê³µìœ ë°›ì€ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
    return;
  }

  // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œ í˜ì´ì§€ ì •ë³´ ì‚­ì œ (ìƒë‹´ ì¢…ë£Œ ì‹œ í˜ì´ì§€ ì •ë³´ ì´ˆê¸°í™”)
  sessionStorage.removeItem("lastPage");
  sessionStorage.removeItem("lastSyncedPage");
  // ìƒë‹´ ì¢…ë£Œ í”Œë˜ê·¸ ì„¤ì •
  sessionStorage.setItem("consultClosed", "true");
  // í˜„ì¬ í˜ì´ì§€ë¥¼ 1ë¡œ ì„¤ì •
  currentPage = 1;

  // ìƒë‹´ì›ê³¼ ê³ ê°ì— ë”°ë¼ ë‹¤ë¥¸ ì²˜ë¦¬
  if (userRole === "agent") {
    // ë¨¼ì € WebSocketìœ¼ë¡œ ìƒë‹´ ì¢…ë£Œ ë©”ì‹œì§€ë¥¼ ì „ì†¡
    if (stompClient && stompClient.connected) {
      stompClient.send("/app/sync/endConsult", {}, JSON.stringify({
        message: "ìƒë‹´ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ˆê¸° í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.",
        sessionId: sessionId,
        redirectUrl: "/main-page"  // ë¦¬ë‹¤ì´ë ‰íŠ¸ ê²½ë¡œë¥¼ main-pageë¡œ ì„¤ì •
      }));
      console.log("ìƒë‹´ ì¢…ë£Œ ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ");
    } else {
      console.error("WebSocket ì—°ê²°ì´ ëŠì–´ì ¸ ìƒë‹´ ì¢…ë£Œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }
    
    // 1. ê³„ì•½ ì •ë³´ ìƒì„±
    const contractData = {
      status: "ì™„ë£Œ", // ë¬¸ìì—´ íƒ€ì…ì˜ ìƒíƒœê°’(ìˆ«ì ì•„ë‹˜)
      clientId: sessionStorage.getItem("clientId") || "1", // Stringìœ¼ë¡œ ìœ ì§€
      agentId: sessionStorage.getItem("agentId") || "1",   // Stringìœ¼ë¡œ ìœ ì§€ 
      memo: "ìƒë‹´ ì™„ë£Œ: " + new Date().toLocaleString()  // ë©”ëª¨ì— í˜„ì¬ ì‹œê°„ ê¸°ë¡
    };
    
    console.log("ê³„ì•½ ë°ì´í„° ì „ì†¡:", JSON.stringify(contractData));
    
    // 2. ê³„ì•½ ì •ë³´ DBì— ì €ì¥
    fetch('/api/contract', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(contractData)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        console.log("ê³„ì•½ ì •ë³´ ì €ì¥ ì„±ê³µ:", data);
        showToast("ìƒë‹´ ì¢…ë£Œ", "ìƒë‹´ì´ ì¢…ë£Œë˜ê³  ê³„ì•½ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
      } else {
        console.error("ê³„ì•½ ì €ì¥ ì‹¤íŒ¨:", data);
        showToast("ì €ì¥ ì‹¤íŒ¨", "ê³„ì•½ ì •ë³´ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
      }
      
      // ìƒë‹´ì› ìƒíƒœ ë³€ê²½
      updateAgentStatus(false);
      
      // ì™„ë£Œ ëª¨ë‹¬ í‘œì‹œ
      showCompleteModal();
    })
    .catch(error => {
      console.error("ê³„ì•½ ì €ì¥ ì˜¤ë¥˜:", error);
      showToast("ì €ì¥ ì˜¤ë¥˜", "ê³„ì•½ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
      
      // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ìƒë‹´ì€ ì¢…ë£Œ
      updateAgentStatus(false);
      showCompleteModal();
    });
  } else {
    // ê³ ê°ì¸ ê²½ìš°: ë°”ë¡œ ì™„ë£Œ ëª¨ë‹¬ í‘œì‹œ
    showCompleteModal();
  }
}

// í˜ì´ì§€ë¥¼ ë– ë‚  ë•Œ ìƒë‹´ì› ìƒíƒœ ë³€ê²½ (ì›ë˜ ìˆë˜ ë¦¬ìŠ¤ë„ˆì— ì¶”ê°€)
const additionalUnloadHandler = function(e) {
  console.log("í˜ì´ì§€ ì´íƒˆ ê°ì§€ - ì •ë¦¬ ì‘ì—… ìˆ˜í–‰");
  
  if (userRole === "agent") {
    // ìƒë‹´ì›ì´ í˜ì´ì§€ë¥¼ ë– ë‚  ë•Œ í‡´ì¥ ìƒíƒœë¡œ ë³€ê²½
    updateAgentStatus(false);
  }
  
  // ì„¸ì…˜ ë°ì´í„° ë§ˆì§€ë§‰ìœ¼ë¡œ ì €ì¥ ì‹œë„
  if (sessionId) {
    saveSessionData();
    }
};

// ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì— ì¶”ê°€ë¡œ ë“±ë¡
window.addEventListener('beforeunload', additionalUnloadHandler);

  function restoreStampsFromSavedData(pageNumber) {
    const stampList = stampDataPerPage[pageNumber];
    if (!stampList) return;

    stampList.forEach(({ x, y, image }) => {
      drawStamp(x, y, image);
    });
  }

  function closeTextPopup() {
    document.getElementById('textPopup').style.display = 'none';
    //pendingText = null;
  }

  function confirmText() {
    const text = document.getElementById('textInput').value.trim();
    if (!text) return alert("í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
    pendingText = text;
    mode = 'text'; // í…ìŠ¤íŠ¸ ì‚½ì… ëª¨ë“œ
    closeTextPopup();
    alert("PDFë¥¼ í´ë¦­í•˜ì—¬ í…ìŠ¤íŠ¸ë¥¼ ì‚½ì…í•˜ì„¸ìš”.");
  }

  drawingCanvas.addEventListener("click", (e) => {
    console.log("Canvas í´ë¦­ë¨", mode, pendingText);
    const x = e.offsetX;
    const y = e.offsetY;

    if (mode === 'text' && pendingText) {
      drawTextOnCanvas(x, y, pendingText);
      sendText(x, y, pendingText);
      textDataPerPage[currentPage] = textDataPerPage[currentPage] || [];
      textDataPerPage[currentPage].push({ x, y, text: pendingText });
      pendingText = null;
      mode = null;
      
      // í…ìŠ¤íŠ¸ ì¶”ê°€ í›„ ëª…ì‹œì  ì €ì¥
      setTimeout(saveSessionData, 500);
      return;
    }

    if (mode === 'stamp') {
    const image = stampImageBase64 || localStorage.getItem("stampImage") || sessionStorage.getItem("stampImage");
      if (!image) return;
      drawStamp(x, y, image);
      sendStamp(x, y, image);
      mode = null;
      
      // ë„ì¥ ì¶”ê°€ í›„ ëª…ì‹œì  ì €ì¥
      setTimeout(saveSessionData, 500);
    return;
  }
  
  if (mode === 'signature') {
    const image = sessionStorage.getItem("signatureImage");
    if (!image) return;
    drawSignature(x, y, image);
    
    // ì„œëª… ë°ì´í„° ì €ì¥
    if (!signatureDataPerPage[currentPage]) {
      signatureDataPerPage[currentPage] = [];
    }
    signatureDataPerPage[currentPage].push({ x, y, image });
    
    // WebSocketìœ¼ë¡œ ì‹¤ì‹œê°„ ì „ì†¡
    sendSignature(x, y, image);
    
    mode = null;
    
    // ì„œëª… ì¶”ê°€ í›„ ëª…ì‹œì  ì €ì¥
    setTimeout(saveSessionData, 500);
    return;
    }
  });

  function drawTextOnCanvas(x, y, text) {
    console.log("í…ìŠ¤íŠ¸ ì‚½ì…:", text, x, y);
    drawCtx.font = "16px Arial";
    drawCtx.fillStyle = "blue";
    drawCtx.fillText(text, x, y);
  }
  function sendText(x, y, text) {
    console.log("í…ìŠ¤íŠ¸ ì „ì†¡:", text, x, y);
    if (!stompClient || !stompClient.connected) return;
    stompClient.send("/app/sync/text", {}, JSON.stringify({
      x: x,
      y: y,
      text: text,
      pageNumber: currentPage
    }));
  
  // í…ìŠ¤íŠ¸ ì¶”ê°€ í›„ ì„¸ì…˜ ë°ì´í„° ì €ì¥ (ìƒë‹´ì›/ê³ ê° ëª¨ë‘)
  setTimeout(saveSessionData, 1000);
  }

  function restoreTextsFromSavedData(pageNumber) {
    const list = textDataPerPage[pageNumber];
    if (!list) return;
    list.forEach(({ x, y, text }) => drawTextOnCanvas(x, y, text));
  }

// ì„œëª… ë°ì´í„°ë¥¼ ë³µì›í•˜ëŠ” í•¨ìˆ˜ ì¶”ê°€ (ê°œì„ ëœ ë²„ì „)
function restoreSignaturesFromSavedData(pageNumber) {
  const signatureList = signatureDataPerPage[pageNumber];
  if (!signatureList || signatureList.length === 0) {
    console.log(`í˜ì´ì§€ ${pageNumber}ì— ë³µì›í•  ì„œëª… ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`);
    return;
  }
  
  console.log(`í˜ì´ì§€ ${pageNumber}ì˜ ì„œëª… ë°ì´í„° ë³µì›: ${signatureList.length}ê°œ`);

  // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ëª¨ë“  ì´ë¯¸ì§€ ë¡œë“œ ì‹œì‘
  signatureList.forEach(({ image, x, y }, index) => {
    if (!image) {
      console.warn(`ì„œëª… ë°ì´í„° #${index+1}ì— ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.`);
      return;
    }
    
    // ì´ë¯¸ ìºì‹œì— ìˆëŠ” ì´ë¯¸ì§€ëŠ” ë°”ë¡œ ê·¸ë¦¬ê¸°
    if (imageCache[image] && imageCache[image].complete) {
      console.log(`ìºì‹œëœ ì´ë¯¸ì§€ #${index+1} ì‚¬ìš©`);
      if (currentPage === pageNumber) {
        try {
          drawSignature(x, y, image);
        } catch (e) {
          console.error(`ìºì‹œëœ ì´ë¯¸ì§€ ê·¸ë¦¬ê¸° ì˜¤ë¥˜:`, e);
        }
      }
      return;
    }
    
    // ì´ë¯¸ì§€ ìƒˆë¡œ ë¡œë“œ
    const img = new Image();
    
    // ë¡œë“œ ì™„ë£Œ ì‹œ ìºì‹œì— ì €ì¥í•˜ê³  ê·¸ë¦¬ê¸°
    img.onload = () => {
      imageCache[image] = img;
      console.log(`ì„œëª… ì´ë¯¸ì§€ #${index+1} ë¡œë“œ ì™„ë£Œ`);
      
      // í˜„ì¬ ë³´ê³  ìˆëŠ” í˜ì´ì§€ì—ë§Œ ê·¸ë¦¬ê¸°
      if (currentPage === pageNumber) {
        try {
          drawSignature(x, y, image);
        } catch (e) {
          console.error(`ìƒˆ ì´ë¯¸ì§€ ê·¸ë¦¬ê¸° ì˜¤ë¥˜:`, e);
        }
      }
    };
    
    img.onerror = (err) => {
      console.error(`ì„œëª… ì´ë¯¸ì§€ #${index+1} ë¡œë“œ ì‹¤íŒ¨:`, err);
      
      // ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ (1íšŒ)
      setTimeout(() => {
        console.log(`ì„œëª… ì´ë¯¸ì§€ #${index+1} ë¡œë“œ ì¬ì‹œë„...`);
        const retryImg = new Image();
        retryImg.onload = () => {
          imageCache[image] = retryImg;
          if (currentPage === pageNumber) {
            drawSignature(x, y, image);
          }
        };
        retryImg.src = image;
      }, 1000);
    };
    
    // ì´ë¯¸ì§€ ë¡œë“œ ì‹œì‘
    img.src = image;
  });
  
  // í˜ì´ì§€ ë¡œë“œ í›„ 3ì´ˆ ë’¤ ì •ë ¬ëœ ê·¸ë¦¬ê¸° ì¬ì‹œë„ (ë§ˆì§€ë§‰ ì•ˆì „ ì¥ì¹˜)
  setTimeout(() => {
    if (currentPage === pageNumber) {
      console.log(`í˜ì´ì§€ ${pageNumber}ì˜ ì„œëª… ë°ì´í„° ìµœì¢… í™•ì¸ ë° ë³µì›`);
      signatureList.forEach(({ x, y, image }) => {
        if (image && imageCache[image] && imageCache[image].complete) {
          try {
            drawSignature(x, y, image);
          } catch (e) {
            console.error("ìµœì¢… ì„œëª… ë³µêµ¬ ì‹œë„ ì‹¤íŒ¨:", e);
          }
        }
      });
    }
  }, 3000);
}

  drawingCanvas.addEventListener("mousemove", (e) => {
    if (!drawing || !mode) return;

    const x = e.offsetX;
    const y = e.offsetY;

    if (mode === 'pen') {
      drawCtx.strokeStyle = "red";
      drawCtx.lineWidth = 2;
    } else if (mode === 'highlight') {
      drawCtx.strokeStyle = "rgba(255, 255, 0, 0.2)";
      drawCtx.lineWidth = 10;
    }

    drawCtx.lineTo(x, y);
    drawCtx.stroke();

    sendDrawPoint(x, y, "move");
    localLastX = x;
    localLastY = y;
  });

async function savePdfWithStampAndSignature(forEmail = false) {
  try {
    const PDFDocument = window.PDFLib.PDFDocument;

    if (!uploadedPdfUrl) {
      throw new Error("PDF íŒŒì¼ ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }

    // ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
    if (!forEmail) {
      alert("PDF ì €ì¥ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...");
    } else {
      showToast("PDF ìƒì„± ì¤‘", "PDF ë¬¸ì„œë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...", "info");
    }

    // ì›ë³¸ PDF ê°€ì ¸ì˜¤ê¸°
    const existingPdfBytes = await fetch(uploadedPdfUrl).then(res => res.arrayBuffer());
    const pdfDocLib = await PDFDocument.load(existingPdfBytes);
    const pages = pdfDocLib.getPages();

    // í˜ì´ì§€ë³„ë¡œ ë„ì¥ê³¼ ì„œëª… ë°ì´í„° ì²˜ë¦¬
    for (let i = 0; i < pages.length; i++) {
      const pageNumber = i + 1;
      const page = pages[i];
      const { width, height } = page.getSize();

      // ì´ í˜ì´ì§€ì— ìˆëŠ” ë„ì¥ ëª©ë¡
      const stampItems = stampDataPerPage[pageNumber] || [];
      console.log(`í˜ì´ì§€ ${pageNumber}ì˜ ë„ì¥ ê°œìˆ˜: ${stampItems.length}`);

      // ì´ í˜ì´ì§€ì— ìˆëŠ” ì„œëª… ëª©ë¡
      const signatureItems = signatureDataPerPage[pageNumber] || [];
      console.log(`í˜ì´ì§€ ${pageNumber}ì˜ ì„œëª… ê°œìˆ˜: ${signatureItems.length}`);

      // ë„ì¥ ì¶”ê°€
      for (const { x, y, image } of stampItems) {
        // ì´ë¯¸ì§€ë¥¼ PDFì— ì„ë² ë“œ
        const stampImage = await pdfDocLib.embedPng(image);
        
        // ì¢Œí‘œ ë³€í™˜ (PDF ì¢Œí‘œê³„ëŠ” ì™¼ìª½ í•˜ë‹¨ì´ ì›ì )
        const scale = 1.5; // PDF.jsì˜ renderPageì—ì„œ ì‚¬ìš©ëœ ìŠ¤ì¼€ì¼ê³¼ ë§ì¶¤
        const pdfX = (x / scale);
        const pdfY = height - (y / scale);
        
        // ë„ì¥ í¬ê¸°
        const stampSize = 50;
        
        // ë„ì¥ ì¶”ê°€
        page.drawImage(stampImage, {
          x: pdfX - stampSize/2,
          y: pdfY - stampSize/2,
          width: stampSize,
          height: stampSize
        });
      }

      // ì„œëª… ì¶”ê°€
      for (const { x, y, image } of signatureItems) {
        // ì´ë¯¸ì§€ë¥¼ PDFì— ì„ë² ë“œ
        const signImage = await pdfDocLib.embedPng(image);
        
        // ì¢Œí‘œ ë³€í™˜
        const scale = 1.5;
        const pdfX = (x / scale);
        const pdfY = height - (y / scale);
        
        // ì„œëª… í¬ê¸°
        const signWidth = 100;
        const signHeight = 50;
        
        // ì„œëª… ì¶”ê°€
        page.drawImage(signImage, {
          x: pdfX - signWidth/2,
          y: pdfY - signHeight/2,
          width: signWidth,
          height: signHeight
        });
      }
    }

    // PDF ì €ì¥
    const pdfBytes = await pdfDocLib.save();
    const blob = new Blob([pdfBytes], { type: "application/pdf" });
    
    // í˜„ì¬ ë‚ ì§œì™€ ì‹œê°„ì„ íŒŒì¼ëª…ì— ì¶”ê°€
    const now = new Date();
    const timestamp = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}`;
    const fileName = `ìƒë‹´ë¬¸ì„œ_${timestamp}.pdf`;
    
    // ë¡œì»¬ ë‹¤ìš´ë¡œë“œ (ì´ë©”ì¼ ì „ì†¡ì´ ì•„ë‹Œ ê²½ìš°)
    if (!forEmail) {
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = fileName;
      link.click();
      console.log("PDF ì €ì¥ ì™„ë£Œ");
      return null;
    } else {
      // ì´ë©”ì¼ ì „ì†¡ì„ ìœ„í•´ Base64 ì¸ì½”ë”©ëœ ë°ì´í„° ë°˜í™˜
      console.log("ì´ë©”ì¼ ì „ì†¡ìš© PDF ìƒì„± ì™„ë£Œ");
      return await blobToBase64(blob);
    }
  } catch (error) {
    console.error("PDF ì €ì¥ ì˜¤ë¥˜:", error);
    if (!forEmail) {
      alert("PDF ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
    } else {
      showToast("PDF ìƒì„± ì‹¤íŒ¨", "PDF ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message, "error");
  }
    throw error;
  }
}

// í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í•¨ìˆ˜
// í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ì¤‘ë³µ ë°©ì§€ ê°ì²´
const toastTracker = {
  active: {}, // í˜„ì¬ í‘œì‹œ ì¤‘ì¸ í† ìŠ¤íŠ¸ ì¶”ì 
  lastShown: {}, // ê° ìœ í˜•ë³„ ë§ˆì§€ë§‰ í‘œì‹œ ì‹œê°„
  
  // ë™ì¼í•œ í† ìŠ¤íŠ¸ê°€ ì´ë¯¸ í‘œì‹œ ì¤‘ì¸ì§€ í™•ì¸
  isDuplicate: function(type, title) {
    const key = `${type}_${title}`;
    return !!this.active[key];
  },
  
  // í† ìŠ¤íŠ¸ ë“±ë¡
  register: function(type, title, toastElement) {
    const key = `${type}_${title}`;
    this.active[key] = toastElement;
    this.lastShown[key] = Date.now();
  },
  
  // í† ìŠ¤íŠ¸ ì‚­ì œ
  remove: function(type, title) {
    const key = `${type}_${title}`;
    delete this.active[key];
  },
  
  // ë„ˆë¬´ ì§§ì€ ì‹œê°„ ë‚´ì— ê°™ì€ ë©”ì‹œì§€ê°€ ë°˜ë³µë˜ëŠ”ì§€ í™•ì¸
  isTooFrequent: function(type, title) {
    const key = `${type}_${title}`;
    const lastTime = this.lastShown[key];
    return lastTime && (Date.now() - lastTime < 3000); // 3ì´ˆ ì´ë‚´ ë™ì¼ ë©”ì‹œì§€ ë°©ì§€
  }
};

function showToast(title, message, type = 'success') {
  // ì¤‘ë³µ ë©”ì‹œì§€ ë°©ì§€
  if (toastTracker.isDuplicate(type, title) || toastTracker.isTooFrequent(type, title)) {
    console.log(`ì¤‘ë³µ í† ìŠ¤íŠ¸ ë°©ì§€: [${type}] ${title}`);
    return;
  }

  const toastContainer = document.getElementById('toastContainer');
  
  // í† ìŠ¤íŠ¸ ìš”ì†Œ ìƒì„±
  const toast = document.createElement('div');
  toast.className = 'toast';
  
  // ë°°ê²½ìƒ‰ ì„¤ì •
  if (type === 'success') {
    toast.style.backgroundColor = '#4CAF50';
  } else if (type === 'info') {
    toast.style.backgroundColor = '#2196F3';
  } else if (type === 'warning') {
    toast.style.backgroundColor = '#ff9800';
  } else if (type === 'error') {
    toast.style.backgroundColor = '#f44336';
  }
  
  // í† ìŠ¤íŠ¸ ë‚´ìš© êµ¬ì„±
  const icon = document.createElement('div');
  icon.className = 'toast-icon';
  icon.innerHTML = type === 'success' ? 'âœ…' : 
                  type === 'info' ? 'â„¹ï¸' :
                  type === 'warning' ? 'âš ï¸' : 'âŒ';

  const content = document.createElement('div');
  content.className = 'toast-content';
  
  const titleEl = document.createElement('div');
  titleEl.className = 'toast-title';
  titleEl.textContent = title;
  
  const messageEl = document.createElement('div');
  messageEl.className = 'toast-message';
  messageEl.textContent = message;
  
  content.appendChild(titleEl);
  content.appendChild(messageEl);
  
  const closeBtn = document.createElement('div');
  closeBtn.className = 'toast-close';
  closeBtn.innerHTML = '&times;';
  closeBtn.onclick = function() {
    toast.remove();
    toastTracker.remove(type, title);
  };
  
  toast.appendChild(icon);
  toast.appendChild(content);
  toast.appendChild(closeBtn);
  
  // í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆì— ì¶”ê°€
  toastContainer.appendChild(toast);
  
  // í† ìŠ¤íŠ¸ ì¶”ì ì— ë“±ë¡
  toastTracker.register(type, title, toast);
  
  // ì• ë‹ˆë©”ì´ì…˜ í‘œì‹œ
  setTimeout(() => {
    toast.classList.add('show');
  }, 10);
  
  // 5ì´ˆ í›„ ì‚¬ë¼ì§
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => {
      toast.remove();
      toastTracker.remove(type, title);
    }, 300);
  }, 5000);
}

// ì‚¬ìš©ì ì…ì¥ ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
function sendUserJoinMessage() {
  // ì„¸ì…˜ì—ì„œ í•„ìš”í•œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
  const role = sessionStorage.getItem("role");
  const entryType = sessionStorage.getItem("entryType") || "default";
  
  // WebSocketì´ ì—°ê²°ëœ ìƒíƒœì¸ì§€ í™•ì¸
  if (stompClient && stompClient.connected) {
    stompClient.send("/app/sync/userJoin", {}, JSON.stringify({
      userType: role,
      entryType: entryType,
      sessionId: sessionId
    }));
    
    // ê³ ê°ì´ ì…ì¥í•œ ê²½ìš°, ìƒë‹´ì›ì—ê²Œ í˜„ì¬ í˜ì´ì§€ ì •ë³´ ìš”ì²­
    if (role === "client") {
      console.log("ê³ ê° ì…ì¥: ìƒë‹´ì›ì—ê²Œ í˜„ì¬ í˜ì´ì§€ ì •ë³´ ìš”ì²­");
      requestCurrentPageFromConsultant();
    }
  } else {
    // WebSocketì´ ì•„ì§ ì—°ê²°ë˜ì§€ ì•Šì•˜ë‹¤ë©´, ì—°ê²° í›„ ë©”ì‹œì§€ ì „ì†¡ì„ ìœ„í•œ ì½œë°± ì„¤ì •
    console.log("WebSocket ì—°ê²° ëŒ€ê¸° ì¤‘, ì—°ê²° í›„ ì‚¬ìš©ì ì…ì¥ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤.");
    
    // 1ì´ˆ í›„ ë‹¤ì‹œ ì‹œë„
    setTimeout(() => {
      if (stompClient && stompClient.connected) {
        stompClient.send("/app/sync/userJoin", {}, JSON.stringify({
          userType: role,
          entryType: entryType,
          sessionId: sessionId
        }));
        
        // ê³ ê°ì´ ì…ì¥í•œ ê²½ìš°, ìƒë‹´ì›ì—ê²Œ í˜„ì¬ í˜ì´ì§€ ì •ë³´ ìš”ì²­
        if (role === "client") {
          requestCurrentPageFromConsultant();
        }
      }
    }, 1000);
  }
}

// ìƒë‹´ì›ì—ê²Œ í˜„ì¬ í˜ì´ì§€ ì •ë³´ ìš”ì²­
function requestCurrentPageFromConsultant() {
  if (stompClient && stompClient.connected) {
    stompClient.send("/app/sync/requestCurrentPage", {}, JSON.stringify({
      sessionId: sessionId,
      requesterId: "client_" + Date.now()
    }));
    console.log("ìƒë‹´ì›ì—ê²Œ í˜„ì¬ í˜ì´ì§€ ì •ë³´ ìš”ì²­ ì „ì†¡");
  }
}

// ìƒë‹´ ì™„ë£Œ ëª¨ë‹¬ í‘œì‹œ/ìˆ¨ê¹€ í•¨ìˆ˜
function showCompleteModal() {
  console.log("ìƒë‹´ ì™„ë£Œ ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜ í˜¸ì¶œë¨");
  const completeModal = document.getElementById('completeModal');
  
  if (!completeModal) {
    console.error("completeModal ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
    return;
  }
  
  // ëª¨ë‹¬ ìŠ¤íƒ€ì¼ í™•ì¸ ë° ìˆ˜ì •
  completeModal.style.display = 'block';
  completeModal.style.zIndex = '9999'; // ìµœìƒìœ„ ë ˆì´ì–´ë¡œ ì„¤ì •
  
  // ë°°ê²½ì„ ì–´ë‘¡ê²Œ í•˜ëŠ” ì˜¤ë²„ë ˆì´ ì¶”ê°€
  let overlay = document.getElementById('modalOverlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'modalOverlay';
    overlay.style.position = 'fixed';
    overlay.style.top = '0';
    overlay.style.left = '0';
    overlay.style.width = '100%';
    overlay.style.height = '100%';
    overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
    overlay.style.zIndex = '9998';
    document.body.appendChild(overlay);
  } else {
    overlay.style.display = 'block';
  }
  
  // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ ì¶”ê°€
  completeModal.style.opacity = '0';
  setTimeout(() => {
    completeModal.style.transition = 'opacity 0.3s ease-in-out';
    completeModal.style.opacity = '1';
  }, 50);
  
  // í™•ì¸ ë¡œê·¸
  console.log("ìƒë‹´ ì™„ë£Œ ëª¨ë‹¬ì´ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.");
  
  // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ë°©ì§€
  overlay.onclick = (e) => {
    e.stopPropagation();
    // ì™¸ë¶€ í´ë¦­í•´ë„ ëª¨ë‹¬ì€ ë‹«íˆì§€ ì•ŠìŒ
  };
  
  // ë’¤ë¡œê°€ê¸° ë°©ì§€
  window.history.pushState(null, "", window.location.href);
  window.onpopstate = function() {
    window.history.pushState(null, "", window.location.href);
  };
  
  // ëª¨ë‹¬ì´ ì•ˆ ë³´ì´ëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ 3ì´ˆ í›„ ë‹¤ì‹œ í•œë²ˆ í‘œì‹œ ì‹œë„
  setTimeout(() => {
    if (completeModal.style.display !== 'block' || parseFloat(completeModal.style.opacity) < 1) {
      console.log("ëª¨ë‹¬ ì¬í‘œì‹œ ì‹œë„");
      completeModal.style.display = 'block';
      completeModal.style.opacity = '1';
      completeModal.style.zIndex = '9999';
      
      if (overlay) {
        overlay.style.display = 'block';
      }
    }
  }, 3000);
}

function closeCompleteModal() {
  document.getElementById('completeModal').style.display = 'none';
}

// ì´ˆê¸° í™”ë©´ìœ¼ë¡œ ì´ë™ í•¨ìˆ˜
function goToHomePage() {
  // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œ í˜ì´ì§€ ì •ë³´ ì‚­ì œ
  sessionStorage.removeItem("lastPage");
  sessionStorage.removeItem("lastSyncedPage");
  // ìƒë‹´ ì¢…ë£Œ í”Œë˜ê·¸ ì„¤ì •
  sessionStorage.setItem("consultClosed", "true");
  
  // í˜„ì¬ í˜ì´ì§€ ì´ˆê¸°í™”
  currentPage = 1;
  
  // ì„¸ì…˜ì— ì €ì¥ëœ ë¦¬ë‹¤ì´ë ‰íŠ¸ URLì´ ìˆìœ¼ë©´ ê·¸ URLë¡œ, ì—†ìœ¼ë©´ ê¸°ë³¸ URLë¡œ ì´ë™
  const redirectUrl = sessionStorage.getItem("redirectUrl") || "/main-page";
  console.log("ì´ˆê¸° í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤:", redirectUrl);
  
  // ì‚¬ìš© í›„ ë¦¬ë‹¤ì´ë ‰íŠ¸ URL ì‚­ì œ
  sessionStorage.removeItem("redirectUrl");
  
  // ì§€ì •ëœ í˜ì´ì§€ë¡œ ì´ë™
  location.href = redirectUrl;
}

// Blobì„ Base64 ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ëŠ” ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
function blobToBase64(blob) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => {
      // data:application/pdf;base64, ë¶€ë¶„ì„ ì œê±°í•˜ê³  Base64 ë¬¸ìì—´ë§Œ ë°˜í™˜
      const base64String = reader.result.split(',')[1];
      resolve(base64String);
    };
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
}

// PDF ê³µìœ  ê´€ë ¨ í•¨ìˆ˜ë“¤
function requestPdfFromAgent() {
  if (stompClient && stompClient.connected) {
    console.log("ìƒë‹´ì›ì—ê²Œ PDF ìš”ì²­ ë©”ì‹œì§€ ì „ì†¡");
    stompClient.send("/app/sync/requestPdf", {}, JSON.stringify({
      sessionId: sessionId,
      requesterId: "client_" + Date.now()
    }));
    
    // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
    showToast("PDF ìš”ì²­", "ìƒë‹´ì›ì—ê²Œ PDF ë¬¸ì„œë¥¼ ìš”ì²­í–ˆìŠµë‹ˆë‹¤.", "info");
  } else {
    console.error("WebSocket ì—°ê²°ì´ ë˜ì–´ ìˆì§€ ì•Šì•„ PDF ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    
    // 5ì´ˆ í›„ì— ë‹¤ì‹œ ì‹œë„
    setTimeout(() => {
      if (stompClient && stompClient.connected) {
        requestPdfFromAgent();
      }
    }, 5000);
  }
}

// ìƒë‹´ì›ì´ PDF ìš”ì²­ì„ ë°›ì•˜ì„ ë•Œ PDF ê³µìœ  í•¨ìˆ˜
function sharePdfToClient(requesterId) {
  if (!uploadedPdfUrl) {
    console.log("ê³µìœ í•  PDFê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  
  if (stompClient && stompClient.connected) {
    console.log("ê³ ê°ì—ê²Œ PDF ê³µìœ :", uploadedPdfUrl);
    // í˜„ì¬ PDF íŒŒì¼ ë‹¤ì‹œ ê³µìœ 
    sendPdfPathSync(uploadedPdfUrl);
    
    // í˜„ì¬ í˜ì´ì§€ ì •ë³´ë„ ê³µìœ 
    sendPageSync(currentPage);
  }
}

// í˜ì´ì§€ ë¡œë”© ì™„ë£Œ í›„ 5ì´ˆ ê°„ê²©ìœ¼ë¡œ PDF ì¡´ì¬ í™•ì¸ ë° ìë™ ìš”ì²­
window.addEventListener('load', function() {
  if (userRole === "client") {
    // 5ì´ˆë§ˆë‹¤ PDFê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
    const pdfCheckInterval = setInterval(() => {
      if (!pdfDoc && stompClient && stompClient.connected) {
        console.log("PDFê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•ŠìŒ, ìš”ì²­ ì‹œë„");
        requestPdfFromAgent();
      } else if (pdfDoc) {
        // PDFê°€ ë¡œë“œë˜ë©´ ì¸í„°ë²Œ ì¤‘ì§€
        clearInterval(pdfCheckInterval);
        console.log("PDFê°€ ë¡œë“œë˜ì–´ ìë™ ìš”ì²­ì„ ì¤‘ì§€í•©ë‹ˆë‹¤.");
      }
    }, 5000);
  }
  
  // ê³ ê°ê³¼ ìƒë‹´ì› ëª¨ë‘ ìë™ ì €ì¥ ì‹œì‘
  setTimeout(() => {
    if (stompClient && stompClient.connected) {
      startAutoSave();
    }
  }, 2000);
});

// ì €ì¥ëœ í˜ì´ì§€ ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
function fetchSavedPageNumber(callback) {
  if (!sessionId) {
    callback(1);
    return;
  }
  
  // ìƒë‹´ì´ ìƒˆë¡œ ì‹œì‘ëœ ê²½ìš° í•­ìƒ 1í˜ì´ì§€ë¡œ ì‹œì‘
  const isConsultClosed = sessionStorage.getItem("consultClosed");
  if (isConsultClosed === "true") {
    console.log("ìƒë‹´ì´ ì¢…ë£Œëœ í›„ ìƒˆë¡œ ì‹œì‘ë˜ì–´ 1í˜ì´ì§€ë¡œ ì„¤ì •");
    sessionStorage.removeItem("consultClosed");
    callback(1);
    return;
  }
  
  fetch(`/api/contract-data/${sessionId}`)
    .then(response => response.json())
    .then(data => {
      if (data.success === false || !data.currentPage) {
        callback(1);
        return;
      }
      
      console.log("ì €ì¥ëœ í˜ì´ì§€ ë²ˆí˜¸ ê°€ì ¸ì˜´:", data.currentPage);
      callback(data.currentPage);
    })
    .catch(error => {
      console.error("í˜ì´ì§€ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error);
      callback(1);
    });
}

// WebSocket ì—°ê²° ìƒíƒœ í™•ì¸ ë° ì¬ì—°ê²°
function checkAndReconnectWebSocket() {
  console.log("WebSocket ì—°ê²° ìƒíƒœ í™•ì¸");
  
  if (!stompClient || !stompClient.connected) {
    console.log("WebSocketì´ ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŒ, ì¬ì—°ê²° ì‹œë„");
    
    // ì—°ê²° ì‹œë„
    connectWebSocket();
    
    // 2ì´ˆ í›„ ì—°ê²° ìƒíƒœ ë‹¤ì‹œ í™•ì¸
    setTimeout(() => {
      if (stompClient && stompClient.connected) {
        console.log("WebSocket ì¬ì—°ê²° ì„±ê³µ");
        
        // ì¬ì—°ê²° í›„ ì„¸ì…˜ ë°ì´í„° ë¡œë“œ
        if (sessionId && !window.dataLoaded) {
          console.log("ì¬ì—°ê²° í›„ ì„¸ì…˜ ë°ì´í„° ë¡œë“œ ì‹œë„");
          loadSessionData(true);
        }
        
        // ì‚¬ìš©ì ì…ì¥ ë©”ì‹œì§€ ì¬ì „ì†¡
        sendUserJoinMessage();
      } else {
        console.error("WebSocket ì¬ì—°ê²° ì‹¤íŒ¨, 3ì´ˆ í›„ ì¬ì‹œë„");
        setTimeout(checkAndReconnectWebSocket, 3000);
      }
    }, 2000);
  } else {
    console.log("WebSocketì´ ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìŒ");
  }
}

function exitRoom() {
  if (confirm("ìƒë‹´ë°©ì—ì„œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ? ì €ì¥í•˜ì§€ ì•Šì€ ë‚´ìš©ì€ ëª¨ë‘ ì‚¬ë¼ì§‘ë‹ˆë‹¤.")) {
    // ì†Œì¼“ ì—°ê²° ì¢…ë£Œ
    disconnectWebSocket();
    
    // ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
    location.href = "/main-page";
  }
}

function handleOnlineStatusChange(isOnline) {
  if (isOnline) {
    // ìƒë‹´ì›ì´ ì°¸ì—¬ ì¤‘ì¸ ê²½ìš°
    if (isAgent) {
      showToast("ê³ ê°ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤.");
      document.getElementById("statusArea").textContent = "ê³ ê°ì´ ì°¸ì—¬í•˜ê³  ìˆìŠµë‹ˆë‹¤. ìƒë‹´ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.";
    } else {
      showToast("ìƒë‹´ì›ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤.");
      document.getElementById("statusArea").textContent = "ìƒë‹´ì›ì´ ì°¸ì—¬í•˜ê³  ìˆìŠµë‹ˆë‹¤. ìƒë‹´ì„ ì‹œì‘í•©ë‹ˆë‹¤.";
    }
  } else {
    // ìƒëŒ€ë°©ì´ ë‚˜ê°„ ê²½ìš°
    if (isAgent) {
      alert("ê³ ê°ì´ ìƒë‹´ë°©ì„ ë‚˜ê°”ìŠµë‹ˆë‹¤. ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
      disconnectWebSocket();
      location.href = "/main-page";
    } else {
      alert("ìƒë‹´ì›ì´ ìƒë‹´ë°©ì„ ë‚˜ê°”ìŠµë‹ˆë‹¤. ëŒ€ê¸°ì‹¤ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
      disconnectWebSocket();
      location.href = "/waiting-room";
    }
  }
}

// ì™„ë£Œ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
function completeConsultation() {
  if (confirm("ìƒë‹´ì„ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
    // ì™„ë£Œ ë©”ì‹œì§€ ì „ì†¡
    sendWebSocketMessage("ì™„ë£Œ", "COMPLETE");
    
    // ëª¨ë‹¬ í‘œì‹œ (í•„ìš”ì‹œ)
    document.getElementById("completeModal").style.display = "block";
  }
}

// í™•ì¸ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
function confirmComplete() {
  document.getElementById("completeModal").style.display = "none";
  disconnectWebSocket();
  location.href = "/main-page";
}
</script>

</body>
</html>

