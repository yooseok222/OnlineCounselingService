<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê³ ê° ìƒë‹´ë°©</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- CSRF í† í°ì„ ìœ„í•œ ë©”íƒ€ íƒœê·¸ ì¶”ê°€ -->
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <!-- ë¶„ë¦¬ëœ CSS íŒŒì¼ ì°¸ì¡° -->
  <link rel="stylesheet" href="/css/contract/contractRoom.css">
  <style>
    /* ë„ì¥/ì„œëª… ê´€ë ¨ ì¶”ê°€ ìŠ¤íƒ€ì¼ */
    .stamp-popup, .signature-popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      z-index: 1000;
      width: 450px;
      max-height: 600px;
      overflow-y: auto;
    }
    
    .stamp-popup h4, .signature-popup h4 {
      margin-top: 0;
      color: #0064E1;
      margin-bottom: 15px;
    }
    
    .stamp-upload {
      margin-bottom: 15px;
    }
    
    .stamp-preview, .signature-canvas-container {
      margin-bottom: 15px;
      border: 1px solid #ddd;
      padding: 10px;
      height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .stamp-preview img {
      max-width: 100%;
      max-height: 100%;
    }
    
    .popup-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .popup-buttons button {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .popup-buttons button:first-child {
      background-color: #0064E1;
      color: white;
    }
    
    .popup-buttons button:last-child {
      background-color: #f1f3f5;
      color: #495057;
    }
    
    #signatureCanvas {
      border: 1px solid #ddd;
      background-color: #fff;
    }
    
    .clear-btn {
      background-color: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 5px 10px;
      margin-top: 10px;
      cursor: pointer;
    }
    
    /* ë„ì¥ íƒ­ ìŠ¤íƒ€ì¼ */
    .stamp-tabs {
      display: flex;
      margin-bottom: 15px;
      border-bottom: 1px solid #ddd;
    }
    
    .stamp-tab {
      flex: 1;
      padding: 8px 12px;
      border: none;
      background: none;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s ease;
    }
    
    .stamp-tab.active {
      color: #0064E1;
      border-bottom-color: #0064E1;
      font-weight: bold;
    }
    
    .stamp-tab:hover {
      background-color: #f8f9fa;
    }
    
    .stamp-tab-content {
      display: none;
      min-height: 200px;
    }
    
    .stamp-tab-content.active {
      display: block;
    }
    
    /* ì—…ë¡œë“œëœ ë„ì¥ ëª©ë¡ ìŠ¤íƒ€ì¼ */
    .uploaded-stamps-list {
      max-height: 250px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 10px;
    }
    
    .uploaded-stamp-item {
      display: flex;
      align-items: center;
      padding: 8px;
      border: 1px solid #eee;
      border-radius: 5px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .uploaded-stamp-item:hover {
      background-color: #f8f9fa;
      border-color: #0064E1;
    }
    
    .uploaded-stamp-item.selected {
      background-color: #e3f2fd;
      border-color: #0064E1;
    }
    
    .uploaded-stamp-image {
      width: 40px;
      height: 40px;
      object-fit: contain;
      border: 1px solid #ddd;
      border-radius: 3px;
      margin-right: 10px;
    }
    
    .uploaded-stamp-info {
      flex: 1;
    }
    
    .uploaded-stamp-date {
      font-size: 0.8em;
      color: #666;
    }
    
    .manage-stamps-btn {
      display: inline-block;
      padding: 6px 12px;
      background-color: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-decoration: none;
      color: #495057;
      font-size: 0.9em;
      transition: all 0.2s ease;
    }
    
    .manage-stamps-btn:hover {
      background-color: #e9ecef;
      text-decoration: none;
      color: #495057;
    }
    
    /* ê¸°ë³¸ ë„ì¥ ìŠ¤íƒ€ì¼ */
    .default-stamps {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .default-stamp-btn {
      flex: 1;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background: white;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }
    
    .default-stamp-btn:hover {
      background-color: #f8f9fa;
      border-color: #0064E1;
    }
    
    .default-stamp-btn.selected {
      background-color: #e3f2fd;
      border-color: #0064E1;
    }
    
    .upload-hint {
      font-size: 0.9em;
      color: #666;
      margin-top: 5px;
    }
    
    .loading-text {
      text-align: center;
      color: #666;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="header">
    <h3><i class="fas fa-comments"></i> ì˜¨ë¼ì¸ ìƒë‹´ (ê³ ê°)</h3>
    <div id="userRoleDisplay"></div>
  </div>
  
  <div class="container">
    <div class="toolbar">
      <div class="toolbar-group">
        <button id="cursorBtn" class="tool-btn active" onclick="setCursor()"><i class="fas fa-mouse-pointer"></i> ì»¤ì„œ</button>
        <button id="penBtn" class="tool-btn" onclick="setPen()"><i class="fas fa-pen"></i> íœ</button>
        <button id="highlighterBtn" class="tool-btn" onclick="setHighlighter()"><i class="fas fa-highlighter"></i> í˜•ê´‘íœ</button>
      </div>
      <div class="toolbar-group">
        <button id="textBtn" class="tool-btn" onclick="openTextPopup()"><i class="fas fa-font"></i> í…ìŠ¤íŠ¸</button>
        <button id="stampBtn" class="tool-btn" onclick="handleStampButtonClick()" style="display: none;"><i class="fas fa-stamp"></i> ë„ì¥</button>
        <button id="signatureBtn" class="tool-btn" onclick="handleSignatureButtonClick()" style="display: none;"><i class="fas fa-signature"></i> ì„œëª…</button>
      </div>
    </div>
    
    <div class="status-area">
      <i class="fas fa-info-circle"></i>
      <span>í˜„ì¬ ëª¨ë“œ: <span id="currentMode">ì»¤ì„œ</span></span>
    </div>
    
    <div class="content-wrapper">
      <div id="scrollWrapper">
        <div class="scroll-sync-indicator" id="scrollSyncIndicator">
          <i class="fas fa-sync-alt"></i> ìŠ¤í¬ë¡¤ ë™ê¸°í™” ì¤‘
        </div>
        <canvas id="pdfCanvas"></canvas>
        <canvas id="drawingCanvas"></canvas>
      </div>
      
      <div class="video-container">
        <div id="localVideoContainer" class="video-wrapper">
          <h4>ë‚´ í™”ë©´</h4>
          <video id="localVideo" autoplay playsinline muted></video>
          <div id="localVideoStatus" class="video-status">ì—°ê²° ì¤‘...</div>
          <div class="media-controls">
            <button id="toggleMicBtn" class="media-btn mic-on" onclick="toggleMicrophone()" title="ë§ˆì´í¬ ë„ê¸°">
              <i class="fas fa-microphone"></i>
            </button>
            <button id="toggleCameraBtn" class="media-btn camera-on" onclick="toggleCamera()" title="ì¹´ë©”ë¼ ë„ê¸°">
              <i class="fas fa-video"></i>
            </button>
          </div>
        </div>
        <div id="remoteVideoContainer" class="video-wrapper">
          <h4>ìƒë‹´ì› í™”ë©´</h4>
          <video id="remoteVideo" autoplay playsinline></video>
          <div id="remoteVideoStatus" class="video-status">ì—°ê²° ëŒ€ê¸° ì¤‘...</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- í…ìŠ¤íŠ¸ ì…ë ¥ íŒì—… -->
  <div id="textPopup">
    <h4><i class="fas fa-font"></i> í…ìŠ¤íŠ¸ ì…ë ¥</h4>
    <input type="text" id="textInput" placeholder="ì…ë ¥í•  í…ìŠ¤íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”" autofocus>
    <div>
      <button onclick="confirmText()"><i class="fas fa-check"></i> í™•ì¸</button>
      <button onclick="closeTextPopup()"><i class="fas fa-times"></i> ì·¨ì†Œ</button>
    </div>
  </div>
  
  <!-- ë„ì¥ ì—…ë¡œë“œ íŒì—… -->
  <div id="stampPopup" class="stamp-popup">
    <h4><i class="fas fa-stamp"></i> ë„ì¥ ì‚½ì…</h4>
    
    <!-- íƒ­ ë©”ë‰´ -->
    <div class="stamp-tabs">
      <button class="stamp-tab active" onclick="switchStampTab('uploaded')">ë„ì¥</button>
      <button class="stamp-tab" onclick="switchStampTab('upload')">ìƒˆ ì—…ë¡œë“œ</button>
      <button class="stamp-tab" onclick="switchStampTab('default')">ê¸°ë³¸ ë„ì¥</button>
    </div>
    
    <!-- ì—…ë¡œë“œëœ ë„ì¥ ëª©ë¡ -->
    <div id="uploadedStampsTab" class="stamp-tab-content active">
      <div class="uploaded-stamps-container">
        <div id="uploadedStampsList" class="uploaded-stamps-list">
          <p class="loading-text">ë„ì¥ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
        <div class="stamp-actions">
          <a href="/stamp/upload" target="_blank" class="manage-stamps-btn">
            <i class="fas fa-cog"></i> ë„ì¥ ê´€ë¦¬
          </a>
        </div>
      </div>
    </div>
    
    <!-- ìƒˆ ë„ì¥ ì—…ë¡œë“œ -->
    <div id="uploadStampTab" class="stamp-tab-content">
      <div class="stamp-upload">
        <input type="file" id="stampUpload" accept="image/*" onchange="previewStamp(this)">
        <p class="upload-hint">ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš” (PNG, JPG)</p>
      </div>
    </div>
    
    <!-- ê¸°ë³¸ ë„ì¥ -->
    <div id="defaultStampTab" class="stamp-tab-content">
      <div class="default-stamps">
        <button onclick="selectDefaultStamp('round')" class="default-stamp-btn">
          <i class="fas fa-circle"></i> ë‘¥ê·¼ ë„ì¥
        </button>
        <button onclick="selectDefaultStamp('square')" class="default-stamp-btn">
          <i class="fas fa-square"></i> ê°ì¸ ë„ì¥
        </button>
      </div>
    </div>
    
    <div class="stamp-preview" id="stampPreview">
      <p>ë„ì¥ ë¯¸ë¦¬ë³´ê¸°</p>
    </div>
    <div class="popup-buttons">
      <button onclick="confirmStamp()">í™•ì¸</button>
      <button onclick="closeStampPopup()">ì·¨ì†Œ</button>
    </div>
  </div>
  
  <!-- ì„œëª… íŒì—… -->
  <div id="signaturePopup" class="signature-popup">
    <h4><i class="fas fa-signature"></i> ì„œëª… ì…ë ¥</h4>
    
    <!-- ì„œëª… ì…ë ¥ ì˜ì—­ë§Œ í‘œì‹œ -->
    <div class="signature-input-area">
      <div class="signature-canvas-container">
        <canvas id="signatureCanvas" width="300" height="150"></canvas>
      </div>
      <button class="clear-btn" onclick="clearSignature()">ì§€ìš°ê¸°</button>
    </div>
    
    <div class="popup-buttons">
      <button onclick="confirmSignature()">í™•ì¸</button>
      <button onclick="closeSignaturePopup()">ì·¨ì†Œ</button>
    </div>
  </div>
  
  <!-- ë¶ˆí•„ìš”í•œ completeModal ì œê±° -->
  
  <div id="toastContainer"></div>
  
  <!-- ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ -->
  <script th:inline="javascript">
    let drawingDataPerPage = {};
    let stampDataPerPage = {};
    let textDataPerPage = {};
    let signatureDataPerPage = {};
    
    let pdfDoc = null;
    let currentPage = 1;
    let renderTask = null;
    let stompClient = null;
    let mode = null; // 'pen' | 'highlight' | null
    let drawing = false;
    let pendingText = null;
    let uploadedPdfUrl = null;
    let userRole = 'client'; // ê³ ì •ê°’ìœ¼ë¡œ 'client' ì„¤ì •
    let sessionId = null; // ìƒë‹´ ì„¸ì…˜ ID ì¶”ê°€
    let customStampImage = null; // ì‚¬ìš©ì ì •ì˜ ë„ì¥ ì´ë¯¸ì§€
    let signatureCanvas = null; // ì„œëª… ìº”ë²„ìŠ¤
    let signatureContext = null; // ì„œëª… ìº”ë²„ìŠ¤ ì»¨í…ìŠ¤íŠ¸
    
    // ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ entryType ì •ë³´
    const serverEntryType = /*[[${entryType}]]*/ null;
    const serverStampImage = /*[[${stampImage}]]*/ null;
    const serverSignatureImage = /*[[${signatureImage}]]*/ null;
    
    console.log('ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ entryType:', serverEntryType);
    console.log('ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ stampImage:', serverStampImage ? serverStampImage.substring(0, 50) + '...' : 'null');
    console.log('ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ signatureImage:', serverSignatureImage ? serverSignatureImage.substring(0, 50) + '...' : 'null');
    
    // main.jsì—ì„œ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ì „ì—­ ë³€ìˆ˜ë¡œ ì„¤ì •
    window.serverEntryType = serverEntryType;
    window.serverStampImage = serverStampImage;
    window.serverSignatureImage = serverSignatureImage;
    
    // ì´ë¯¸ì§€ ë°ì´í„° í¬ê¸° ìµœì í™” í•¨ìˆ˜
    function optimizeImageData(imageData, maxWidth = 400, maxHeight = 300, quality = 0.7) {
      return new Promise((resolve, reject) => {
        try {
          const img = new Image();
          img.onload = function() {
            let width = img.width;
            let height = img.height;
            
            // ì´ë¯¸ì§€ í¬ê¸° ë¹„ìœ¨ ìœ ì§€í•˜ë©´ì„œ ì¶•ì†Œ
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }
            if (height > maxHeight) {
              width = (width * maxHeight) / height;
              height = maxHeight;
            }
            
            // ìº”ë²„ìŠ¤ì— ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            
            // ìº”ë²„ìŠ¤ ì´ˆê¸°í™” (íˆ¬ëª…í•˜ê²Œ)
            ctx.clearRect(0, 0, width, height);
            
            // ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
            ctx.drawImage(img, 0, 0, width, height);
            
            // íˆ¬ëª…ë„ ìœ ì§€ë¥¼ ìœ„í•´ PNG í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            const optimizedImageData = canvas.toDataURL('image/png');
            console.log(`ì´ë¯¸ì§€ ìµœì í™”: ${imageData.length} -> ${optimizedImageData.length} ë°”ì´íŠ¸`);
            resolve(optimizedImageData);
          };
          img.onerror = function() {
            console.error('ì´ë¯¸ì§€ ìµœì í™” ì‹¤íŒ¨');
            resolve(imageData); // ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë°˜í™˜
          };
          img.src = imageData;
        } catch (error) {
          console.error('ì´ë¯¸ì§€ ìµœì í™” ì˜¤ë¥˜:', error);
          resolve(imageData); // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì›ë³¸ ë°˜í™˜
        }
      });
    }
  </script>
  
  <!-- ë¶„ë¦¬ëœ JS íŒŒì¼ ì°¸ì¡° -->
  <script src="/js/contract/ui.js"></script>
  <script src="/js/contract/pdfViewer.js"></script>
  <script src="/js/contract/drawing.js"></script>
  <script src="/js/contract/websocket.js"></script>
  <script src="/js/contract/chat-ui.js"></script>
  <script src="/js/contract/webRTC.js"></script>
  <script src="/js/contract/main.js"></script>
  
  <!-- ë„ì¥ ë° ì„œëª… ê´€ë ¨ ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„œëª… ìº”ë²„ìŠ¤ ì´ˆê¸°í™” ë° ì…ì¥ ë°©ì‹ì— ë”°ë¥¸ UI ì„¤ì •
    document.addEventListener('DOMContentLoaded', function() {
      signatureCanvas = document.getElementById('signatureCanvas');
      signatureContext = signatureCanvas.getContext('2d');
      
      // ì„œëª… ìº”ë²„ìŠ¤ ì´ë²¤íŠ¸ ì„¤ì •
      initSignatureCanvas();
      
      // ì…ì¥ ë°©ì‹ì— ë”°ë¥¸ UI ì„¤ì •
      setupUIByEntryType();
    });
    
    // ì…ì¥ ë°©ì‹ì— ë”°ë¥¸ UI ì„¤ì •
    function setupUIByEntryType() {
      // ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ entryTypeì„ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ sessionStorageì—ì„œ ê°€ì ¸ì˜¤ê¸°
      const entryType = serverEntryType || sessionStorage.getItem('entryType');
      const stampBtn = document.getElementById('stampBtn');
      const signatureBtn = document.getElementById('signatureBtn');
      
      console.log('=== setupUIByEntryType ì‹œì‘ ===');
      console.log('ì…ì¥ ë°©ì‹ í™•ì¸:', entryType);
      console.log('ì„œë²„ entryType:', serverEntryType);
      console.log('ì„¸ì…˜ entryType:', sessionStorage.getItem('entryType'));
      console.log('ë„ì¥ ë²„íŠ¼ ìš”ì†Œ:', stampBtn);
      console.log('ì„œëª… ë²„íŠ¼ ìš”ì†Œ:', signatureBtn);
      
      if (entryType === 'stamp') {
        // ë„ì¥ìœ¼ë¡œ ì…ì¥í•œ ê²½ìš° - ë„ì¥ ë²„íŠ¼ë§Œ í‘œì‹œ
        if (stampBtn) {
          stampBtn.style.display = 'inline-block';
          console.log('ë„ì¥ ëª¨ë“œë¡œ ì„¤ì •ë¨ - ë„ì¥ ë²„íŠ¼ë§Œ í‘œì‹œ');
        }
        if (signatureBtn) {
          signatureBtn.style.display = 'none';
        }
        
        // ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ë„ì¥ ì´ë¯¸ì§€ë¥¼ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ ì„¸ì…˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°
        const entryStampImage = serverStampImage || sessionStorage.getItem('stampImage');
        console.log('ì‚¬ìš©í•  ë„ì¥ ì´ë¯¸ì§€ ì†ŒìŠ¤:', serverStampImage ? 'server' : 'sessionStorage');
        console.log('ë„ì¥ ì´ë¯¸ì§€ ë°ì´í„°:', entryStampImage ? entryStampImage.substring(0, 50) + '...' : 'null');
        
        if (entryStampImage) {
          customStampImage = new Image();
          customStampImage.onload = function() {
            console.log('âœ… ì…ì¥ ì‹œ ì‚¬ìš©í•œ ë„ì¥ ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ');
            console.log('customStampImage ì„¤ì •ë¨:', !!customStampImage);
          };
          customStampImage.onerror = function() {
            console.error('âŒ ë„ì¥ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨');
          };
          customStampImage.src = entryStampImage;
        } else {
          console.warn('âš ï¸  ë„ì¥ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤');
        }
        
      } else if (entryType === 'signature') {
        // ì„œëª…ìœ¼ë¡œ ì…ì¥í•œ ê²½ìš° - ì„œëª… ë²„íŠ¼ë§Œ í‘œì‹œ
        if (stampBtn) {
          stampBtn.style.display = 'none';
          console.log('ë„ì¥ ë²„íŠ¼ ìˆ¨ê¹€');
        }
        if (signatureBtn) {
          signatureBtn.style.display = 'inline-block';
          console.log('ì„œëª… ëª¨ë“œë¡œ ì„¤ì •ë¨ - ì„œëª… ë²„íŠ¼ë§Œ í‘œì‹œ');
        }
        
        // ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ì„œëª… ì´ë¯¸ì§€ë¥¼ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ ì„¸ì…˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°
        const entrySignatureImage = serverSignatureImage || sessionStorage.getItem('signatureImage');
        console.log('ì‚¬ìš©í•  ì„œëª… ì´ë¯¸ì§€ ì†ŒìŠ¤:', serverSignatureImage ? 'server' : 'sessionStorage');
        console.log('ì„œëª… ì´ë¯¸ì§€ ë°ì´í„°:', entrySignatureImage ? entrySignatureImage.substring(0, 50) + '...' : 'null');
        
        if (entrySignatureImage) {
          customStampImage = new Image();
          customStampImage.onload = function() {
            console.log('âœ… ì…ì¥ ì‹œ ì‚¬ìš©í•œ ì„œëª… ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ');
            console.log('customStampImage ì„¤ì •ë¨:', !!customStampImage);
          };
          customStampImage.onerror = function() {
            console.error('âŒ ì„œëª… ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨');
          };
          customStampImage.src = entrySignatureImage;
        } else {
          console.warn('âš ï¸  ì„œëª… ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤');
        }
        
      } else {
        // entryTypeì´ ì—†ëŠ” ê²½ìš° - ë„ì¥/ì„œëª… ë²„íŠ¼ ëª¨ë‘ ìˆ¨ê¹€ (ê¸°ì¡´ ì‚¬ìš©ì)
        if (stampBtn) {
          stampBtn.style.display = 'none';
        }
        if (signatureBtn) {
          signatureBtn.style.display = 'none';
        }
        console.log('ê¸°ë³¸ ëª¨ë“œë¡œ ì„¤ì •ë¨ - ë„ì¥/ì„œëª… ë²„íŠ¼ ëª¨ë‘ ìˆ¨ê¹€');
      }
      
      console.log('=== setupUIByEntryType ì™„ë£Œ ===');
    }
    
    // ì„œëª… ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
    function initSignatureCanvas() {
      let isDrawing = false;
      let lastX = 0;
      let lastY = 0;
      
      // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
      signatureCanvas.addEventListener('mousedown', startSignature);
      signatureCanvas.addEventListener('mousemove', drawSignature);
      signatureCanvas.addEventListener('mouseup', endSignature);
      signatureCanvas.addEventListener('mouseout', endSignature);
      
      // í„°ì¹˜ ì´ë²¤íŠ¸
      signatureCanvas.addEventListener('touchstart', function(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousedown', {
          clientX: touch.clientX,
          clientY: touch.clientY
        });
        signatureCanvas.dispatchEvent(mouseEvent);
      });
      
      signatureCanvas.addEventListener('touchmove', function(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousemove', {
          clientX: touch.clientX,
          clientY: touch.clientY
        });
        signatureCanvas.dispatchEvent(mouseEvent);
      });
      
      signatureCanvas.addEventListener('touchend', function(e) {
        e.preventDefault();
        const mouseEvent = new MouseEvent('mouseup', {});
        signatureCanvas.dispatchEvent(mouseEvent);
      });
      
      // ì„œëª… ì‹œì‘
      function startSignature(e) {
        isDrawing = true;
        const rect = signatureCanvas.getBoundingClientRect();
        lastX = e.clientX - rect.left;
        lastY = e.clientY - rect.top;
      }
      
      // ì„œëª… ê·¸ë¦¬ê¸°
      function drawSignature(e) {
        if (!isDrawing) return;
        
        const rect = signatureCanvas.getBoundingClientRect();
        const currentX = e.clientX - rect.left;
        const currentY = e.clientY - rect.top;
        
        signatureContext.lineJoin = 'round';
        signatureContext.lineCap = 'round';
        signatureContext.lineWidth = 2;
        signatureContext.strokeStyle = '#000';
        
        signatureContext.beginPath();
        signatureContext.moveTo(lastX, lastY);
        signatureContext.lineTo(currentX, currentY);
        signatureContext.stroke();
        
        lastX = currentX;
        lastY = currentY;
      }
      
      // ì„œëª… ì¢…ë£Œ
      function endSignature() {
        isDrawing = false;
      }
    }
    
    // ë„ì¥ ë¯¸ë¦¬ë³´ê¸°
    function previewStamp(input) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
          customStampImage = new Image();
          customStampImage.src = e.target.result;
          
          customStampImage.onload = function() {
            const previewDiv = document.getElementById('stampPreview');
            previewDiv.innerHTML = '';
            
            const img = document.createElement('img');
            img.src = e.target.result;
            previewDiv.appendChild(img);
          };
        };
        
        reader.readAsDataURL(input.files[0]);
      }
    }
    
    // ê¸°ë³¸ ë„ì¥ ì„ íƒ
    function selectDefaultStamp(type) {
      // ê¸°ì¡´ ì„ íƒ í•´ì œ
      document.querySelectorAll('.default-stamp-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      // ìƒˆ ì„ íƒ í‘œì‹œ
      event.target.classList.add('selected');
      
      const stampPath = type === 'round' ? '/images/round-stamp.png' : '/images/square-stamp.png';
      
      customStampImage = new Image();
      customStampImage.src = stampPath;
      
      customStampImage.onload = function() {
        const previewDiv = document.getElementById('stampPreview');
        previewDiv.innerHTML = '';
        
        const img = document.createElement('img');
        img.src = stampPath;
        previewDiv.appendChild(img);
      };
    }
    
    // ë„ì¥ íŒì—… ì—´ê¸°
    function openStampPopup() {
      document.getElementById('stampPopup').style.display = 'block';
      mode = 'stamp';
      document.getElementById('currentMode').textContent = 'ë„ì¥';
      updateToolbarButtons('stampBtn');
      
      // ì—…ë¡œë“œëœ ë„ì¥ ëª©ë¡ ë¡œë“œ
      loadUploadedStamps();
      
      // localStorageì—ì„œ ì„ íƒëœ ë„ì¥ í™•ì¸
      checkSelectedStampFromStorage();
    }
    
    // ì—…ë¡œë“œëœ ë„ì¥ ëª©ë¡ ë¡œë“œ
    function loadUploadedStamps() {
      const stampsList = document.getElementById('uploadedStampsList');
      const entryType = serverEntryType || sessionStorage.getItem('entryType');
      
      // ì´ë¯¸ ì…ì¥ ì‹œ ì‚¬ìš©í•œ ë„ì¥ì´ ìˆìœ¼ë©´ ê·¸ê²ƒì„ í‘œì‹œ
      if (entryType === 'stamp' && customStampImage) {
        stampsList.innerHTML = `
          <div class="uploaded-stamp-item selected">
            <img src="/stamp/image/${customStampImage.src}" class="uploaded-stamp-image" alt="ë„ì¥">
            <div class="uploaded-stamp-info">
              <div>ë„ì¥</div>
              <div class="uploaded-stamp-date">í˜„ì¬ ì„¸ì…˜</div>
            </div>
          </div>
        `;
        console.log('ì…ì¥ ì‹œ ì‚¬ìš©í•œ ë„ì¥ìœ¼ë¡œ ëª©ë¡ í‘œì‹œ');
        return;
      }
      
      stampsList.innerHTML = '<p class="loading-text">ë„ì¥ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
      
      // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ë„ì¥ ëª©ë¡ ì¡°íšŒ
      fetch('/stamp/api/list')
        .then(response => {
          if (response.status === 401) {
            throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          }
          if (!response.ok) {
            throw new Error('ë„ì¥ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          }
          return response.json();
        })
        .then(stamps => {
          if (stamps.length === 0) {
            stampsList.innerHTML = `
              <div class="text-center" style="padding: 20px; color: #666;">
                <i class="fas fa-stamp" style="font-size: 2em; margin-bottom: 10px; color: #ddd;"></i>
                <p>ì—…ë¡œë“œëœ ë„ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                <p style="font-size: 0.9em;">ë„ì¥ ê´€ë¦¬ì—ì„œ ìƒˆ ë„ì¥ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.</p>
              </div>
            `;
          } else {
            // ì²« ë²ˆì§¸ ë„ì¥ë§Œ í‘œì‹œ (í•œ ê³ ê°ë‹¹ í•˜ë‚˜ì˜ ë„ì¥ë§Œ í—ˆìš©)
            const stamp = stamps[0];
            const date = new Date(stamp.createdAt).toLocaleDateString('ko-KR');
            const stampsHtml = `
              <div class="uploaded-stamp-item selected" onclick="selectUploadedStamp(${stamp.stampId}, '${stamp.imagePath}')">
                <img src="/stamp/image/${stamp.imagePath}" class="uploaded-stamp-image" alt="ë„ì¥">
                <div class="uploaded-stamp-info">
                  <div>ë„ì¥</div>
                  <div class="uploaded-stamp-date">ë“±ë¡ì¼: ${date}</div>
                </div>
              </div>
            `;
            stampsList.innerHTML = stampsHtml;
            
            // ìë™ìœ¼ë¡œ ë„ì¥ ì„ íƒ
            selectUploadedStamp(stamp.stampId, stamp.imagePath);
          }
        })
        .catch(error => {
          console.error('ë„ì¥ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
          if (error.message === 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.') {
            stampsList.innerHTML = `
              <div class="text-center" style="padding: 20px; color: #dc3545;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2em; margin-bottom: 10px;"></i>
                <p>ë„ì¥ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                <p style="font-size: 0.9em;">í˜„ì¬ ì„¸ì…˜ì˜ ë„ì¥ì„ ê³„ì† ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
              </div>
            `;
          } else {
            stampsList.innerHTML = `
              <div class="text-center" style="padding: 20px; color: #dc3545;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2em; margin-bottom: 10px;"></i>
                <p>ë„ì¥ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                <button onclick="loadUploadedStamps()" class="clear-btn">ë‹¤ì‹œ ì‹œë„</button>
              </div>
            `;
          }
        });
    }
    
    // ë„ì¥ íŒì—… ë‹«ê¸°
    function closeStampPopup() {
      document.getElementById('stampPopup').style.display = 'none';
      setCursor();
    }
    
    // ë„ì¥ íƒ­ ì „í™˜
    function switchStampTab(tabName) {
      // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
      document.querySelectorAll('.stamp-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.stamp-tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // ì„ íƒëœ íƒ­ í™œì„±í™”
      event.target.classList.add('active');
      document.getElementById(tabName + 'Tab').classList.add('active');
      
      // íƒ­ë³„ ì´ˆê¸°í™”
      if (tabName === 'uploaded') {
        loadUploadedStamps();
      }
    }
    
    // ì—…ë¡œë“œëœ ë„ì¥ ì„ íƒ
    function selectUploadedStamp(stampId, imagePath) {
      // ê¸°ì¡´ ì„ íƒ í•´ì œ
      document.querySelectorAll('.uploaded-stamp-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // ìƒˆ ì„ íƒ í‘œì‹œ
      event.currentTarget.classList.add('selected');
      
      // ë„ì¥ ì´ë¯¸ì§€ ë¡œë“œ
      customStampImage = new Image();
      customStampImage.src = `/stamp/image/${imagePath}`;
      
      customStampImage.onload = function() {
        const previewDiv = document.getElementById('stampPreview');
        previewDiv.innerHTML = '';
        
        const img = document.createElement('img');
        img.src = `/stamp/image/${imagePath}`;
        previewDiv.appendChild(img);
      };
    }
    
    // localStorageì—ì„œ ì„ íƒëœ ë„ì¥ í™•ì¸
    function checkSelectedStampFromStorage() {
      const selectedStamp = localStorage.getItem('selectedStamp');
      if (selectedStamp) {
        try {
          const stampData = JSON.parse(selectedStamp);
          selectUploadedStamp(stampData.stampId, stampData.imagePath);
          
          // ì—…ë¡œë“œëœ ë„ì¥ íƒ­ìœ¼ë¡œ ì „í™˜
          switchStampTab('uploaded');
          
          // localStorageì—ì„œ ì œê±°
          localStorage.removeItem('selectedStamp');
        } catch (error) {
          console.error('ì„ íƒëœ ë„ì¥ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', error);
        }
      }
    }
    
    // ë„ì¥ í™•ì¸
    function confirmStamp() {
      if (!customStampImage) {
        alert('ë„ì¥ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      closeStampPopup();
      
      // ë„ì¥ ëª¨ë“œë¡œ ì„¤ì •í•˜ê³  í´ë¦­ ëŒ€ê¸°
      mode = 'stamp';
      document.getElementById('currentMode').textContent = 'ë„ì¥ ìœ„ì¹˜ ì„ íƒ';
      
      // ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
      showToast("ìœ„ì¹˜ ì„ íƒ", "ë„ì¥ì„ ì¶”ê°€í•  ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”.", "info");
    }
    
    // ì„œëª… íŒì—… ì—´ê¸°
    function openSignaturePopup() {
      document.getElementById('signaturePopup').style.display = 'block';
      clearSignature(); // ì„œëª… ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
      mode = 'signature';
      document.getElementById('currentMode').textContent = 'ì„œëª…';
      updateToolbarButtons('signatureBtn');
    }
    
    // ì„œëª… ì§€ìš°ê¸°
    function clearSignature() {
      signatureContext.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    }
    
    // ì„œëª… í™•ì¸
    function confirmSignature() {
      // ë¹ˆ ì„œëª…ì¸ì§€ í™•ì¸
      const imageData = signatureContext.getImageData(0, 0, signatureCanvas.width, signatureCanvas.height);
      const data = imageData.data;
      let hasSignature = false;
      
      for (let i = 0; i < data.length; i += 4) {
        if (data[i + 3] > 0) { // ì•ŒíŒŒ ì±„ë„ì´ 0ë³´ë‹¤ í¬ë©´ ê·¸ë ¤ì§„ í”½ì…€ì´ ìˆëŠ” ê²ƒ
          hasSignature = true;
          break;
        }
      }
      
      if (!hasSignature) {
        alert('ì„œëª…ì„ ê·¸ë ¤ì£¼ì„¸ìš”.');
        return;
      }
      
      // ì„œëª… ì´ë¯¸ì§€ ìƒì„±
      const signatureImage = new Image();
      signatureImage.src = signatureCanvas.toDataURL();
      
      // ì„œëª… ì´ë¯¸ì§€ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
      customStampImage = signatureImage;
      
      closeSignaturePopup();
      
      // ì„œëª… ìœ„ì¹˜ ì„ íƒ ëª¨ë“œë¡œ ì „í™˜
      mode = 'signature';
      document.getElementById('currentMode').textContent = 'ì„œëª… ìœ„ì¹˜ ì„ íƒ';
      
      // ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
      showToast("ìœ„ì¹˜ ì„ íƒ", "ì„œëª…ì„ ì¶”ê°€í•  ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”.", "info");
    }
    
    // ì„œëª… íŒì—… ë‹«ê¸°
    function closeSignaturePopup() {
      document.getElementById('signaturePopup').style.display = 'none';
      setCursor();
    }
    
    // ê¸°ì¡´ setStampMode í•¨ìˆ˜ ëŒ€ì²´
    function setStampMode() {
      openStampPopup();
    }
    
    // ê¸°ì¡´ setSignatureMode í•¨ìˆ˜ ëŒ€ì²´
    function setSignatureMode() {
      openSignaturePopup();
    }
    
    // ë„ì¥/ì„œëª… ë°°ì¹˜ ì²˜ë¦¬ ì¬ì •ì˜
    async function handleStampPlacement(event) {
      if (mode !== 'stamp') return;
      
      const rect = drawingCanvas.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
      
      if (!customStampImage) {
        showToast("ì˜¤ë¥˜", "ë„ì¥ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.", "error");
        return;
      }
      
      // ë„ì¥ í¬ê¸° ì„¤ì •
      const stampWidth = 100;
      const stampHeight = 100;
      
      // ë„ì¥ ê·¸ë¦¬ê¸°
      drawingContext.drawImage(customStampImage, x - stampWidth/2, y - stampHeight/2, stampWidth, stampHeight);
      
      // ë„ì¥ ë°ì´í„° ì €ì¥
      if (!stampDataPerPage[currentPage]) {
        stampDataPerPage[currentPage] = [];
      }
      
      // ë„ì¥ ì´ë¯¸ì§€ ë°ì´í„° (base64) - ìµœì í™”
      const originalStampImageData = customStampImage.src;
      const stampImageData = await optimizeImageData(originalStampImageData, 200, 200, 0.8);
      
      const stampData = {
        x: x - stampWidth/2,
        y: y - stampHeight/2,
        width: stampWidth,
        height: stampHeight,
        imageData: stampImageData
      };
      
      stampDataPerPage[currentPage].push(stampData);
      
      // WebSocketìœ¼ë¡œ ë„ì¥ ë°ì´í„° ì „ì†¡
      if (stompClient && stompClient.connected) {
        const stampMessage = {
          type: 'stamp',
          x: x - stampWidth/2,
          y: y - stampHeight/2,
          width: stampWidth,
          height: stampHeight,
          imageData: stampImageData, // ìµœì í™”ëœ ì´ë¯¸ì§€ ë°ì´í„° ì „ì†¡
          page: currentPage,
          sessionId: sessionId,
          sender: userRole
        };
        
        // ì„œë²„ë¥¼ í†µí•´ ë¸Œë¡œë“œìºìŠ¤íŒ…í•˜ê¸° ìœ„í•´ /app ê²½ë¡œ ì‚¬ìš©
        stompClient.send(`/app/room/${sessionId}/stamp`, {
          contentType: 'application/json',
          sessionId: sessionId,
          userRole: userRole
        }, JSON.stringify(stampMessage));
        console.log("ë„ì¥ ë°ì´í„° ì „ì†¡:", stampMessage);
      }
      
      // ì„¸ì…˜ ë°ì´í„° ì €ì¥
      saveStampData();
      saveSessionData();
      
      // ì»¤ì„œ ëª¨ë“œë¡œ ë˜ëŒë¦¬ê¸°
      setCursor();
    }
    
    // ì„œëª… ë°°ì¹˜ ì²˜ë¦¬ ì¬ì •ì˜
    async function handleSignaturePlacement(event) {
      if (mode !== 'signature') return;
      
      const rect = drawingCanvas.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
      
      if (!customStampImage) {
        showToast("ì˜¤ë¥˜", "ì„œëª… ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.", "error");
        return;
      }
      
      // ì„œëª… í¬ê¸° ì„¤ì •
      const signatureWidth = 200;
      const signatureHeight = 100;
      
      // ì„œëª… ê·¸ë¦¬ê¸°
      drawingContext.drawImage(customStampImage, x - signatureWidth/2, y - signatureHeight/2, signatureWidth, signatureHeight);
      
      // ì„œëª… ë°ì´í„° ì €ì¥
      if (!signatureDataPerPage[currentPage]) {
        signatureDataPerPage[currentPage] = [];
      }
      
      // ì„œëª… ì´ë¯¸ì§€ ë°ì´í„° (base64) - ìµœì í™”
      const originalSignatureImageData = customStampImage.src;
      const signatureImageData = await optimizeImageData(originalSignatureImageData, 300, 150, 0.8);
      
      const signatureData = {
        x: x - signatureWidth/2,
        y: y - signatureHeight/2,
        width: signatureWidth,
        height: signatureHeight,
        imageData: signatureImageData,
        timestamp: new Date().getTime()
      };
      
      signatureDataPerPage[currentPage].push(signatureData);
      
      // WebSocketìœ¼ë¡œ ì„œëª… ë°ì´í„° ì „ì†¡
      if (stompClient && stompClient.connected) {
        const data = {
          type: 'signature',
          x: x - signatureWidth/2,
          y: y - signatureHeight/2,
          width: signatureWidth,
          height: signatureHeight,
          imageData: signatureImageData, // ìµœì í™”ëœ ì´ë¯¸ì§€ ë°ì´í„° ì „ì†¡
          page: currentPage,
          sessionId: sessionId,
          sender: userRole
        };
        
        // ì„œë²„ë¥¼ í†µí•´ ë¸Œë¡œë“œìºìŠ¤íŒ…í•˜ê¸° ìœ„í•´ /app ê²½ë¡œ ì‚¬ìš©
        stompClient.send(`/app/room/${sessionId}/signature`, {
          contentType: 'application/json',
          sessionId: sessionId,
          userRole: userRole
        }, JSON.stringify(data));
        console.log("ì„œëª… ë°ì´í„° ì „ì†¡:", data);
      }
      
      // ì„œëª… í›„ ì»¤ì„œ ëª¨ë“œë¡œ ëŒì•„ê°€ê¸°
      setCursor();
      
      // ì„¸ì…˜ ë°ì´í„° ì €ì¥
      saveSessionData();
    }
    
    // ë„ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ ì…ì¥ ë°©ì‹ì— ë”°ë¥¸ ì²˜ë¦¬
    function handleStampButtonClick() {
      const entryType = serverEntryType || sessionStorage.getItem('entryType');
      
      console.log('=== ë„ì¥ ë²„íŠ¼ í´ë¦­ ===');
      console.log('entryType:', entryType);
      console.log('customStampImage ì¡´ì¬ ì—¬ë¶€:', !!customStampImage);
      
      // ë„ì¥ìœ¼ë¡œ ì…ì¥í•œ ê²½ìš°ëŠ” ë¬´ì¡°ê±´ ë°”ë¡œ ë°°ì¹˜ ëª¨ë“œë¡œ ì „í™˜
      if (entryType === 'stamp') {
        if (customStampImage) {
          console.log('âœ… ê¸°ì¡´ ë„ì¥ìœ¼ë¡œ ë°”ë¡œ ë°°ì¹˜ ëª¨ë“œ ì§„ì…');
          mode = 'stamp';
          document.getElementById('currentMode').textContent = 'ë„ì¥ ìœ„ì¹˜ ì„ íƒ';
          updateToolbarButtons('stampBtn');
          showToast("ìœ„ì¹˜ ì„ íƒ", "ë„ì¥ì„ ì¶”ê°€í•  ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”.", "info");
          return;
        } else {
          console.warn('âš ï¸  ë„ì¥ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤ - ìƒˆë¡œ ì„ íƒ í•„ìš”');
          showToast("ì˜¤ë¥˜", "ë„ì¥ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ì„ íƒí•´ì£¼ì„¸ìš”.", "error");
        }
      }
      
      console.log('ğŸ”– ë„ì¥ íŒì—…ì„ ì—½ë‹ˆë‹¤');
      // ìƒˆë¡œìš´ ë„ì¥ì´ í•„ìš”í•œ ê²½ìš°ë§Œ íŒì—… ì—´ê¸°
      openStampPopup();
    }
    
    // ì„œëª… ë²„íŠ¼ í´ë¦­ ì‹œ ì…ì¥ ë°©ì‹ì— ë”°ë¥¸ ì²˜ë¦¬
    function handleSignatureButtonClick() {
      const entryType = serverEntryType || sessionStorage.getItem('entryType');
      
      console.log('=== ì„œëª… ë²„íŠ¼ í´ë¦­ ===');
      console.log('entryType:', entryType);
      console.log('customStampImage ì¡´ì¬ ì—¬ë¶€:', !!customStampImage);
      
      // ì„œëª…ìœ¼ë¡œ ì…ì¥í•œ ê²½ìš°ëŠ” ë¬´ì¡°ê±´ ë°”ë¡œ ë°°ì¹˜ ëª¨ë“œë¡œ ì „í™˜
      if (entryType === 'signature') {
        if (customStampImage) {
          console.log('âœ… ê¸°ì¡´ ì„œëª…ìœ¼ë¡œ ë°”ë¡œ ë°°ì¹˜ ëª¨ë“œ ì§„ì…');
          mode = 'signature';
          document.getElementById('currentMode').textContent = 'ì„œëª… ìœ„ì¹˜ ì„ íƒ';
          updateToolbarButtons('signatureBtn');
          showToast("ìœ„ì¹˜ ì„ íƒ", "ì„œëª…ì„ ì¶”ê°€í•  ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”.", "info");
          return;
        } else {
          console.warn('âš ï¸  ì„œëª… ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤ - ìƒˆë¡œ ìƒì„± í•„ìš”');
          showToast("ì˜¤ë¥˜", "ì„œëª… ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ê·¸ë ¤ì£¼ì„¸ìš”.", "error");
        }
      }
      
      console.log('ğŸ“ ì„œëª… íŒì—…ì„ ì—½ë‹ˆë‹¤');
      // ìƒˆë¡œìš´ ì„œëª…ì´ í•„ìš”í•œ ê²½ìš°ë§Œ íŒì—… ì—´ê¸°
      openSignaturePopup();
    }
  </script>
</body>
</html> 