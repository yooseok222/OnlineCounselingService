<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>고객 입장 | 전자계약 원스톱 AI 서비스</title>
    <!-- CSRF 토큰을 위한 메타 태그 추가 -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    
    <!-- 부트스트랩 5 CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 부트스트랩 아이콘 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Pretendard Variable 전용 CSS -->
    <link rel="stylesheet" th:href="@{/css/common/font.css}" />
    
    <style>
        body {
            font-family: 'Pretendard Variable', -apple-system, BlinkMacSystemFont, system-ui, Roboto, 'Helvetica Neue', 'Segoe UI', 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', sans-serif;
            background-color: #f8f9fa;
            padding: 2rem 0;
        }
        
        .main-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        .entry-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
            overflow: hidden;
            transition: transform 0.3s;
        }
        
        .entry-card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background-color: #0064E1;
            color: white;
            padding: 1.2rem;
            font-weight: 500;
            border-bottom: none;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .btn-primary {
            background-color: #0064E1;
            border-color: #0064E1;
            padding: 8px 20px;
        }
        
        .btn-primary:hover {
            background-color: #0053b3;
            border-color: #0053b3;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        
        canvas {
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            width: 100%;
            max-width: 400px;
        }
        
        .page-header {
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
        }
        
        .icon-wrapper {
            font-size: 40px;
            margin-bottom: 1rem;
            color: #0064E1;
        }
        
        /* 도장 선택 영역 스타일 */
        .stamp-selection-area {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 0.5rem;
        }
        
        .stamp-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border: 1px solid #e9ecef;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .stamp-item:hover {
            background-color: #f8f9fa;
            border-color: #0064E1;
        }
        
        .stamp-item.selected {
            background-color: #e3f2fd;
            border-color: #0064E1;
            box-shadow: 0 0 0 0.2rem rgba(0, 100, 225, 0.25);
        }
        
        .stamp-item img {
            width: 40px;
            height: 40px;
            object-fit: contain;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            margin-right: 0.75rem;
        }
        
        .stamp-info {
            flex: 1;
            text-align: left;
        }
        
        .stamp-info .stamp-id {
            font-weight: 500;
            color: #495057;
        }
        
        .stamp-info .stamp-date {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .empty-stamps {
            text-align: center;
            padding: 2rem 1rem;
            color: #6c757d;
        }
        
        .empty-stamps i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #dee2e6;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="text-center page-header">
            <h1 class="display-6"><i class="bi bi-person-check me-2"></i>고객 입장</h1>
            <p class="text-muted">상담에 참여하기 위한 인증 방법을 선택해주세요</p>
        </div>
        
        <div class="row">
            <!-- 도장 등록 카드 -->
            <div class="col-md-6 mb-4">
                <div class="entry-card card h-100">
                    <div class="card-header">
                        <i class="bi bi-stamp me-2"></i>도장으로 입장
                    </div>
                    <div class="card-body text-center">
                        <div class="icon-wrapper">
                            <i class="bi bi-file-earmark-image"></i>
                        </div>
                        <p>저장된 도장을 선택하고 상담에 참여합니다.</p>
                        
                        <!-- 도장 선택 영역 -->
                        <div class="mb-3">
                            <div id="stampList" class="stamp-selection-area">
                                <p class="text-muted">도장을 불러오는 중...</p>
                            </div>
                        </div>
                        
                        <!-- 새 도장 업로드 옵션 -->
                        <div class="mb-3">
                            <button id="uploadToggleBtn" class="btn btn-outline-secondary btn-sm" onclick="toggleUploadMode()">
                                <i class="bi bi-plus-circle me-1"></i> 새 도장 업로드
                            </button>
                        </div>
                        
                        <!-- 업로드 모드 (숨김) -->
                        <div id="uploadMode" class="mb-3" style="display: none;">
                            <input class="form-control mb-2" type="file" id="stampUpload" accept="image/*">
                            <button class="btn btn-secondary btn-sm" onclick="uploadNewStamp()">
                                <i class="bi bi-upload me-1"></i> 업로드
                            </button>
                        </div>
                        
                        <button class="btn btn-primary w-100" onclick="enterWithSelectedStamp()" id="enterStampBtn" disabled>
                            <i class="bi bi-box-arrow-in-right me-1"></i> 선택한 도장으로 입장
                        </button>
                        
                        <!-- 도장 관리 링크 -->
                        <div class="mt-2">
                            <a href="/client/stamp" target="_blank" class="btn btn-link btn-sm">
                                <i class="bi bi-gear me-1"></i> 도장 관리
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 서명 등록 카드 -->
            <div class="col-md-6 mb-4">
                <div class="entry-card card h-100">
                    <div class="card-header">
                        <i class="bi bi-pen me-2"></i>서명으로 입장
                    </div>
                    <div class="card-body text-center">
                        <div class="icon-wrapper">
                            <i class="bi bi-pencil-square"></i>
                        </div>
                        <p>아래 영역에 서명을 작성하고 상담에 참여합니다.</p>
                        <div class="d-flex justify-content-center mb-3">
                            <canvas id="signCanvas" width="300" height="100"></canvas>
                        </div>
                        <div class="d-flex gap-2 mb-3">
                            <button class="btn btn-secondary flex-grow-1" onclick="clearSignature()">
                                <i class="bi bi-eraser me-1"></i> 서명 지우기
                            </button>
                            <button class="btn btn-primary flex-grow-1" onclick="enterWithSignature()">
                                <i class="bi bi-box-arrow-in-right me-1"></i> 서명으로 입장
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-3">
            <a href="/main-page" class="btn btn-outline-secondary">
                <i class="bi bi-house me-1"></i> 메인 화면으로 돌아가기
            </a>
        </div>
    </div>
    
    <!-- 부트스트랩 5 JS 번들 (Popper 포함) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script th:inline="javascript">
        // 전역 변수
        let selectedStampId = null;
        let selectedStampImage = null;
        
        // 초대링크 모드 확인
        console.log('=== Thymeleaf 변수 디버깅 ===');
        console.log('서버에서 전달된 invitationMode:', /*[[${invitationMode}]]*/ false);
        console.log('서버에서 전달된 contractId:', /*[[${contractId}]]*/ null);
        console.log('서버에서 전달된 consultingSessionId:', /*[[${consultingSessionId}]]*/ null);
        console.log('서버에서 전달된 serverUrl:', /*[[${serverUrl}]]*/ null);
        
        const invitationMode = /*[[${invitationMode}]]*/ false;
        const contractId = /*[[${contractId}]]*/ null;
        const consultingSessionId = /*[[${consultingSessionId}]]*/ null;
        const serverUrl = /*[[${serverUrl}]]*/ window.location.origin;
        
        console.log('=== JavaScript 변수 최종값 ===');
        console.log('초대링크 모드:', invitationMode);
        console.log('계약 ID:', contractId);
        console.log('상담 세션 ID:', consultingSessionId);
        console.log('서버 URL:', serverUrl);
        
        // 페이지 로드 시 도장 목록 불러오기
        document.addEventListener('DOMContentLoaded', function() {
            console.log('페이지 로드 완료, 도장 목록 로드 시작');
            loadStampList();
        });
        
        // 도장 목록 불러오기
        function loadStampList() {
            const stampList = document.getElementById('stampList');
            const uploadToggleBtn = document.getElementById('uploadToggleBtn');
            stampList.innerHTML = '<p class="text-muted">도장을 불러오는 중...</p>';
            
            console.log('도장 목록 로드 시작...');
            
            // 현재 로그인한 사용자의 도장 목록 조회
            fetch('/stamp/api/list')
                .then(response => {
                    console.log('응답 상태:', response.status);
                    
                    if (response.status === 401) {
                        console.log('401 오류: 로그인 필요');
                        stampList.innerHTML = `
                            <div class="empty-stamps">
                                <i class="bi bi-exclamation-triangle text-warning"></i>
                                <p>로그인이 필요합니다.</p>
                                <a href="/login" class="btn btn-sm btn-primary">로그인</a>
                            </div>
                        `;
                        uploadToggleBtn.disabled = false;
                        uploadToggleBtn.innerHTML = '<i class="bi bi-plus-circle me-1"></i> 새 도장 업로드';
                        uploadToggleBtn.className = 'btn btn-outline-secondary btn-sm';
                        return;
                    }
                    if (response.status === 403) {
                        console.log('403 오류: 권한 없음');
                        stampList.innerHTML = `
                            <div class="empty-stamps">
                                <i class="bi bi-exclamation-triangle text-danger"></i>
                                <p>접근 권한이 없습니다.</p>
                                <a href="/login" class="btn btn-sm btn-primary">다시 로그인</a>
                            </div>
                        `;
                        uploadToggleBtn.disabled = false;
                        uploadToggleBtn.innerHTML = '<i class="bi bi-plus-circle me-1"></i> 새 도장 업로드';
                        uploadToggleBtn.className = 'btn btn-outline-secondary btn-sm';
                        return;
                    }
                    if (!response.ok) {
                        console.log('HTTP 오류:', response.status);
                        throw new Error(`HTTP ${response.status}: 도장 목록을 불러올 수 없습니다.`);
                    }
                    return response.json();
                })
                .then(stamps => {
                    if (!stamps) return; // 에러 처리에서 return된 경우
                    
                    console.log('받은 도장 데이터:', stamps);
                    
                    if (stamps.length === 0) {
                        stampList.innerHTML = `
                            <div class="empty-stamps">
                                <i class="bi bi-stamp"></i>
                                <p>등록된 도장이 없습니다.</p>
                                <p class="small">도장 관리에서 도장을 등록하세요.</p>
                            </div>
                        `;
                        // 도장이 없으면 업로드 버튼 활성화
                        uploadToggleBtn.disabled = false;
                        uploadToggleBtn.innerHTML = '<i class="bi bi-plus-circle me-1"></i> 새 도장 업로드';
                        uploadToggleBtn.className = 'btn btn-outline-secondary btn-sm';
                    } else {
                        // 첫 번째 도장만 표시 (한 고객당 하나의 도장만 허용)
                        const stamp = stamps[0];
                        console.log('선택할 도장 정보:', stamp); // 디버깅 로그 추가
                        
                        // stamp 객체가 유효한지 확인
                        if (!stamp || !stamp.stampImageUrl) {
                            showError('도장 정보가 유효하지 않습니다.');
                            console.error('유효하지 않은 도장 정보:', stamp);
                            return;
                        }
                        
                        const date = new Date(stamp.createdAt).toLocaleDateString('ko-KR');
                        const stampsHtml = `
                            <div class="stamp-item selected" onclick="selectStamp(${stamp.stampId}, '${stamp.stampImageUrl}', this)">
                                <img src="${stamp.stampImageUrl}" alt="도장" onerror="this.onerror=null; this.src='/images/stamp-placeholder.png'; console.error('도장 이미지 로드 실패');">
                                <div class="stamp-info">
                                    <div class="stamp-id">도장</div>
                                    <div class="stamp-date">등록일: ${date}</div>
                                </div>
                            </div>
                        `;
                        stampList.innerHTML = stampsHtml;
                        
                        // 자동으로 도장 선택 - setTimeout을 사용해 DOM이 완전히 렌더링된 후 실행
                        setTimeout(() => {
                            try {
                                const stampElement = stampList.querySelector('.stamp-item');
                                if (stampElement) {
                                    // 명시적으로 변수를 전달하여 호출
                                    const stampId = stamp.stampId;
                                    console.log('자동 선택 시도:', stampId, stamp.stampImageUrl, stampElement);
                                    selectStamp(stampId, stamp.stampImageUrl, stampElement);
                                }
                            } catch (error) {
                                console.error('자동 도장 선택 오류:', error);
                            }
                        }, 100);
                        
                        // 도장이 있으면 업로드 버튼 비활성화
                        uploadToggleBtn.disabled = true;
                        uploadToggleBtn.innerHTML = '<i class="bi bi-lock me-1"></i> 업로드 불가 (기존 도장 삭제 필요)';
                        uploadToggleBtn.className = 'btn btn-outline-secondary btn-sm disabled';
                    }
                })
                .catch(error => {
                    console.error('도장 목록 로드 실패:', error);
                    stampList.innerHTML = `
                        <div class="empty-stamps">
                            <i class="bi bi-exclamation-triangle text-danger"></i>
                            <p>도장 목록을 불러올 수 없습니다.</p>
                            <p class="small">${error.message}</p>
                            <button class="btn btn-sm btn-outline-primary" onclick="loadStampList()">다시 시도</button>
                        </div>
                    `;
                    
                    // 오류 시에도 업로드 버튼 활성화
                    uploadToggleBtn.disabled = false;
                    uploadToggleBtn.innerHTML = '<i class="bi bi-plus-circle me-1"></i> 새 도장 업로드';
                    uploadToggleBtn.className = 'btn btn-outline-secondary btn-sm';
                });
        }
        
        // 오류 메시지 표시
        function showError(message) {
            const errorAlert = document.getElementById('errorAlert');
            if (!errorAlert) {
                // 오류 알림창이 없으면 생성
                const alertDiv = document.createElement('div');
                alertDiv.id = 'errorAlert';
                alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
                alertDiv.role = 'alert';
                alertDiv.innerHTML = `
                    <i class="bi bi-exclamation-circle me-2"></i>
                    <span id="errorMessage"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                // 알림창을 폼 상단에 추가
                const entryForm = document.querySelector('.entry-form-container');
                if (entryForm) {
                    entryForm.insertBefore(alertDiv, entryForm.firstChild);
                } else {
                    // entry-form-container가 없는 경우 .main-container에 추가
                    const mainContainer = document.querySelector('.main-container');
                    mainContainer.insertBefore(alertDiv, mainContainer.firstChild);
                }
            }
            
            // 메시지 설정 및 표시
            document.getElementById('errorMessage').textContent = message;
            
            // 5초 후 자동으로 닫히게 설정
            setTimeout(() => {
                const alertElement = document.getElementById('errorAlert');
                if (alertElement) {
                    // 부모 요소에서 제거
                    alertElement.parentNode.removeChild(alertElement);
                }
            }, 5000);
            
            console.error('Error:', message);
        }
        
        // 성공 메시지 표시
        function showSuccess(message) {
            const successAlert = document.getElementById('successAlert');
            if (!successAlert) {
                // 성공 알림창이 없으면 생성
                const alertDiv = document.createElement('div');
                alertDiv.id = 'successAlert';
                alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
                alertDiv.role = 'alert';
                alertDiv.innerHTML = `
                    <i class="bi bi-check-circle me-2"></i>
                    <span id="successMessage"></span>
                    <button type="button" class="btn-close" onclick="this.parentNode.remove()" aria-label="Close"></button>
                `;
                
                // 알림창을 폼 상단에 추가
                const entryForm = document.querySelector('.entry-form-container');
                if (entryForm) {
                    entryForm.insertBefore(alertDiv, entryForm.firstChild);
                } else {
                    // entry-form-container가 없는 경우 .main-container에 추가
                    const mainContainer = document.querySelector('.main-container');
                    mainContainer.insertBefore(alertDiv, mainContainer.firstChild);
                }
            }
            
            // 메시지 설정 및 표시
            document.getElementById('successMessage').textContent = message;
            
            // 5초 후 자동으로 닫히게 설정
            setTimeout(() => {
                const alertElement = document.getElementById('successAlert');
                if (alertElement) {
                    // 부모 요소에서 제거
                    alertElement.parentNode.removeChild(alertElement);
                }
            }, 5000);
            
            console.log('Success:', message);
        }
        
        // 도장 선택
        function selectStamp(stampId, imagePath, element) {
            console.log('selectStamp 호출:', stampId, imagePath, element);
            
            // 매개변수 유효성 검사 강화
            if (!stampId) {
                console.error('유효하지 않은 stampId:', stampId);
                showError('도장 ID가 유효하지 않습니다.');
                return;
            }
            
            if (!imagePath || imagePath === 'undefined' || imagePath === 'null') {
                console.error('유효하지 않은 이미지 경로:', imagePath);
                showError('도장 이미지를 찾을 수 없습니다.');
                return;
            }
            
            try {
                // 기존 선택 해제
                document.querySelectorAll('.stamp-item').forEach(item => {
                    item.classList.remove('selected');
                });
                
                // 새 선택 표시
                let targetElement = element;
                if (!targetElement && typeof event !== 'undefined' && event && event.currentTarget) {
                    targetElement = event.currentTarget;
                }
                
                if (targetElement) {
                    targetElement.classList.add('selected');
                    console.log('도장 선택됨:', targetElement);
                } else {
                    console.warn('선택할 요소를 찾을 수 없습니다.');
                }
                
                // 이미지 경로 확인 및 설정
                selectedStampId = stampId;
                
                // 이미 전체 URL인지 확인하여 설정
                if (imagePath.startsWith('/') || imagePath.startsWith('http')) {
                    selectedStampImage = imagePath;
                } else {
                    selectedStampImage = `/stamp/image/${imagePath}`;
                }
                console.log('선택된 도장 경로:', selectedStampImage);
                
                // 이미지가 실제로 존재하는지 확인
                const testImage = new Image();
                testImage.onload = function() {
                    console.log('도장 이미지 로드 성공:', selectedStampImage);
                    
                    // 입장 버튼 활성화
                    const enterBtn = document.getElementById('enterStampBtn');
                    if (enterBtn) {
                        enterBtn.disabled = false;
                        console.log('입장 버튼 활성화됨');
                    }
                };
                testImage.onerror = function() {
                    console.error('도장 이미지 로드 실패:', selectedStampImage);
                    showError('도장 이미지를 불러올 수 없습니다. 도장을 다시 등록해주세요.');
                    
                    // 입장 버튼 비활성화
                    const enterBtn = document.getElementById('enterStampBtn');
                    if (enterBtn) {
                        enterBtn.disabled = true;
                    }
                };
                testImage.src = selectedStampImage;
                
            } catch (error) {
                console.error('selectStamp 오류:', error);
                showError('도장 선택 중 오류가 발생했습니다: ' + error.message);
            }
        }
        
        // 선택한 도장으로 입장
        function enterWithSelectedStamp() {
            if (!selectedStampId || !selectedStampImage) {
                showError('도장을 선택해주세요.');
                return;
            }
            
            // 디버깅 로그 추가
            console.log('=== 도장으로 입장 시작 ===');
            console.log('invitationMode:', invitationMode);
            console.log('contractId:', contractId);
            console.log('consultingSessionId:', consultingSessionId);
            console.log('serverUrl:', serverUrl);
            
            // 선택된 도장 이미지를 캔버스로 처리
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d', { alpha: true, willReadFrequently: true });
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                
                const processedImageData = canvas.toDataURL('image/png');
                
                // 초대링크 모드인지 확인
                if (invitationMode && contractId) {
                    console.log('초대링크 모드로 처리 - 서버로 POST 요청 전송');
                    // 초대링크 모드: 서버로 POST 요청 전송
                    submitEntryForm('stamp', processedImageData, null);
                } else {
                    console.log('일반 모드로 처리 - waiting-room으로 이동');
                    // 일반 모드: 기존 방식 (sessionStorage + waiting-room)
                    sessionStorage.setItem("role", "client");
                    sessionStorage.setItem("stampImage", processedImageData);
                    sessionStorage.setItem("entryType", "stamp");
                    sessionStorage.setItem("selectedStampId", selectedStampId);
                    
                    // 대기실로 이동 시 입장 방식 파라미터 추가
                    location.href = "/waiting-room?entryType=stamp";
                }
            };
            img.src = selectedStampImage;
        }
        
        // 업로드 모드 토글
        function toggleUploadMode() {
            const uploadToggleBtn = document.getElementById('uploadToggleBtn');
            
            // 버튼이 비활성화된 경우 업로드 모드를 열지 않음
            if (uploadToggleBtn.disabled) {
                showError('이미 등록된 도장이 있습니다. 새 도장을 업로드하려면 먼저 기존 도장을 삭제해주세요.');
                return;
            }
            
            const uploadMode = document.getElementById('uploadMode');
            if (uploadMode.style.display === 'none') {
                uploadMode.style.display = 'block';
            } else {
                uploadMode.style.display = 'none';
            }
        }
        
        // 새 도장 업로드
        function uploadNewStamp() {
            const fileInput = document.getElementById("stampUpload");
            const file = fileInput.files[0];
            if (!file) {
                showError("도장 이미지를 선택하세요.");
                return;
            }

            // 파일 유효성 검사
            if (file.size <= 0) {
                showError("올바른 도장 이미지 파일을 선택하세요.");
                return;
            }

            if (!file.type.startsWith('image/')) {
                showError("이미지 파일만 업로드 가능합니다.");
                return;
            }

            // FormData로 파일 업로드
            const formData = new FormData();
            formData.append('file', file);

            // CSRF 토큰 가져오기
            const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            fetch('/stamp/api/upload', {
                method: 'POST',
                headers: {
                    [header]: token
                },
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    showSuccess('도장이 성공적으로 업로드되었습니다.');
                    // 업로드 모드 숨기기
                    document.getElementById('uploadMode').style.display = 'none';
                    // 파일 입력 초기화
                    fileInput.value = '';
                    // 도장 목록 새로고침
                    loadStampList();
                } else if (response.status === 400) {
                    // 기존 도장이 있어서 업로드가 거부된 경우
                    return response.text().then(errorMessage => {
                        showError('업로드 실패: 이미 등록된 도장이 있습니다. 새 도장을 업로드하려면 먼저 기존 도장을 삭제해주세요.');
                    });
                } else {
                    showError('도장 업로드에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('업로드 오류:', error);
                showError('도장 업로드 중 오류가 발생했습니다.');
            });
        }
        
        // 기존 함수 (호환성 유지)
        function enterWithStamp() {
            enterWithSelectedStamp();
        }

        const signCanvas = document.getElementById('signCanvas');
        const signCtx = signCanvas.getContext('2d', { alpha: true });
        let isDrawing = false;
        let hasSignature = false;

        // 터치 장치 지원 추가
        function setupCanvas() {
            // 마우스 이벤트
            signCanvas.addEventListener('mousedown', startDrawing);
            signCanvas.addEventListener('mousemove', draw);
            signCanvas.addEventListener('mouseup', stopDrawing);
            signCanvas.addEventListener('mouseout', stopDrawing);
            
            // 터치 이벤트
            signCanvas.addEventListener('touchstart', function(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = signCanvas.getBoundingClientRect();
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                signCanvas.dispatchEvent(mouseEvent);
            });
            
            signCanvas.addEventListener('touchmove', function(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                signCanvas.dispatchEvent(mouseEvent);
            });
            
            signCanvas.addEventListener('touchend', function(e) {
                e.preventDefault();
                const mouseEvent = new MouseEvent('mouseup');
                signCanvas.dispatchEvent(mouseEvent);
            });
        }
        
        function startDrawing(e) {
            isDrawing = true;
            signCtx.beginPath();
            const rect = signCanvas.getBoundingClientRect();
            signCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }
        
        function draw(e) {
            if (!isDrawing) return;
            signCtx.lineWidth = 2;
            signCtx.lineCap = "round";
            signCtx.strokeStyle = "black";
            
            const rect = signCanvas.getBoundingClientRect();
            signCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            signCtx.stroke();
        }
        
        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                hasSignature = true;
                signCtx.closePath();
            }
        }

        function clearSignature() {
            signCtx.clearRect(0, 0, signCanvas.width, signCanvas.height);
            hasSignature = false;
        }

        function enterWithSignature() {
            if (!hasSignature) {
                return showError("서명을 작성해주세요. 서명 없이는 입장할 수 없습니다.");
            }
            
            // 디버깅 로그 추가
            console.log('=== 서명으로 입장 시작 ===');
            console.log('invitationMode:', invitationMode);
            console.log('contractId:', contractId);
            console.log('consultingSessionId:', consultingSessionId);
            console.log('serverUrl:', serverUrl);
            
            // 추가 검증: 캔버스에 실제로 그려진 픽셀이 있는지 확인
            const imageData = signCtx.getImageData(0, 0, signCanvas.width, signCanvas.height).data;
            let hasDrawnPixels = false;
            
            // 이미지 데이터를 순회하면서 투명하지 않은 픽셀이 있는지 확인
            for (let i = 3; i < imageData.length; i += 4) {
                if (imageData[i] > 0) {  // 알파 채널 값이 0보다 크면 픽셀이 그려진 것
                    hasDrawnPixels = true;
                    break;
                }
            }
            
            if (!hasDrawnPixels) {
                return showError("서명이 너무 작거나 없습니다. 다시 작성해주세요.");
            }
            
            // 새 캔버스에 서명 복사하여 최적화
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = signCanvas.width;
            tempCanvas.height = signCanvas.height;
            const tempCtx = tempCanvas.getContext('2d', { alpha: true, willReadFrequently: true });
            
            // 투명 배경 설정
            tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
            tempCtx.drawImage(signCanvas, 0, 0);
            
            // PNG 형식으로 변환하여 저장 (투명도 유지)
            const signatureImage = tempCanvas.toDataURL('image/png');
            
            // 초대링크 모드인지 확인
            if (invitationMode && contractId) {
                console.log('초대링크 모드로 처리 - 서버로 POST 요청 전송');
                // 초대링크 모드: 서버로 POST 요청 전송
                submitEntryForm('signature', null, signatureImage);
            } else {
                console.log('일반 모드로 처리 - waiting-room으로 이동');
                // 일반 모드: 기존 방식 (sessionStorage + waiting-room)
                sessionStorage.setItem("role", "client");
                sessionStorage.setItem("signatureImage", signatureImage);
                sessionStorage.setItem("entryType", "signature");
                
                // 대기실로 이동 시 입장 방식 파라미터 추가
                location.href = "/waiting-room?entryType=signature";
            }
        }
        
        // 서버로 입장 완료 요청 전송 (초대링크 모드용)
        function submitEntryForm(entryType, stampData, signatureData) {
            console.log('=== submitEntryForm 시작 ===');
            console.log('entryType:', entryType);
            console.log('stampData length:', stampData ? stampData.length : 'null');
            console.log('signatureData length:', signatureData ? signatureData.length : 'null');
            
            const formData = new FormData();
            formData.append('entryType', entryType);
            
            if (stampData) {
                formData.append('stampData', stampData);
            }
            if (signatureData) {
                formData.append('signatureData', signatureData);
            }
            
            // CSRF 토큰 추가
            const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            
            console.log('POST 요청 전송 중...');
            
            fetch('/client-entry/complete', {
                method: 'POST',
                headers: {
                    [header]: token
                },
                body: formData
            })
            .then(response => {
                console.log('서버 응답:', response);
                console.log('response.redirected:', response.redirected);
                console.log('response.url:', response.url);
                
                if (response.redirected) {
                    console.log('리다이렉트 URL로 이동:', response.url);
                    // 서버에서 리다이렉트를 응답하면 해당 URL로 이동
                    window.location.href = response.url;
                } else if (response.ok) {
                    // 성공 시 응답 확인
                    console.log('입장 완료 요청 성공');
                } else {
                    console.error('응답 오류:', response.status, response.statusText);
                    showError('입장 처리 중 오류가 발생했습니다.');
                }
            })
            .catch(error => {
                console.error('입장 요청 오류:', error);
                showError('입장 처리 중 오류가 발생했습니다.');
            });
        }
        
        // 페이지 로드 시 캔버스 설정
        window.onload = function() {
            setupCanvas();
        };
    </script>
</body>
</html> 