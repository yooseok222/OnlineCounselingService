<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입 | 비상(Visang)</title>
    
    <!-- 부트스트랩 5 CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 부트스트랩 아이콘 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Google Fonts - Noto Sans KR -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
    <!-- 커스텀 CSS -->
    <link rel="stylesheet" th:href="@{/css/common/main.css}" />
    
    <!-- 정규식 패턴 조각 포함 -->
    <th:block th:replace="fragments/regex-patterns :: pattern-variables"></th:block>
    <th:block th:replace="fragments/regex-patterns :: validation-utils"></th:block>
    
    <style>
        .step-container {
            display: none;
        }
        .step-container.active {
            display: block;
        }
        .form-step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4rem; /* 5rem에서 4rem으로 감소 */
            position: relative;
            padding-top: 2rem; /* 3rem에서 2rem으로 감소 */
            padding-left: 20px; /* 좌측 여백 추가 */
            padding-right: 20px; /* 우측 여백 추가 */
        }
        .step-indicator {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 1;
            position: relative;
        }
        .step-indicator.active {
            background-color: #0d6efd;
            color: white;
        }
        .step-indicator.completed {
            background-color: #198754;
            color: white;
        }
        .step-line {
            position: absolute;
            top: 50%;
            left: 30px; /* 0에서 30px로 변경하여 왼쪽 여백 추가 */
            right: 30px; /* 0에서 30px로 변경하여 오른쪽 여백 추가 */
            height: 2px;
            background-color: #e9ecef;
            z-index: 0;
            transform: translateY(-50%);
        }
        .step-description {
            position: absolute;
            top: 45px;
            width: 120px;
            text-align: center;
            font-size: 0.85rem;
            transform: translateX(-40px);
        }
        .step-title {
            position: absolute;
            top: 48px; /* 50px에서 48px로 미세 조정 */
            width: 70px; /* 80px에서 70px로 더 감소 */
            text-align: center;
            font-size: 0.8rem; /* 0.85rem에서 0.8rem으로 더 감소 */
            left: 50%;
            transform: translateX(-50%);
            color: #495057;
        }
        
        /* 피드백 메시지 스타일 */
        .feedback-message {
            margin-top: 5px;
            font-size: 0.875rem;
        }
        .feedback-error {
            color: #dc3545;
            display: flex;
            align-items: center;
        }
        .feedback-success {
            color: #198754;
            display: flex;
            align-items: center;
        }
        .feedback-warning {
            color: #ffc107;
            display: flex;
            align-items: center;
        }
        .feedback-error::before, .feedback-success::before, .feedback-warning::before {
            font-family: "bootstrap-icons";
            margin-right: 5px;
        }
        .feedback-error::before {
            content: "\F623"; /* bootstrap-icons: exclamation-triangle */
        }
        .feedback-success::before {
            content: "\F270"; /* bootstrap-icons: check-circle */
        }
        .feedback-warning::before {
            content: "\F33A"; /* bootstrap-icons: info-circle */
        }
        .step-container h4 {
            margin-top: 60px;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container">
        <div class="row justify-content-center mt-5">
            <div class="col-md-8 col-lg-7">
                <div class="card shadow-sm">
                    <div class="card-body p-5">
                        <div class="text-center mb-5">
                            <h1 class="h3 fw-bold mb-3">회원가입</h1>
                            <p class="text-muted">전자계약 원스톱 서비스 비상(Visang)에 오신 것을 환영합니다</p>
                        </div>
                        
                        <!-- 단계 표시 -->
                        <div class="form-step-indicator mb-4">
                            <div class="step-line"></div>
                            <div class="step-indicator active" id="step1-indicator">
                                1
                                <span class="step-title">유형 선택</span>
                            </div>
                            <div class="step-indicator" id="step2-indicator">
                                2
                                <span class="step-title">정보 입력</span>
                            </div>
                            <div class="step-indicator" id="step3-indicator">
                                3
                                <span class="step-title">가입 완료</span>
                            </div>
                        </div>
                        
                        <!-- 회원가입 폼 -->
                        <form th:action="@{/register}" th:object="${userRegistrationRequest}" method="post" id="registerForm">
                            <!-- CSRF 토큰 명시적 추가 -->
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            
                            <!-- 직접 추가된 오류 메시지만 유지 -->
                            <div class="alert alert-danger" th:if="${error}" style="margin-bottom: 20px;" th:text="${error}">
                                Error message
                            </div>
                            
                            <!-- 1단계: 사용자 유형 선택 -->
                            <div class="step-container active" id="step1">
                                <div class="mb-4">
                                    <h4 class="mb-3">유형 선택</h4>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <div class="card h-100 border-2" id="userTypeCard" onclick="selectUserType('USER')">
                                                <div class="card-body text-center p-4">
                                                    <i class="bi bi-person-circle fs-1 mb-3"></i>
                                                    <h5 class="card-title">일반 사용자</h5>
                                                    <p class="card-text small text-muted">개인 고객으로 가입하고 상담 서비스를 이용합니다.</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="card h-100 border-2" id="businessTypeCard" onclick="selectUserType('BUSINESS')">
                                                <div class="card-body text-center p-4">
                                                    <i class="bi bi-building fs-1 mb-3"></i>
                                                    <h5 class="card-title">기업 관계자</h5>
                                                    <p class="card-text small text-muted">상담원 또는 관리자로 가입하여 서비스를 제공합니다.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 기업 관계자 유형 선택 (기업 관계자 선택시 표시) -->
                                <div class="mb-4" id="businessRoleSelection" style="display: none;">
                                    <h4 class="mb-3">기업 관계자 유형을 선택해주세요</h4>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <div class="card h-100 border-2" id="adminTypeCard" onclick="selectBusinessRole('ADMIN')">
                                                <div class="card-body text-center p-4">
                                                    <i class="bi bi-person-badge fs-1 mb-3"></i>
                                                    <h5 class="card-title">관리자</h5>
                                                    <p class="card-text small text-muted">기업 계정을 관리하고 상담원을 초대할 수 있습니다.</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="card h-100 border-2" id="agentTypeCard" onclick="selectBusinessRole('AGENT')">
                                                <div class="card-body text-center p-4">
                                                    <i class="bi bi-headset fs-1 mb-3"></i>
                                                    <h5 class="card-title">상담원</h5>
                                                    <p class="card-text small text-muted">고객에게 상담 서비스를 제공합니다. (초대코드 필요)</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <input type="hidden" th:field="*{userType}" id="userTypeInput">
                                
                                <div class="d-grid gap-2 mt-4">
                                    <button type="button" class="btn btn-primary" id="step1NextBtn" disabled>다음</button>
                                    <a th:href="@{/login}" class="btn btn-outline-secondary">로그인 페이지로</a>
                                </div>
                            </div>
                            
                            <!-- 2단계: 정보 입력 -->
                            <div class="step-container" id="step2">
                                <!-- 공통 정보 입력 -->
                                <div class="mb-4">
                                    <h4 class="mb-4">정보 입력</h4>
                                    
                                    <div class="mb-3">
                                        <label for="name" class="form-label">이름 <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="name" th:field="*{name}" required>
                                        <div class="feedback-message" id="nameFeedback"></div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="email" class="form-label">이메일 <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <input type="email" class="form-control" id="email" th:field="*{email}" required>
                                            <button type="button" class="btn btn-outline-secondary" id="checkEmailBtn">중복확인</button>
                                        </div>
                                        <div class="feedback-message" id="emailFeedback"></div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="password" class="form-label">비밀번호 <span class="text-danger">*</span></label>
                                        <input type="password" class="form-control" id="password" th:field="*{password}" required>
                                        <div class="form-text">비밀번호는 8자 이상이며, 대문자, 소문자, 숫자, 특수문자(!@#$%^&*)를 각각 하나 이상 포함해야 합니다.</div>
                                        <div class="feedback-message" id="passwordFeedback"></div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="passwordConfirm" class="form-label">비밀번호 확인 <span class="text-danger">*</span></label>
                                        <input type="password" class="form-control" id="passwordConfirm" required>
                                        <div class="feedback-message" id="passwordConfirmFeedback"></div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="phoneNumber" class="form-label">전화번호</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="phoneNumber" th:field="*{phoneNumber}" placeholder="010-XXXX-XXXX">
                                            <button type="button" class="btn btn-outline-secondary" id="checkPhoneBtn">중복확인</button>
                                        </div>
                                        <div class="feedback-message" id="phoneNumberFeedback"></div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="address" class="form-label">주소</label>
                                        <input type="text" class="form-control" id="address" th:field="*{address}">
                                        <div class="feedback-message" id="addressFeedback"></div>
                                    </div>
                                </div>
                                
                                <!-- 일반 사용자 추가 정보 -->
                                <div class="mb-4" id="userAdditionalInfo">
                                    <h4 class="mb-4">추가 정보</h4>
                                    
                                    <div class="mb-3">
                                        <label for="ssn" class="form-label">주민등록번호 <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="ssn" th:field="*{ssn}" placeholder="YYMMDD-1234567">
                                            <button type="button" class="btn btn-outline-secondary" id="checkSsnBtn">중복확인</button>
                                        </div>
                                        <div class="form-text">개인 식별 및 연령 확인용으로만 사용됩니다.</div>
                                        <div class="feedback-message" id="ssnFeedback"></div>
                                    </div>
                                </div>
                                
                                <!-- 관리자 추가 정보 -->
                                <div class="mb-4" id="adminAdditionalInfo" style="display: none;">
                                    <h4 class="mb-4">기업 정보</h4>
                                    
                                    <div class="mb-3">
                                        <label for="companyName" class="form-label">회사명 <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="companyName" th:field="*{companyName}">
                                        <div class="form-text">회사명은 2자 이상이어야 합니다.</div>
                                        <div class="feedback-message" id="companyNameFeedback"></div>
                                    </div>
                                </div>
                                
                                <!-- 상담원 추가 정보 -->
                                <div class="mb-4" id="agentAdditionalInfo" style="display: none;">
                                    <h4 class="mb-4">초대코드 정보</h4>
                                    
                                    <div class="mb-3">
                                        <label for="invitationCode" class="form-label">초대코드 <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="invitationCode" th:field="*{invitationCode}">
                                            <button type="button" class="btn btn-outline-secondary" id="verifyInvitationBtn">확인</button>
                                        </div>
                                        <div class="feedback-message" id="invitationFeedback">관리자에게 발급받은 초대코드를 입력해주세요.</div>
                                        <input type="hidden" id="companyId" th:field="*{companyId}">
                                    </div>
                                </div>
                                
                                <!-- 약관 및 정보 확인 동의 체크 -->
                                <div class="form-check mb-4">
                                    <input class="form-check-input" type="checkbox" id="agreeTerms">
                                    <label class="form-check-label" for="agreeTerms">
                                        입력하신 정보가 정확하며, 회원가입 안내 메일 발송에 동의합니다.
                                    </label>
                                </div>
                                <div class="d-grid gap-2 mt-4">
                                    <button type="button" class="btn btn-primary" id="step2NextBtn" disabled>다음</button>
                                    <button type="button" class="btn btn-outline-secondary" id="step2PrevBtn">이전</button>
                                </div>
                            </div>
                            
                            <!-- 3단계: 확인 및 제출 -->
                            <div class="step-container" id="step3">
                                <div class="mb-4">
                                    <h4 class="mb-4">가입 완료</h4>
                                    
                                    <div class="card mb-4">
                                        <div class="card-body">
                                            <h5 class="card-title mb-3">기본 정보</h5>
                                            <p class="mb-2">이름: <span id="confirmName"></span></p>
                                            <p class="mb-2">이메일: <span id="confirmEmail"></span></p>
                                            <p class="mb-2">전화번호: <span id="confirmPhone"></span></p>
                                            <p class="mb-2">주소: <span id="confirmAddress"></span></p>
                                        </div>
                                    </div>
                                    
                                    <div class="card mb-4" id="userConfirmInfo">
                                        <div class="card-body">
                                            <h5 class="card-title mb-3">추가 정보 (일반 사용자)</h5>
                                            <p class="mb-2">주민등록번호: <span id="confirmSsn"></span></p>
                                        </div>
                                    </div>
                                    
                                    <div class="card mb-4" id="adminConfirmInfo" style="display: none;">
                                        <div class="card-body">
                                            <h5 class="card-title mb-3">기업 정보 (관리자)</h5>
                                            <p class="mb-2">회사명: <span id="confirmCompanyName"></span></p>
                                        </div>
                                    </div>
                                    
                                    <div class="card mb-4" id="agentConfirmInfo" style="display: none;">
                                        <div class="card-body">
                                            <h5 class="card-title mb-3">기업 정보 (상담원)</h5>
                                            <p class="mb-2">초대코드: <span id="confirmInvitationCode"></span></p>
                                            <p class="mb-2">회사명: <span id="confirmAgentCompanyName"></span></p>
                                            <p class="mb-2">관리자: <span id="confirmAdminName"></span></p>
                                        </div>
                                    </div>
                                    
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle-fill me-2"></i>
                                        회원가입 후 이메일 인증이 필요합니다. 인증 이메일은 입력하신 이메일 주소로 발송됩니다.
                                    </div>
                                </div>
                                
                                <div class="d-grid gap-2 mt-4">
                                    <button type="submit" class="btn btn-primary">회원가입</button>
                                    <button type="button" class="btn btn-outline-secondary" id="step3PrevBtn">이전</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <a th:href="@{/}" class="text-decoration-none"><i class="bi bi-arrow-left me-1"></i> 메인으로 돌아가기</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 부트스트랩 5 JS 번들 (Popper 포함) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <script>
        // 전역 변수
        let selectedUserType = '';
        let emailVerified = false;
        let phoneVerified = false;
        let ssnVerified = false;
        let invitationVerified = false;
        let companyName = '';
        let adminName = '';
        
        // 전역 정규식 패턴은 fragments/regex-patterns.html에서 제공됨
        const COMPANY_NAME_MIN_LENGTH = 2;
        
        // 유효성 검증 오류 메시지
        const ERROR_MESSAGES = {
            name: '이름은 2~10자의 한글만 입력 가능합니다.',
            email: '유효한 이메일 형식이 아닙니다.',
            emailUnverified: '이메일 중복 확인이 필요합니다.',
            password: '비밀번호는 8자 이상이며, 대문자, 소문자, 숫자, 특수문자(!@#$%^&*)를 각각 하나 이상 포함해야 합니다.',
            passwordMismatch: '비밀번호가 일치하지 않습니다.',
            phone: '전화번호 형식이 올바르지 않습니다.',
            ssn: '주민등록번호 형식이 올바르지 않습니다.',
            companyName: '회사명은 2자 이상이어야 합니다.',
            invitationCode: '유효한 초대코드가 필요합니다.'
        };
        
        // 사용자 유형 선택
        function selectUserType(type) {
            console.log(`selectUserType 호출됨: type=${type}`);
            
            // 모든 카드의 선택 효과 제거
            const allCards = document.querySelectorAll('.card');
            console.log(`모든 카드 개수: ${allCards.length}`);
            allCards.forEach(card => {
                card.classList.remove('border-primary');
            });
            
            if (type === 'USER') {
                // 유형과 입력값 설정
                selectedUserType = 'USER';
                document.getElementById('userTypeInput').value = 'USER';
                
                // 사용자 카드 선택 효과 추가
                const userCard = document.getElementById('userTypeCard');
                if (userCard) {
                    console.log('사용자 카드를 찾았습니다. 효과를 추가합니다.');
                    userCard.classList.add('border-primary');
                } else {
                    console.error('사용자 카드를 찾을 수 없습니다!');
                }
                
                // 기업 역할 선택 영역 숨기기
                document.getElementById('businessRoleSelection').style.display = 'none';
                document.getElementById('step1NextBtn').disabled = false;
            } else if (type === 'BUSINESS') {
                // 비즈니스 카드 선택 효과 추가
                const businessCard = document.getElementById('businessTypeCard');
                if (businessCard) {
                    console.log('기업 관계자 카드를 찾았습니다. 효과를 추가합니다.');
                    businessCard.classList.add('border-primary');
                } else {
                    console.error('기업 관계자 카드를 찾을 수 없습니다!');
                }
                
                // 기업 역할 선택 영역 표시
                document.getElementById('businessRoleSelection').style.display = 'block';
                document.getElementById('step1NextBtn').disabled = true;
            }
        }
        
        // 기업 관계자 유형 선택
        function selectBusinessRole(role) {
            console.log(`selectBusinessRole 호출됨: role=${role}`);
            
            // 전역 변수 업데이트
            selectedUserType = role;
            document.getElementById('userTypeInput').value = role;
            
            // 비즈니스 카드는 계속 선택된 상태로 유지
            const businessCard = document.getElementById('businessTypeCard');
            if (businessCard) {
                businessCard.classList.add('border-primary');
            }
            
            // 비즈니스 역할 카드의 선택 효과만 제거 (다른 카드는 그대로 유지)
            const adminCard = document.getElementById('adminTypeCard');
            const agentCard = document.getElementById('agentTypeCard');
            
            if (adminCard) {
                adminCard.classList.remove('border-primary');
            }
            
            if (agentCard) {
                agentCard.classList.remove('border-primary');
            }
            
            // 선택된 카드에 효과 추가
            if (role === 'ADMIN' && adminCard) {
                console.log('관리자 카드를 선택했습니다.');
                adminCard.classList.add('border-primary');
            } else if (role === 'AGENT' && agentCard) {
                console.log('상담원 카드를 선택했습니다.');
                agentCard.classList.add('border-primary');
            }
            
            // 다음 버튼 활성화
            document.getElementById('step1NextBtn').disabled = false;
        }
        
        // 단계 변경
        function goToStep(step) {
            // 현재 단계 숨기기
            document.querySelectorAll('.step-container').forEach(container => {
                container.classList.remove('active');
            });
            
            // 새 단계 표시
            document.getElementById('step' + step).classList.add('active');
            
            // 단계 표시기 업데이트
            document.querySelectorAll('.step-indicator').forEach(indicator => {
                indicator.classList.remove('active', 'completed');
            });
            
            for (let i = 1; i < step; i++) {
                document.getElementById('step' + i + '-indicator').classList.add('completed');
            }
            document.getElementById('step' + step + '-indicator').classList.add('active');
            
            // 단계별 정보 표시
            if (step === 2) {
                // 사용자 유형에 따라 추가 정보 섹션 표시
                document.getElementById('userAdditionalInfo').style.display = selectedUserType === 'USER' ? 'block' : 'none';
                document.getElementById('adminAdditionalInfo').style.display = selectedUserType === 'ADMIN' ? 'block' : 'none';
                document.getElementById('agentAdditionalInfo').style.display = selectedUserType === 'AGENT' ? 'block' : 'none';
            } else if (step === 3) {
                // 확인 페이지에 정보 표시
                updateConfirmationInfo();
            }
        }
        
        // 확인 페이지 정보 업데이트
        function updateConfirmationInfo() {
            document.getElementById('confirmName').textContent = document.getElementById('name').value;
            document.getElementById('confirmEmail').textContent = document.getElementById('email').value;
            document.getElementById('confirmPhone').textContent = document.getElementById('phoneNumber').value || '(입력하지 않음)';
            document.getElementById('confirmAddress').textContent = document.getElementById('address').value || '(입력하지 않음)';
            
            // 사용자 유형별 정보
            document.getElementById('userConfirmInfo').style.display = selectedUserType === 'USER' ? 'block' : 'none';
            document.getElementById('adminConfirmInfo').style.display = selectedUserType === 'ADMIN' ? 'block' : 'none';
            document.getElementById('agentConfirmInfo').style.display = selectedUserType === 'AGENT' ? 'block' : 'none';
            
            if (selectedUserType === 'USER') {
                let ssnValue = document.getElementById('ssn').value;
                // 주민등록번호 뒷자리 마스킹
                if (ssnValue) {
                    let parts = ssnValue.split('-');
                    if (parts.length === 2) {
                        ssnValue = parts[0] + '-*******';
                    } else {
                        ssnValue = ssnValue.substring(0, 6) + '-*******';
                    }
                }
                document.getElementById('confirmSsn').textContent = ssnValue;
            } else if (selectedUserType === 'ADMIN') {
                document.getElementById('confirmCompanyName').textContent = document.getElementById('companyName').value;
            } else if (selectedUserType === 'AGENT') {
                document.getElementById('confirmInvitationCode').textContent = document.getElementById('invitationCode').value;
                document.getElementById('confirmAgentCompanyName').textContent = companyName || '(확인 필요)';
                document.getElementById('confirmAdminName').textContent = adminName || '(확인 필요)';
            }
        }
        
        // 폼 검증 함수 등에서 피드백 메시지를 설정하는 부분 수정
        function setFeedback(element, message, type) {
            if (!element) return;
            
            // type: 'error', 'success', 'warning'
            const iconMap = {
                'error': '<i class="bi bi-exclamation-triangle"></i>',
                'success': '<i class="bi bi-check-circle"></i>',
                'warning': '<i class="bi bi-info-circle"></i>'
            };
            
            // HTML 요소 직접 삽입 방식 사용
            element.innerHTML = iconMap[type] + ' ' + message;
            element.className = 'feedback-message feedback-' + type;
        }
        
        // 이메일 중복 확인 함수 수정
        function checkEmail() {
            const email = document.getElementById('email').value;
            const emailInput = document.getElementById('email');
            const feedbackElement = document.getElementById('emailFeedback');
            
            if (!email) {
                emailInput.classList.add('is-invalid');
                setFeedback(feedbackElement, '이메일을 입력해주세요.', 'error');
                return;
            }
            
            // 이메일 형식 검증
            if (!EMAIL_REGEX.test(email)) {
                emailInput.classList.add('is-invalid');
                setFeedback(feedbackElement, ERROR_MESSAGES.email, 'error');
                return;
            }
            
            // API 호출
            $.ajax({
                url: '/api/email/check',
                type: 'GET',
                data: { email: email },
                success: function(response) {
                    console.log('이메일 중복 체크 응답:', response);
                    // response는 ApiResponse 객체: {duplicated: boolean, message: string}
                    if (response.duplicated) {
                        emailInput.classList.add('is-invalid');
                        emailInput.classList.remove('is-valid');
                        setFeedback(feedbackElement, response.message || '이미 사용 중인 이메일입니다.', 'error');
                        emailVerified = false;
                        // 중복일 경우 다시 이메일 입력창에 포커스 유지
                        emailInput.focus();
                    } else {
                        emailInput.classList.remove('is-invalid');
                        emailInput.classList.add('is-valid');
                        setFeedback(feedbackElement, response.message || '사용 가능한 이메일입니다.', 'success');
                        emailVerified = true;
                        // 중복이 아니면 다음 입력칸(비밀번호)으로 포커스 이동
                        const nextField = document.getElementById('password');
                        if(nextField){
                            nextField.focus();
                        }
                    }
                    updateStep2ButtonState(); // 버튼 상태 업데이트
                },
                error: function() {
                    emailInput.classList.add('is-invalid');
                    emailInput.classList.remove('is-valid');
                    setFeedback(feedbackElement, '이메일 확인 중 오류가 발생했습니다. 다시 시도해주세요.', 'error');
                    emailVerified = false;
                }
            });
        }
        
        // 전화번호 중복 확인 함수
        function checkPhoneNumber() {
            const phoneNumber = document.getElementById('phoneNumber').value;
            const phoneInput = document.getElementById('phoneNumber');
            const feedbackElement = document.getElementById('phoneNumberFeedback');
            
            if (!phoneNumber) {
                phoneVerified = true; // 전화번호가 없으면 검증 통과로 처리
                phoneInput.classList.remove('is-invalid');
                phoneInput.classList.remove('is-valid');
                setFeedback(feedbackElement, '', '');
                return;
            }
            
            // 전화번호 형식 검증
            if (!PHONE_REGEX.test(phoneNumber)) {
                phoneInput.classList.add('is-invalid');
                phoneInput.classList.remove('is-valid');
                setFeedback(feedbackElement, ERROR_MESSAGES.phone, 'error');
                phoneVerified = false;
                return;
            }
            
            // API 호출
            $.ajax({
                url: '/api/phone/check',
                type: 'GET',
                data: { phoneNumber: phoneNumber },
                success: function(response) {
                    console.log('전화번호 중복 체크 응답:', response);
                    // response는 ApiResponse 객체: {duplicated: boolean, message: string}
                    if (response.duplicated) {
                        phoneInput.classList.add('is-invalid');
                        phoneInput.classList.remove('is-valid');
                        setFeedback(feedbackElement, response.message || '이미 사용 중인 전화번호입니다.', 'error');
                        phoneVerified = false;
                        // 중복일 경우 다시 전화번호 입력창에 포커스 유지
                        phoneInput.focus();
                    } else {
                        phoneInput.classList.remove('is-invalid');
                        phoneInput.classList.add('is-valid');
                        setFeedback(feedbackElement, response.message || '사용 가능한 전화번호입니다.', 'success');
                        phoneVerified = true;
                        // 중복이 아니면 다음 입력칸(주소)으로 포커스 이동
                        const nextField = document.getElementById('address');
                        if(nextField){
                            nextField.focus();
                        }
                    }
                    updateStep2ButtonState(); // 버튼 상태 업데이트
                },
                error: function() {
                    phoneInput.classList.add('is-invalid');
                    phoneInput.classList.remove('is-valid');
                    setFeedback(feedbackElement, '전화번호 확인 중 오류가 발생했습니다. 다시 시도해주세요.', 'error');
                    phoneVerified = false;
                }
            });
        }
        
        // 주민번호 중복 확인 함수
        function checkSsn() {
            const ssn = document.getElementById('ssn').value;
            const ssnInput = document.getElementById('ssn');
            const feedbackElement = document.getElementById('ssnFeedback');
            
            if (!ssn) {
                ssnInput.classList.add('is-invalid');
                ssnInput.classList.remove('is-valid');
                setFeedback(feedbackElement, '주민등록번호는 필수 입력 항목입니다.', 'error');
                ssnVerified = false;
                return;
            }
            
            // 주민번호 형식 검증
            if (!SSN_REGEX.test(ssn)) {
                ssnInput.classList.add('is-invalid');
                ssnInput.classList.remove('is-valid');
                setFeedback(feedbackElement, ERROR_MESSAGES.ssn, 'error');
                ssnVerified = false;
                return;
            }
            
            // API 호출
            $.ajax({
                url: '/api/ssn/check',
                type: 'GET',
                data: { ssn: ssn },
                success: function(response) {
                    console.log('주민번호 중복 체크 응답:', response);
                    // response는 ApiResponse 객체: {duplicated: boolean, message: string}
                    if (response.duplicated) {
                        ssnInput.classList.add('is-invalid');
                        ssnInput.classList.remove('is-valid');
                        setFeedback(feedbackElement, response.message || '이미 사용 중인 주민등록번호입니다.', 'error');
                        ssnVerified = false;
                        // 중복일 경우 다시 주민번호 입력창에 포커스 유지
                        ssnInput.focus();
                    } else {
                        ssnInput.classList.remove('is-invalid');
                        ssnInput.classList.add('is-valid');
                        setFeedback(feedbackElement, response.message || '사용 가능한 주민등록번호입니다.', 'success');
                        ssnVerified = true;
                    }
                    updateStep2ButtonState(); // 버튼 상태 업데이트
                },
                error: function() {
                    ssnInput.classList.add('is-invalid');
                    ssnInput.classList.remove('is-valid');
                    setFeedback(feedbackElement, '주민등록번호 확인 중 오류가 발생했습니다. 다시 시도해주세요.', 'error');
                    ssnVerified = false;
                }
            });
        }
        
        // 초대코드 검증 함수
        function verifyInvitationCode() {
            const invitationCode = document.getElementById('invitationCode').value;
            const invitationInput = document.getElementById('invitationCode');
            const feedbackElement = document.getElementById('invitationFeedback');
            
            if (!invitationCode) {
                invitationInput.classList.add('is-invalid');
                invitationInput.classList.remove('is-valid');
                setFeedback(feedbackElement, '초대코드를 입력해주세요.', 'error');
                return;
            }
            
            // API 호출
            $.ajax({
                url: '/api/invitation/verify',
                type: 'POST',
                data: { code: invitationCode },
                success: function(response) {
                    if (response.valid) {
                        // 성공 시 팝업 표시
                        Swal.fire({
                            title: '초대코드 확인',
                            html: `
                                <div class="text-start">
                                    <p><strong>회사명:</strong> ${response.companyName}</p>
                                    <p><strong>관리자:</strong> ${response.adminName}</p>
                                </div>
                                <p class="mt-3">위 정보가 맞습니까?</p>
                            `,
                            icon: 'question',
                            showCancelButton: false,
                            confirmButtonText: '확인'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                // 회사 정보 저장
                                document.getElementById('companyId').value = response.companyId;
                                companyName = response.companyName;
                                adminName = response.adminName;
                                
                                invitationInput.classList.remove('is-invalid');
                                invitationInput.classList.add('is-valid');
                                setFeedback(feedbackElement, `확인된 초대코드 (${response.companyName})`, 'success');
                                invitationVerified = true;
                                updateStep2ButtonState(); // 버튼 상태 업데이트
                            }
                        });
                    } else {
                        invitationInput.classList.add('is-invalid');
                        invitationInput.classList.remove('is-valid');
                        setFeedback(feedbackElement, response.errorMessage || '유효하지 않은 초대코드입니다.', 'error');
                        invitationVerified = false;
                        updateStep2ButtonState(); // 버튼 상태 업데이트
                    }
                },
                error: function() {
                    invitationInput.classList.add('is-invalid');
                    invitationInput.classList.remove('is-valid');
                    setFeedback(feedbackElement, '초대코드 확인 중 오류가 발생했습니다. 다시 시도해주세요.', 'error');
                    invitationVerified = false;
                }
            });
        }
        
        // 단계 2 필수 필드 검증
        function validateStep2() {
            const requiredFields = ['name', 'email', 'password', 'passwordConfirm'];
            let isValid = true;
            
            // 공통 필수 필드 검증
            for (const field of requiredFields) {
                const element = document.getElementById(field);
                const feedbackElement = document.getElementById(field + 'Feedback');
                
                if (!element.value) {
                    element.classList.add('is-invalid');
                    element.classList.remove('is-valid');
                    setFeedback(feedbackElement, '필수 입력 항목입니다.', 'error');
                    isValid = false;
                } else {
                    // 필드 타입별 정규식 검증
                    if (field === 'name') {
                        if (!NAME_REGEX.test(element.value)) {
                            element.classList.add('is-invalid');
                            element.classList.remove('is-valid');
                            setFeedback(feedbackElement, ERROR_MESSAGES.name, 'error');
                            isValid = false;
                        } else {
                            element.classList.remove('is-invalid');
                            element.classList.add('is-valid');
                            setFeedback(feedbackElement, '올바른 이름 형식입니다.', 'success');
                        }
                    } else if (field === 'email') {
                        if (!EMAIL_REGEX.test(element.value)) {
                            element.classList.add('is-invalid');
                            element.classList.remove('is-valid');
                            setFeedback(feedbackElement, ERROR_MESSAGES.email, 'error');
                            isValid = false;
                        } else if (!emailVerified) {
                            // 이메일 중복 확인 강제 - 모든 유형에서 필수
                            element.classList.add('is-invalid');
                            element.classList.remove('is-valid');
                            setFeedback(feedbackElement, '이메일 중복 확인을 완료해주세요.', 'warning');
                            isValid = false;
                        } else {
                            element.classList.remove('is-invalid');
                            element.classList.add('is-valid');
                            setFeedback(feedbackElement, '확인된 이메일입니다.', 'success');
                        }
                    } else if (field === 'password') {
                        if (!PASSWORD_REGEX.test(element.value)) {
                            element.classList.add('is-invalid');
                            element.classList.remove('is-valid');
                            setFeedback(feedbackElement, ERROR_MESSAGES.password, 'error');
                            isValid = false;
                        } else {
                            element.classList.remove('is-invalid');
                            element.classList.add('is-valid');
                            setFeedback(feedbackElement, '안전한 비밀번호입니다.', 'success');
                        }
                    } else if (field === 'passwordConfirm') {
                        const passwordElement = document.getElementById('password');
                        if (element.value !== passwordElement.value) {
                            element.classList.add('is-invalid');
                            element.classList.remove('is-valid');
                            setFeedback(feedbackElement, ERROR_MESSAGES.passwordMismatch, 'error');
                            isValid = false;
                        } else if (PASSWORD_REGEX.test(passwordElement.value)) {
                            element.classList.remove('is-invalid');
                            element.classList.add('is-valid');
                            setFeedback(feedbackElement, '비밀번호가 일치합니다.', 'success');
                        }
                    }
                }
            }
            
            // 전화번호 검증 및 중복 확인 강제 (선택 사항이지만 입력했으면 중복 확인 필수)
            const phoneNumberElement = document.getElementById('phoneNumber');
            const phoneNumberFeedback = document.getElementById('phoneNumberFeedback');
            if (phoneNumberElement.value) {
                if (!PHONE_REGEX.test(phoneNumberElement.value)) {
                    phoneNumberElement.classList.add('is-invalid');
                    phoneNumberElement.classList.remove('is-valid');
                    setFeedback(phoneNumberFeedback, ERROR_MESSAGES.phone, 'error');
                    isValid = false;
                } else if (!phoneVerified) {
                    // 전화번호를 입력했으면 중복 확인 필수
                    phoneNumberElement.classList.add('is-invalid');
                    phoneNumberElement.classList.remove('is-valid');
                    setFeedback(phoneNumberFeedback, '전화번호 중복 확인을 완료해주세요.', 'warning');
                    isValid = false;
                } else {
                    phoneNumberElement.classList.remove('is-invalid');
                    phoneNumberElement.classList.add('is-valid');
                    setFeedback(phoneNumberFeedback, '확인된 전화번호입니다.', 'success');
                }
            } else {
                // 전화번호를 입력하지 않았으면 검증 통과
                phoneNumberElement.classList.remove('is-invalid');
                phoneNumberElement.classList.remove('is-valid');
                setFeedback(phoneNumberFeedback, '', '');
                phoneVerified = true; // 빈 값일 때는 검증 통과로 처리
            }
            
            // 사용자 유형별 필수 필드 검증
            if (selectedUserType === 'USER') {
                // 일반 사용자는 주민등록번호 필수이며 중복 확인도 필수
                const ssnElement = document.getElementById('ssn');
                const ssnFeedback = document.getElementById('ssnFeedback');
                
                if (!ssnElement.value) {
                    ssnElement.classList.add('is-invalid');
                    ssnElement.classList.remove('is-valid');
                    setFeedback(ssnFeedback, '주민등록번호는 필수 입력 항목입니다.', 'error');
                    isValid = false;
                } else if (!SSN_REGEX.test(ssnElement.value)) {
                    ssnElement.classList.add('is-invalid');
                    ssnElement.classList.remove('is-valid');
                    setFeedback(ssnFeedback, ERROR_MESSAGES.ssn, 'error');
                    isValid = false;
                } else if (!ssnVerified) {
                    // 주민번호 중복 확인 강제 - 일반 사용자만
                    ssnElement.classList.add('is-invalid');
                    ssnElement.classList.remove('is-valid');
                    setFeedback(ssnFeedback, '주민등록번호 중복 확인을 완료해주세요.', 'warning');
                    isValid = false;
                } else {
                    ssnElement.classList.remove('is-invalid');
                    ssnElement.classList.add('is-valid');
                    setFeedback(ssnFeedback, '확인된 주민등록번호입니다.', 'success');
                }
            } else if (selectedUserType === 'ADMIN') {
                // 관리자는 회사명 필수
                const companyNameElement = document.getElementById('companyName');
                const companyNameFeedback = document.getElementById('companyNameFeedback');
                
                if (!companyNameElement.value) {
                    companyNameElement.classList.add('is-invalid');
                    companyNameElement.classList.remove('is-valid');
                    setFeedback(companyNameFeedback, '회사명은 필수 입력 항목입니다.', 'error');
                    isValid = false;
                } else if (companyNameElement.value.length < COMPANY_NAME_MIN_LENGTH) {
                    companyNameElement.classList.add('is-invalid');
                    companyNameElement.classList.remove('is-valid');
                    setFeedback(companyNameFeedback, ERROR_MESSAGES.companyName, 'error');
                    isValid = false;
                } else {
                    companyNameElement.classList.remove('is-invalid');
                    companyNameElement.classList.add('is-valid');
                    setFeedback(companyNameFeedback, '올바른 회사명입니다.', 'success');
                }
            } else if (selectedUserType === 'AGENT') {
                // 상담사는 초대코드 필수
                const invitationCodeElement = document.getElementById('invitationCode');
                const invitationFeedback = document.getElementById('invitationFeedback');
                
                if (!invitationCodeElement.value) {
                    invitationCodeElement.classList.add('is-invalid');
                    invitationCodeElement.classList.remove('is-valid');
                    setFeedback(invitationFeedback, '초대코드는 필수 입력 항목입니다.', 'error');
                    isValid = false;
                } else if (!invitationVerified) {
                    invitationCodeElement.classList.add('is-invalid');
                    invitationCodeElement.classList.remove('is-valid');
                    setFeedback(invitationFeedback, '초대코드 확인을 완료해주세요.', 'warning');
                    isValid = false;
                } else {
                    invitationCodeElement.classList.remove('is-invalid');
                    invitationCodeElement.classList.add('is-valid');
                    setFeedback(invitationFeedback, '확인된 초대코드', 'success');
                }
            }
            
            // 검증 결과가 유효하지 않은 경우 사용자에게 알림
            if (!isValid) {
                const invalidField = document.querySelector('.is-invalid');
                if (invalidField) {
                    invalidField.focus();
                    window.scrollTo({
                        top: invalidField.offsetTop - 100,
                        behavior: 'smooth'
                    });
                    
                    // 중복 확인이 필요한 경우 추가 메시지 표시
                    const feedbackText = invalidField.nextElementSibling?.textContent || '';
                    if (feedbackText.includes('중복 확인을 완료해주세요')) {
                        Swal.fire({
                            title: '중복 확인 필요',
                            text: '모든 필수 항목의 중복 확인을 완료한 후 다음 단계로 진행할 수 있습니다.',
                            icon: 'warning',
                            confirmButtonText: '확인'
                        });
                    }
                }
            }
            
            return isValid;
        }
        
        // 폼 제출 전 최종 검증
        function validateBeforeSubmit() {
            console.log('폼 제출 전 최종 검증 시작');
            
            let isValid = true;
            
            // userType 값 확인 및 강제 설정
            const userTypeInput = document.getElementById('userTypeInput');
            if (!userTypeInput.value || userTypeInput.value !== selectedUserType) {
                console.log(`userTypeInput 값 수정: '${userTypeInput.value}' -> '${selectedUserType}'`);
                userTypeInput.value = selectedUserType;
            }
            
            // 사용자 유형 확인
            if (!selectedUserType || !userTypeInput.value) {
                console.error('사용자 유형이 선택되지 않았습니다.');
                alert('사용자 유형을 선택해주세요.');
                goToStep(1); // 단계 1로 돌아가기
                return false;
            }
            
            // validateStep2 함수를 호출하여 모든 필드를 검증
            if (!validateStep2()) {
                console.error('입력 필드 검증 실패');
                goToStep(2); // 단계 2로 돌아가기
                return false;
            }
            
            // 이메일 중복 확인 상태 검증
            if (!emailVerified) {
                console.error('이메일 중복 확인이 완료되지 않았습니다.');
                alert('이메일 중복 확인이 필요합니다.');
                goToStep(2); // 단계 2로 돌아가기
                return false;
            }
            
            // 사용자 유형별 추가 검증
            if (selectedUserType === 'AGENT' && !invitationVerified) {
                console.error('초대코드 확인이 완료되지 않았습니다.');
                alert('초대코드 확인이 필요합니다.');
                goToStep(2); // 단계 2로 돌아가기
                return false;
            }
            
            if (selectedUserType === 'AGENT' && !document.getElementById('companyId').value) {
                console.error('회사 ID가 설정되지 않았습니다.');
                alert('초대코드 확인 후 다시 시도해주세요.');
                goToStep(2); // 단계 2로 돌아가기
                return false;
            }
            
            console.log('폼 제출 전 최종 검증 완료');
            return true;
        }
        
        // 전화번호 하이픈 자동 추가 함수
        function formatPhoneNumber(input) {
            // 숫자만 추출
            const numbers = input.value.replace(/[^0-9]/g, '');
            
            // 길이에 따라 하이픈 추가
            if (numbers.length <= 3) {
                input.value = numbers;
            } else if (numbers.length <= 7) {
                input.value = numbers.slice(0, 3) + '-' + numbers.slice(3);
            } else {
                input.value = numbers.slice(0, 3) + '-' + numbers.slice(3, 7) + '-' + numbers.slice(7, 11);
            }
        }
        
        // 주민등록번호 하이픈 자동 추가 함수
        function formatSsn(input) {
            // 숫자만 추출
            const numbers = input.value.replace(/[^0-9]/g, '');
            
            // 길이에 따라 하이픈 추가
            if (numbers.length <= 6) {
                input.value = numbers;
            } else {
                input.value = numbers.slice(0, 6) + '-' + numbers.slice(6, 13);
            }
        }
        
        // 단계 2 버튼 상태 업데이트 함수
        function updateStep2ButtonState() {
            const step2NextBtn = document.getElementById('step2NextBtn');
            const agreeTerms = document.getElementById('agreeTerms');
            
            // 기본 필수 필드들이 모두 입력되었는지 확인
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const passwordConfirm = document.getElementById('passwordConfirm').value;
            
            // 기본 조건: 필수 필드 입력 + 약관 동의
            let canProceed = name && email && password && passwordConfirm && agreeTerms.checked;
            
            // 중복 확인 조건 체크
            if (canProceed) {
                // 이메일 중복 확인은 모든 유형에서 필수
                if (!emailVerified) {
                    canProceed = false;
                }
                
                // 전화번호가 입력되었으면 중복 확인 필수
                const phoneNumber = document.getElementById('phoneNumber').value;
                if (phoneNumber && !phoneVerified) {
                    canProceed = false;
                }
                
                // 사용자 유형별 조건
                if (selectedUserType === 'USER') {
                    const ssn = document.getElementById('ssn').value;
                    if (!ssn || !ssnVerified) {
                        canProceed = false;
                    }
                } else if (selectedUserType === 'ADMIN') {
                    const companyName = document.getElementById('companyName').value;
                    if (!companyName || companyName.length < COMPANY_NAME_MIN_LENGTH) {
                        canProceed = false;
                    }
                } else if (selectedUserType === 'AGENT') {
                    const invitationCode = document.getElementById('invitationCode').value;
                    if (!invitationCode || !invitationVerified) {
                        canProceed = false;
                    }
                }
                
                // 비밀번호 검증
                if (!PASSWORD_REGEX.test(password) || password !== passwordConfirm) {
                    canProceed = false;
                }
            }
            
            step2NextBtn.disabled = !canProceed;
        }
        
        // 이벤트 리스너 등록
        document.addEventListener('DOMContentLoaded', function() {
            // 초기 버튼 상태 설정
            updateStep2ButtonState();
            
            // 폼 내 Enter 키 기본 제출 방지 (중복 확인 단축키 제외)
            const registerForm = document.getElementById('registerForm');
            registerForm.addEventListener('keydown', function(e){
                if(e.key !== 'Enter') return;
                const id = e.target.id;
                // 중복 확인 전용 필드(email / phoneNumber / ssn)는 개별 리스너에서 처리 → 여기서는 무시
                if(id === 'email' || id === 'phoneNumber' || id === 'ssn'){
                    return;
                }

                // 기본 동작 취소 (폼 제출 방지)
                e.preventDefault();

                // setTimeout 으로 문자 입력이 commit 된 뒤에 포커스 이동
                setTimeout(() => {
                    const currentStep = e.target.closest('.step-container');
                    if(!currentStep) return;

                    const focusable = Array.from(currentStep.querySelectorAll('input:not([type="hidden"]), select, textarea, button'))
                                           .filter(el => !el.disabled && el.offsetParent !== null);
                    const currentIndex = focusable.indexOf(e.target);
                    if(currentIndex > -1){
                        const nextEl = focusable[currentIndex + 1];
                        if(nextEl){
                            nextEl.focus();
                        }
                    }
                }, 0);
            });

            // 동의 체크박스 상태에 따라 다음 버튼 활성화
            const agreeCheckbox = document.getElementById('agreeTerms');
            const step2NextBtnEl = document.getElementById('step2NextBtn');
            agreeCheckbox.addEventListener('change', function(){
                step2NextBtnEl.disabled = !this.checked;
                updateStep2ButtonState(); // 버튼 상태 업데이트
            });
            
            // 필수 입력 필드들에 실시간 검증 추가
            document.getElementById('name').addEventListener('input', updateStep2ButtonState);
            document.getElementById('password').addEventListener('input', updateStep2ButtonState);
            document.getElementById('passwordConfirm').addEventListener('input', updateStep2ButtonState);
            document.getElementById('companyName').addEventListener('input', updateStep2ButtonState);

            // 단계 1 -> 단계 2
            document.getElementById('step1NextBtn').addEventListener('click', function() {
                goToStep(2);
            });
            
            // 단계 2 -> 단계 1
            document.getElementById('step2PrevBtn').addEventListener('click', function() {
                goToStep(1);
            });
            
            // 단계 2 -> 단계 3
            document.getElementById('step2NextBtn').addEventListener('click', function() {
                // 폼 검증 실행
                if (validateStep2()) {
                    // 모든 필드가 유효한 경우에만 다음 단계로 진행
                    
                    // userType 값 확인 및 설정
                    const userTypeInput = document.getElementById('userTypeInput');
                    if (!userTypeInput.value || userTypeInput.value !== selectedUserType) {
                        console.log(`단계 3 이동 전 userTypeInput 값 수정: '${userTypeInput.value}' -> '${selectedUserType}'`);
                        userTypeInput.value = selectedUserType;
                    }
                    
                    // 확인 페이지 정보 갱신 전 다시 한번 검증
                    if (validateBeforeSubmit()) {
                        goToStep(3);
                    }
                } else {
                    // 유효성 검사 실패 시 오류 메시지를 사용자에게 보여줌
                    const invalidField = document.querySelector('.is-invalid');
                    if (invalidField) {
                        invalidField.focus();
                        // 첫 번째 오류 필드로 스크롤
                        window.scrollTo({
                            top: invalidField.offsetTop - 100,
                            behavior: 'smooth'
                        });
                    }
                }
            });
            
            // 단계 3 -> 단계 2
            document.getElementById('step3PrevBtn').addEventListener('click', function() {
                goToStep(2);
            });
            
            // 이메일 중복 확인
            document.getElementById('checkEmailBtn').addEventListener('click', checkEmail);
            // Enter 키로 이메일 중복 확인
            document.getElementById('email').addEventListener('keydown', function(e){
                if(e.key === 'Enter'){
                    e.preventDefault();
                    e.stopPropagation();
                    checkEmail();
                }
            });

            /* -------------------- 비밀번호 즉시 검증 -------------------- */
            function validatePasswordInstant() {
                const pwdEl = document.getElementById('password');
                const feedbackEl = document.getElementById('passwordFeedback');
                if(!pwdEl.value){
                    setFeedback(feedbackEl, '비밀번호를 입력해주세요.', 'error');
                    pwdEl.classList.add('is-invalid');
                    pwdEl.classList.remove('is-valid');
                    return false;
                }
                if(PASSWORD_REGEX.test(pwdEl.value)){
                    setFeedback(feedbackEl, '안전한 비밀번호입니다.', 'success');
                    pwdEl.classList.remove('is-invalid');
                    pwdEl.classList.add('is-valid');
                    return true;
                } else {
                    setFeedback(feedbackEl, ERROR_MESSAGES.password, 'error');
                    pwdEl.classList.add('is-invalid');
                    pwdEl.classList.remove('is-valid');
                    return false;
                }
            }

            function validatePasswordConfirmInstant() {
                const pwdEl = document.getElementById('password');
                const confirmEl = document.getElementById('passwordConfirm');
                const feedbackEl = document.getElementById('passwordConfirmFeedback');

                if(!confirmEl.value){
                    setFeedback(feedbackEl, '비밀번호 확인을 입력해주세요.', 'error');
                    confirmEl.classList.add('is-invalid');
                    confirmEl.classList.remove('is-valid');
                    return false;
                }
                if(confirmEl.value !== pwdEl.value){
                    setFeedback(feedbackEl, ERROR_MESSAGES.passwordMismatch, 'error');
                    confirmEl.classList.add('is-invalid');
                    confirmEl.classList.remove('is-valid');
                    return false;
                }
                if(PASSWORD_REGEX.test(pwdEl.value)){
                    setFeedback(feedbackEl, '비밀번호가 일치합니다.', 'success');
                    confirmEl.classList.remove('is-invalid');
                    confirmEl.classList.add('is-valid');
                    return true;
                } else {
                    setFeedback(feedbackEl, ERROR_MESSAGES.password, 'warning');
                    confirmEl.classList.remove('is-valid');
                    confirmEl.classList.add('is-invalid');
                    return false;
                }
            }

            // Enter 키로 비밀번호 정규식 검증
            document.getElementById('password').addEventListener('keydown', function(e){
                if(e.key === 'Enter'){
                    e.preventDefault();
                    e.stopPropagation();
                    if(validatePasswordInstant()){
                        document.getElementById('passwordConfirm').focus();
                    }
                }
            });

            // Enter 키로 비밀번호 확인 검증
            document.getElementById('passwordConfirm').addEventListener('keydown', function(e){
                if(e.key === 'Enter'){
                    e.preventDefault();
                    e.stopPropagation();
                    const isOk = validatePasswordConfirmInstant();
                    if(isOk){
                        // 다음 입력 필드(전화번호)로 포커스 이동
                        const nextEl = document.getElementById('phoneNumber');
                        if(nextEl){
                            nextEl.focus();
                        }
                    }
                }
            });
            
            // 전화번호 중복 확인
            document.getElementById('checkPhoneBtn').addEventListener('click', checkPhoneNumber);
            // Enter 키로 전화번호 중복 확인
            document.getElementById('phoneNumber').addEventListener('keydown', function(e){
                if(e.key === 'Enter'){
                    e.preventDefault();
                    e.stopPropagation();
                    checkPhoneNumber();
                }
            });
            
            // 주민번호 중복 확인
            document.getElementById('checkSsnBtn').addEventListener('click', checkSsn);
            // Enter 키로 주민번호 중복 확인
            document.getElementById('ssn').addEventListener('keydown', function(e){
                if(e.key === 'Enter'){
                    e.preventDefault();
                    e.stopPropagation();
                    checkSsn();
                }
            });
            
            // 초대코드 확인
            document.getElementById('verifyInvitationBtn').addEventListener('click', verifyInvitationCode);
            // Enter 키로 초대코드 확인
            document.getElementById('invitationCode').addEventListener('keydown', function(e){
                if(e.key === 'Enter'){
                    e.preventDefault();
                    e.stopPropagation();
                    verifyInvitationCode();
                }
            });
            
            // 이메일 필드 변경 시 중복 확인 상태 초기화
            document.getElementById('email').addEventListener('input', function() {
                emailVerified = false;
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
                setFeedback(document.getElementById('emailFeedback'), '이메일 중복 확인이 필요합니다.', 'warning');
                updateStep2ButtonState();
            });
            
            // 전화번호 필드 변경 시 중복 확인 상태 초기화 및 하이픈 자동 추가
            const phoneNumberInput = document.getElementById('phoneNumber');
            phoneNumberInput.addEventListener('input', function() {
                phoneVerified = false;
                if (this.value) {
                    this.classList.remove('is-valid');
                    this.classList.add('is-invalid');
                    setFeedback(document.getElementById('phoneNumberFeedback'), '전화번호 중복 확인이 필요합니다.', 'warning');
                    formatPhoneNumber(this);
                } else {
                    this.classList.remove('is-invalid');
                    this.classList.remove('is-valid');
                    setFeedback(document.getElementById('phoneNumberFeedback'), '', '');
                    phoneVerified = true; // 빈 값일 때는 검증 통과
                }
                updateStep2ButtonState();
            });
            
            // 주민번호 필드 변경 시 중복 확인 상태 초기화 및 하이픈 자동 추가
            const ssnInput = document.getElementById('ssn');
            ssnInput.addEventListener('input', function() {
                ssnVerified = false;
                if (this.value) {
                    this.classList.remove('is-valid');
                    this.classList.add('is-invalid');
                    setFeedback(document.getElementById('ssnFeedback'), '주민등록번호 중복 확인이 필요합니다.', 'warning');
                    formatSsn(this);
                } else {
                    this.classList.remove('is-valid');
                    this.classList.add('is-invalid');
                    setFeedback(document.getElementById('ssnFeedback'), '주민등록번호는 필수 입력 항목입니다.', 'error');
                }
                updateStep2ButtonState();
            });
            
            // 초대코드 필드 변경 시 확인 상태 초기화
            document.getElementById('invitationCode').addEventListener('input', function() {
                invitationVerified = false;
                if (this.value) {
                    this.classList.remove('is-valid');
                    this.classList.add('is-invalid');
                    setFeedback(document.getElementById('invitationFeedback'), '초대코드 확인이 필요합니다.', 'warning');
                } else {
                    this.classList.remove('is-valid');
                    this.classList.add('is-invalid');
                    setFeedback(document.getElementById('invitationFeedback'), '초대코드는 필수 입력 항목입니다.', 'error');
                }
                updateStep2ButtonState();
            });
            
            // 폼 제출 이벤트 리스너 추가
            if(registerForm) {
                registerForm.addEventListener('submit', function(e) {
                    console.log('폼 제출 시작');
                    
                    // 먼저 이벤트를 중지하여 검증을 수행
                    e.preventDefault();
                    
                    // 서버 오류 메시지가 표시되는 요소 숨기기
                    const errorAlerts = document.querySelectorAll('.alert.alert-danger');
                    if (errorAlerts) {
                        errorAlerts.forEach(alert => {
                            alert.style.display = 'none';
                        });
                    }
                    
                    // userType 값을 명시적으로 확인하고 설정
                    const userTypeInput = document.getElementById('userTypeInput');
                    console.log(`폼 제출 시 userType 확인: ${userTypeInput.value}, selectedUserType: ${selectedUserType}`);
                    
                    if (!userTypeInput.value || userTypeInput.value !== selectedUserType) {
                        console.log(`userType 값 수정: '${userTypeInput.value}' -> '${selectedUserType}'`);
                        userTypeInput.value = selectedUserType;
                    }
                    
                    // 사용자 유형에 따라 불필요한 필드 비우기
                    if (selectedUserType === 'USER') {
                        // 관리자와 상담사 필드 비우기
                        document.getElementById('companyName').value = '';
                        document.getElementById('invitationCode').value = '';
                        document.getElementById('companyId').value = '';
                    } else if (selectedUserType === 'ADMIN') {
                        // 일반 사용자와 상담사 필드 비우기
                        document.getElementById('ssn').value = '';
                        document.getElementById('invitationCode').value = '';
                        document.getElementById('companyId').value = '';
                    } else if (selectedUserType === 'AGENT') {
                        // 일반 사용자와 관리자 필드 비우기
                        document.getElementById('ssn').value = '';
                        document.getElementById('companyName').value = '';
                    }
                    
                    // 폼 제출 전 최종 검증 (모든 단계 검증)
                    if (!validateStep2()) {
                        console.error('단계 2 검증 실패로 제출이 중단되었습니다.');
                        // 단계 2로 돌아가서 오류 수정하도록 함
                        goToStep(2);
                        
                        // 첫 번째 오류 필드로 스크롤 및 포커스
                        const invalidField = document.querySelector('.is-invalid');
                        if (invalidField) {
                            setTimeout(() => {
                                invalidField.focus();
                                window.scrollTo({
                                    top: invalidField.offsetTop - 100,
                                    behavior: 'smooth'
                                });
                            }, 500); // 단계 전환 후 스크롤을 위한 약간의 지연
                        }
                        return;
                    }
                    
                    // 추가 검증
                    if (!validateBeforeSubmit()) {
                        console.error('최종 검증 실패로 제출이 중단되었습니다.');
                        return;
                    }
                    
                    // 모든 입력 필드 값 확인 (디버깅용)
                    const formData = new FormData(this);
                    for (let [key, value] of formData.entries()) {
                        if(key === 'password' || key === 'passwordConfirm') {
                            console.log(`${key}: ********`); // 비밀번호는 로그에 표시하지 않음
                        } else {
                            console.log(`${key}: ${value}`);
                        }
                    }
                    
                    console.log('폼 검증 완료, 제출 진행');
                    
                    // 검증이 성공적으로 완료되면 폼 제출
                    this.submit();
                });
            }
        });
    </script>
</body>
</html> 