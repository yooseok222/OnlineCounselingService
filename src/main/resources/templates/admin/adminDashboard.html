<div th:fragment="content">
  <main class="dashboard-content">
    <!-- 첫 번째 행: 계약서 상태와 월별 서명요청 현황 -->
    <div class="row">
      <!-- 계약서 상태 카드 -->
      <div class="col-md-6 mb-4">
        <div class="card h-100">

          <div class="card-header">
            <h3 class="card-title">계약서 상태</h3>
            <div>
              <input id ="contractTime" type="month"/>
              <button id ="contractStatusByMonthReset" class="btn btn-sm btn-outline-secondary ms-1">
                <i class="bi bi-arrow-repeat"></i>
              </button>
            </div>
          </div>

          <div class="card-body d-flex flex-column">
            <!-- 도넛 차트 영역 -->
            <div class="chart-container position-relative">
              <canvas id="contractStatusChart"></canvas>
<!--              <div class="no-data">표시할 데이터가 없습니다.</div>-->
            </div>

            <!-- 계약 현황 리스트 -->
            <div class="mt-3">
              <div class="fw-bold mb-2">나의 계약 현황</div>
              <ul class="status-list">
                <li class="status-item">
                  <div class="status-label">진행중 계약</div>
                  <div class="status-value">1</div>
                </li>
                <li class="status-item">
                  <div class="status-label">완료된 계약</div>
                  <div class="status-value">2</div>
                </li>
                <li class="status-item">
                  <div class="status-label">취소/거절된 계약</div>
                  <div class="status-value">3</div>
                </li>
                <li class="status-item">
                  <div class="status-label">대기중 계약</div>
                  <div class="status-value">4</div>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 월별 계약 완료 현황 카드 -->
      <div class="col-md-6 mb-4">
        <div class="card h-100">
          <div class="card-header">
            <h3 class="card-title">월별 계약 완료 현황</h3>
            <div>
              <input id ="contractStartMonth" type="month" readonly/>
              <span><strong>~</strong></span>
              <input id ="contractEndMonth" type="month"/>
              <button id="resetContractComplete" class="btn btn-sm btn-outline-secondary ms-1">
                <i class="bi bi-arrow-repeat"></i>
              </button>
            </div>
          </div>

          <div class="card-body">
            <!-- 바 차트 영역 -->
            <div class="chart-container">
              <canvas id="signRequestChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 두 번째 행: 이용 가이드와 주요기능 -->
    <div class="row">
      <!-- 주요기능 바로 시작하기 카드 -->
      <div class="col-md-12 mb-4">
        <div class="card h-100">
          <div class="card-header">
            <h3 class="card-title">관리자 기능 바로 시작하기</h3>
            <div>계약서 생성부터 편집까지, 클릭 몇 번으로 계약을 완료하세요.</div>
          </div>
          <div class="card-body p-0">
            <ul class="feature-list">
              <li class="feature-item">
                <a th:href="@{/admin/list}">
                  <div class="feature-title">상담원 관리</div>
                  <div class="feature-desc">상담원 별 개인정보 조회 및 수정 </div>
                </a>
              </li>
              <li class="feature-item">
                <a th:href="@{/admin/template-list}">
                  <div class="feature-title">계약서 관리</div>
                  <div class="feature-desc">계약서 정보 및 버전관리</div>
                </a>
              </li>
              <li class="feature-item">
                <a th:href="@{/admin/contract-list/canceled}">
                  <div class="feature-title">취소된 계약</div>
                  <div class="feature-desc">취소된 계약별 조건 검색 및 모니터링</div>
                </a>
              </li>
              <li class="feature-item">
                <a th:href="@{/admin/contract-list/pending}">
                  <div class="feature-title">대기중 계약</div>
                  <div class="feature-desc">대기중 계약별 조건 검색 및 모니터링</div>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 세 번째 행: 최근 완료된 계약과 진행중 계약 -->
    <div class="row">
      <!-- 최근 완료된 계약 카드 -->
      <div class="col-md-6 mb-4">
        <div class="card h-100">
          <div class="card-header">
            <h3 class="card-title">최근 완료된 계약</h3>
            <div>
              <button id ="recentCompletedReset" class="btn btn-sm btn-outline-secondary ms-1">
                <i class="bi bi-arrow-repeat"></i>
              </button>
            </div>
          </div>

          <div class="card-body">
            <ul id="recentCompletedContractList" class="list-group list-group-flush" >

<!--              <li class="list-group-item text-center text-muted py-4">완료된 계약이 없습니다.</li>-->
            </ul>
          </div>
        </div>
      </div>
      
      <!-- 진행중 계약 카드 -->
      <div class="col-md-6 mb-4">
        <div class="card h-100">
          <div class="card-header">
            <h3 class="card-title">진행 중인 계약</h3>
            <div>
              <button id ="inProgressContractReset" class="btn btn-sm btn-outline-secondary ms-1">
                <i class="bi bi-arrow-repeat"></i>
              </button>
            </div>
          </div>
          <div class="card-body">
            <ul id="inProgressContractList" class="list-group list-group-flush">
<!--              <li class="list-group-item text-center text-muted py-4">진행 중인 계약이 없습니다.</li>-->
            </ul>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 네 번째 행: SignSquare Blog -->
    <div class="row">
      <div class="col-12 mb-4">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Visang Blog</h3>
          </div>
          <div class="card-body">
            <h5 class="mb-2">AI 전자계약 서비스 Visang 공식 출시</h5>
            <p>AI·DX 전문기업 인스웨이브시스템즈(450520, 대표 어세룡)가 전자서명 원스톱 AI 서비스인 '싸인스퀘어(SignSquare)'를 공식 출시하고, 신규 가입자를 대상으로 무료 이용 프로모션을 진행한다고 25일 밝혔다.</p>
          </div>
        </div>
      </div>
    </div>
    
  </main>
</div>

<script th:fragment="script">
  document.addEventListener('DOMContentLoaded', () => {

    // 현재 년도과 월을 가져옵니다.
    const year = new Date().getFullYear();
    const month = new Date().getMonth() + 1; // 월은 0부터 시작하므로 +1

    let statusChart;
    let barChart;

    // 계약서 상태 차트
    const contractTime = document.getElementById("contractTime");
    const resetContractStatusByMonth = document.getElementById("contractStatusByMonthReset");

    // 월별 계약 완료 현황 차트
    const contractStartMonth = document.getElementById("contractStartMonth");
    const contractEndMonth = document.getElementById("contractEndMonth");
    const resetContractComplete = document.getElementById("resetContractComplete");

    // 최근 완료된 계약 리스트
    const recentCompletedContractList = document.getElementById("recentCompletedContractList");
    const recentCompletedReset = document.getElementById("recentCompletedReset");

    // 진행중 계약 리스트
    const inProgressContractList = document.getElementById("inProgressContractList");
    const inProgressContractReset = document.getElementById("inProgressContractReset");

    if (!contractTime.value) {
      contractTime.value = new Date().toISOString().slice(0, 7);
    }

    if (!contractEndMonth.value) {
      contractEndMonth.value = new Date().toISOString().slice(0, 7);
      contractStartMonth.value = new Date(new Date().setMonth(new Date().getMonth() - 4)).toISOString().slice(0, 7);
    }

    contractTime.addEventListener('change', (event) => {
      const selectedDate = new Date(event.target.value);
      const year = selectedDate.getFullYear();
      const month = selectedDate.getMonth() + 1; // 월은 0부터 시작하므로 +1
      fetchAndRenderStatus(year, month);
    });

    resetContractStatusByMonth.addEventListener('click', () => {
      // 데이터 다시 가져오기
      const year = contractTime.value.split('-')[0];
      const month = contractTime.value.split('-')[1];
      fetchAndRenderStatus(year, month);
    });

    contractEndMonth.addEventListener('change', (event) => {
      const selectedDate = new Date(event.target.value);
      const year = selectedDate.getFullYear();
      const month = selectedDate.getMonth() + 1; // 월은 0부터 시작하므로 +1

      contractStartMonth.value = new Date(selectedDate.getFullYear(), selectedDate.getMonth() - 3, 0).toISOString().slice(0, 7);
      fetchAndRenderMonthlyCompleted(year, month);
    });

    resetContractComplete.addEventListener('click', () => {
      // 데이터 다시 가져오기
      const year = contractEndMonth.value.split('-')[0];
      const month = contractEndMonth.value.split('-')[1];
      fetchAndRenderMonthlyCompleted(year, month);
    });

    recentCompletedReset.addEventListener('click', () => {
      // 데이터 다시 가져오기
      // fetchRecentCompletedContracts();
      fetchAndRenderRecentCompletedContracts();
    });

    inProgressContractReset.addEventListener('click', () => {
      // 데이터 다시 가져오기
      fetchInProgressContracts();
    });

    // 최근 완료된 계약 리스트 가져오기
    async function fetchAndRenderRecentCompletedContracts() {
      recentCompletedContractList.innerHTML = `
        <li class="list-group-item text-center py-3">
            <div class="spinner-border spinner-border-sm" role="status"></div>
        </li>
        `

      const res = await fetch('/admin/contract/recent-completed');
      const json = await res.json();
      // 3) 기존 내용 초기화
      recentCompletedContractList.innerHTML = '';

      if (json.length === 0) {
        recentCompletedContractList.innerHTML = '<li class="list-group-item text-center text-muted py-4">완료된 계약이 없습니다.</li>';
        return;
      }

      json.forEach((c, idx) => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
          <div>
            <div class="d-flex align-items-center mb-1">
              <span class="badge bg-secondary rounded-circle me-2" style="width:24px; height:24px; display:flex; align-items:center; justify-content:center;">
                ${idx + 1}
              </span>
              <small class="text-muted">${c.contractTime}</small>
            </div>
            <div class="mt-1">
              <span class="badge bg-primary rounded-pill me-1">
                <i class="bi bi-person-fill me-1"></i>${c.agentName}
              </span>
              <span><strong> <->  </strong></span>
              <span class="badge bg-info text-dark rounded-pill">
                <i class="bi bi-person-lines-fill me-1"></i>${c.clientName}
              </span>
            </div>
          </div>
          <span class="badge bg-success align-self-start">완료</span>
        `;
        recentCompletedContractList.appendChild(li);
      });
    }

    // 진행중 계약 리스트 가져오기
    async function fetchInProgressContracts() {
      inProgressContractList.innerHTML = `
    <li class="list-group-item text-center py-3">
      <div class="spinner-border spinner-border-sm" role="status"></div>
    </li>
  `;

      const res = await fetch('/admin/contract/in-progress');
      const json = await res.json();

      inProgressContractList.innerHTML = ''; // 기존 리스트 초기화

      if (json.length === 0) {
        inProgressContractList.innerHTML = '<li class="list-group-item text-center text-muted py-4">진행 중인 계약이 없습니다.</li>';
        return;
      }
        json.forEach((c, idx) => {
            const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `
              <div>
                <div class="d-flex align-items-center mb-1">
                  <span class="badge bg-secondary rounded-circle me-2" style="width:24px; height:24px; display:flex; align-items:center; justify-content:center;">
                    ${idx + 1}
                  </span>
                  <small class="text-muted">${c.contractTime}</small>
                </div>
                <div class="mt-1">
                  <span class="badge bg-primary rounded-pill me-1">
                    <i class="bi bi-person-fill me-1"></i>${c.agentName}
                  </span>
                  <span><strong> <->  </strong></span>
                  <span class="badge bg-info text-dark rounded-pill">
                    <i class="bi bi-person-lines-fill me-1"></i>${c.clientName}
                  </span>
                </div>
              </div>
              <span class="badge bg-success align-self-start">진행중</span>
              `;
            inProgressContractList.appendChild(li);
        });
    }

    async function fetchAndRenderMonthlyCompleted(year, month) {
      const res = await fetch(`/admin/contract/completed/month?year=${year||'2025'}&month=${month||'05'}`);
      const json = await res.json(); // { labels: [...], data: [...] }

      // 3) 레이블 확보 (백엔드에서 안 준다면 프론트에서 계산)
      const labels = json.labels || Array.from({ length: 5 }, (_, i) => {
        const d = new Date(+year, +month - 1 - (4 - i), 1);
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      });

      const data = [
        json.firstMonthCount,
        json.secondMonthCount,
        json.thirdMonthCount,
        json.fourthMonthCount,
        json.fifthMonthCount
      ];

      const canvas = document.getElementById('signRequestChart');

      const existingChart = Chart.getChart(canvas);
      if (existingChart) {
        existingChart.destroy();
      }
      const ctx = canvas.getContext('2d');

      barChart = new Chart(ctx, {
        type: 'bar',
        data: { labels:labels,
                datasets: [{ label: '완료 수', data: data }]
        },
        options: { scales: { y: { beginAtZero: true } } }
      });
    }


    function renderStatusChart(data) {
      const canvas = document.getElementById('contractStatusChart');

      const existingChart = Chart.getChart(canvas);
        if (existingChart) {
            existingChart.destroy();
        }

      const ctx = canvas.getContext('2d');

      statusChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['진행중', '완료', '취소/거절', '대기중'],
          datasets: [{
            data: data,
            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'],
            hoverOffset: 4
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              callbacks: {
                label: function(tooltipItem) {
                  return tooltipItem.label + ': ' + tooltipItem.raw;
                }
              }
            }
          }
        }
      });
    }

    // Ajax로 서버에서 가져오기
    async function fetchAndRenderStatus(year, month) {
      // default month=현재월
      const res = await fetch(`/admin/contract-status/month?year=${year||'2025'}&month=${month||'05'}`);
      const json = await res.json();
      const data = [
        json.inProgressCount,
        json.completedCount,
        json.canceledCount,
        json.pendingCount
      ];
      renderStatusChart(data);
      // 아래 “나의 계약 현황” 숫자도 업데이트
      document.querySelector('.status-item:nth-child(1) .status-value').textContent = json.inProgressCount;
      document.querySelector('.status-item:nth-child(2) .status-value').textContent = json.completedCount;
      document.querySelector('.status-item:nth-child(3) .status-value').textContent = json.canceledCount;
      document.querySelector('.status-item:nth-child(4) .status-value').textContent = json.pendingCount;
    }

    fetchAndRenderMonthlyCompleted(year, month);
    fetchAndRenderStatus(year, month);
    fetchAndRenderRecentCompletedContracts();
    fetchInProgressContracts();

  });

</script>
