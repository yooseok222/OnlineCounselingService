<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>도장 목록 - 온라인 상담 서비스</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .stamp-list-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
        }
        
        .stamp-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .stamp-card {
            border: 1px solid #dee2e6;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            background: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .stamp-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }
        
        .stamp-image {
            width: 120px;
            height: 120px;
            object-fit: contain;
            border: 2px solid #f8f9fa;
            border-radius: 10px;
            margin-bottom: 1rem;
            background: #f8f9fa;
        }
        
        .stamp-info {
            margin-top: 1rem;
        }
        
        .stamp-date {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        
        .stamp-actions {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .btn-action {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        
        .btn-use {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }
        
        .btn-use:hover {
            background-color: #218838;
            border-color: #1e7e34;
            color: white;
        }
        
        .btn-delete {
            background-color: #dc3545;
            border-color: #dc3545;
            color: white;
        }
        
        .btn-delete:hover {
            background-color: #c82333;
            border-color: #bd2130;
            color: white;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            color: #dee2e6;
        }
        
        .search-box {
            max-width: 400px;
            margin: 0 auto 2rem auto;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stats-number {
            font-size: 2rem;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="stamp-list-container">
            <!-- 페이지 헤더 -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-images me-2"></i>내 도장 목록</h2>
                <div>
                    <a href="/stamp/upload" class="btn btn-primary me-2">
                        <i class="fas fa-plus me-1"></i>새 도장 업로드
                    </a>
                    <a href="/contract/clientRoom" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>상담방으로
                    </a>
                </div>
            </div>

            <!-- 통계 카드 -->
            <div class="stats-card">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="mb-1">도장 관리</h5>
                        <p class="mb-0">업로드된 도장을 관리하고 상담에서 사용하세요</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="stats-number" th:text="${#lists.size(stamps)}">0</div>
                        <small>개의 도장</small>
                    </div>
                </div>
            </div>

            <!-- 검색 박스 -->
            <div class="search-box" th:if="${!#lists.isEmpty(stamps)}">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="searchInput" placeholder="도장 검색...">
                </div>
            </div>

            <!-- 도장 목록 -->
            <div th:if="${#lists.isEmpty(stamps)}" class="empty-state">
                <i class="fas fa-stamp"></i>
                <h4>업로드된 도장이 없습니다</h4>
                <p>새로운 도장을 업로드하여 상담에서 사용해보세요.</p>
                <a href="/stamp/upload" class="btn btn-primary btn-lg mt-3">
                    <i class="fas fa-plus me-2"></i>첫 번째 도장 업로드하기
                </a>
            </div>
            
            <div th:if="${!#lists.isEmpty(stamps)}" class="stamp-grid" id="stampGrid">
                <div th:each="stamp : ${stamps}" class="stamp-card" data-stamp-id="${stamp.stampId}">
                    <img th:src="@{'/stamp/image/' + ${stamp.imagePath}}" 
                         class="stamp-image" 
                         th:alt="'도장 ' + ${stamp.stampId}"
                         loading="lazy">
                    
                    <div class="stamp-info">
                        <div class="stamp-date">
                            <i class="fas fa-calendar-alt me-1"></i>
                            <span th:text="${#dates.format(stamp.createdAt, 'yyyy년 MM월 dd일')}"></span>
                        </div>
                        
                        <div class="stamp-actions">
                            <button class="btn btn-use btn-action" 
                                    th:onclick="'useStamp(' + ${stamp.stampId} + ', \'' + ${stamp.imagePath} + '\')'">
                                <i class="fas fa-check me-1"></i>사용
                            </button>
                            <button class="btn btn-delete btn-action" 
                                    th:onclick="'deleteStamp(' + ${stamp.stampId} + ')'">
                                <i class="fas fa-trash me-1"></i>삭제
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 도장 사용 확인 모달 -->
    <div class="modal fade" id="useStampModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">도장 사용</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalStampImage" class="mb-3" style="width: 100px; height: 100px; object-fit: contain;">
                    <p>이 도장을 상담방에서 사용하시겠습니까?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" id="confirmUseStamp">사용하기</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedStampId = null;
        let selectedStampPath = null;

        // 검색 기능
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const stampCards = document.querySelectorAll('.stamp-card');
                
                stampCards.forEach(card => {
                    const stampId = card.dataset.stampId;
                    const isVisible = stampId.includes(searchTerm);
                    card.style.display = isVisible ? 'block' : 'none';
                });
            });
        }

        // 도장 사용
        function useStamp(stampId, imagePath) {
            selectedStampId = stampId;
            selectedStampPath = imagePath;
            
            // 모달에 이미지 표시
            const modalImage = document.getElementById('modalStampImage');
            modalImage.src = `/stamp/image/${imagePath}`;
            
            // 모달 표시
            const modal = new bootstrap.Modal(document.getElementById('useStampModal'));
            modal.show();
        }

        // 도장 사용 확인
        document.getElementById('confirmUseStamp').addEventListener('click', function() {
            if (selectedStampId && selectedStampPath) {
                // 상담방으로 도장 정보 전달 (localStorage 사용)
                localStorage.setItem('selectedStamp', JSON.stringify({
                    stampId: selectedStampId,
                    imagePath: selectedStampPath
                }));
                
                // 상담방으로 이동
                window.location.href = '/contract/clientRoom';
            }
        });

        // 도장 삭제
        function deleteStamp(stampId) {
            if (!confirm('정말로 이 도장을 삭제하시겠습니까?\n삭제된 도장은 복구할 수 없습니다.')) {
                return;
            }

            // 삭제 버튼 비활성화
            const deleteBtn = event.target.closest('button');
            const originalText = deleteBtn.innerHTML;
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>삭제 중...';
            deleteBtn.disabled = true;

            fetch(`/stamp/api/${stampId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 성공 시 카드 애니메이션과 함께 제거
                    const stampCard = document.querySelector(`[data-stamp-id="${stampId}"]`);
                    stampCard.style.transform = 'scale(0)';
                    stampCard.style.opacity = '0';
                    
                    setTimeout(() => {
                        stampCard.remove();
                        
                        // 도장이 모두 삭제되었으면 페이지 새로고침
                        const remainingCards = document.querySelectorAll('.stamp-card');
                        if (remainingCards.length === 0) {
                            location.reload();
                        }
                    }, 300);
                    
                    // 성공 메시지 표시
                    showToast('성공', data.message, 'success');
                } else {
                    // 실패 시 버튼 복원
                    deleteBtn.innerHTML = originalText;
                    deleteBtn.disabled = false;
                    showToast('오류', data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                deleteBtn.innerHTML = originalText;
                deleteBtn.disabled = false;
                showToast('오류', '삭제 중 오류가 발생했습니다.', 'error');
            });
        }

        // 토스트 메시지 표시 함수
        function showToast(title, message, type) {
            // 간단한 알림 (실제로는 더 예쁜 토스트 라이브러리 사용 권장)
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            
            const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;" role="alert">
                    <i class="fas ${icon} me-2"></i>
                    <strong>${title}:</strong> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', alertHtml);
            
            // 3초 후 자동 제거
            setTimeout(() => {
                const alert = document.querySelector('.alert');
                if (alert) {
                    alert.remove();
                }
            }, 3000);
        }

        // 페이지 로드 시 애니메이션
        document.addEventListener('DOMContentLoaded', function() {
            const stampCards = document.querySelectorAll('.stamp-card');
            stampCards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                
                setTimeout(() => {
                    card.style.transition = 'all 0.5s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 100);
            });
        });
    </script>
</body>
</html> 