<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>비대면 상담 채팅</title>
    <!-- SockJS & STOMP.js -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 1rem; }
        #chatArea {
          width: 100%; max-width: 600px;
          height: 300px; border: 1px solid #ccc;
          overflow-y: auto; padding: 0.5rem; margin-bottom: 0.5rem;
        }
        .message { margin: 4px 0; }
        .sender { font-weight: bold; }
        .content { margin-left: 8px; }
        #msgInput { width: calc(100% - 150px); padding: 0.5rem; }
        #sendBtn, #endBtn { padding: 0.5rem 1rem; margin-left: 4px; }
        #exportLink { margin-left: 8px; color: blue; text-decoration: underline; cursor: pointer; display: none; }
    </style>
</head>
<body>
<h2>상담 채팅 (방 #<span id="roomLabel"></span>)</h2>
<div id="chatArea"></div>
<input type="text" id="msgInput" placeholder="메시지를 입력하세요" autocomplete="off"/>
<button id="sendBtn">전송</button>
<button id="endBtn">종료</button>
<a id="exportLink" download>상담 내역 다운로드</a>

<script>
    const params = new URLSearchParams(window.location.search);
    const roomId = parseInt(params.get('room')) || 1234;
    document.getElementById('roomLabel').textContent = roomId;

    const socket = new SockJS('/ws');
    const stompClient = Stomp.over(socket);

    stompClient.connect({}, () => {
      console.log('STOMP 연결 성공');

      stompClient.subscribe(`/topic/chat/${roomId}`, frame => {
        console.log('▶ 구독 콜백 진입, raw frame:', frame);
        const msg = JSON.parse(frame.body);
        console.log('▶ 파싱된 메시지:', msg);
        showMessage(msg);
         if (msg.type === 'END') {
         console.log('[DEBUG] END detected, calling handleExport()');
         handleExport();
        }
      });

      stompClient.send(
        '/app/chat.addUser', {},
        JSON.stringify({ roomId, content: '님이 입장했습니다.', type: 'JOIN' })
      );
      console.log('▶ 입장 알림 전송');
    });

    document.getElementById('sendBtn').addEventListener('click', () => {
      const input = document.getElementById('msgInput');
      const text = input.value.trim();
      if (!text) return;
      stompClient.send('/app/chat.sendMessage', {}, JSON.stringify({ roomId, content: text, type: 'CHAT' }));
      input.value = '';
    });

    document.getElementById('msgInput').addEventListener('keydown', e => {
      if (e.key === 'Enter') document.getElementById('sendBtn').click();
    });

    document.getElementById('endBtn').addEventListener('click', () => {
      console.log('[DEBUG] endBtn clicked');

      stompClient.send('/app/chat.endCall', {}, JSON.stringify({ roomId }));
      document.getElementById('msgInput').disabled = true;
      document.getElementById('sendBtn').disabled = true;
      document.getElementById('endBtn').disabled = true;
    });

    function handleExport() {
        console.log('[DEBUG] handleExport() 호출');

          const xsrfCookie = document.cookie
            .split('; ')
            .find(row => row.startsWith('XSRF-TOKEN='));
          const xsrfToken = xsrfCookie && xsrfCookie.split('=')[1];

          fetch(`/api/chat/export/${roomId}`, {
            method: 'GET',
            credentials: 'same-origin',    // 쿠키 전송을 위해 필요
            headers: {
              'X-XSRF-TOKEN': xsrfToken
            }
          })
          .then(res => {
            if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
            return res.blob();
          })
          .then(blob => {
            const url = URL.createObjectURL(blob);
            const link = document.getElementById('exportLink');
            link.href = url;
            link.download = `chat_${roomId}.txt`;
            link.style.display = 'inline';
            link.textContent = '상담 내역 다운로드';
          })
          .catch(err => {
            console.error('파일 다운로드 실패:', err);
          });
        }

    function showMessage(msg) {
      console.log('▶ showMessage 호출, msg =', msg);
      const area = document.getElementById('chatArea');
      console.log('▶ chatArea element =', area);
      const div = document.createElement('div');
      div.classList.add('message');

      if (msg.type === 'JOIN' || msg.type === 'END') {
        div.innerHTML = `<em>${msg.sender} ${msg.content}</em>`;
      } else {
        const time = new Date(msg.sendTime).toLocaleTimeString();
        div.innerHTML = `<span class="sender">[${time}] ${msg.sender}:</span><span class="content"> ${msg.content}</span>`;
      }

      area.appendChild(div);
      area.scrollTop = area.scrollHeight;
    }
</script>
</body>
</html>
